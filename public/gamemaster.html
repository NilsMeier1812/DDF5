<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Control</title>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --sidebar-bg: #ffffff;
            --header-bg: #111827;
            --primary: #2563eb;
            --warning: #f59e0b;
            --danger: #dc2626;
            --success: #16a34a;
            --purple: #7c3aed;
            --border: #e5e7eb;
            --text: #1f2937;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 0; background: var(--bg-color); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        * { box-sizing: border-box; }

        /* --- LOGIN --- */
        #login-overlay { position: fixed; inset: 0; background: var(--header-bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); text-align: center; width: 350px; }
        .login-box h2 { margin-top: 0; color: var(--header-bg); }
        .login-box input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 20px; font-size: 1.1rem; text-align: center;}
        .login-error { color: var(--danger); font-weight: bold; margin-top: 15px; display: none; }

        #main-ui { display: none; width: 100%; height: 100%; }

        /* --- SIDEBAR --- */
        .sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: relative; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .sidebar-header { padding: 20px; background: var(--header-bg); color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; }
        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border); background: #f9fafb; }
        
        .player-row { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: background 0.1s; }
        .player-row:hover { background: #f3f4f6; }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-name { font-weight: 600; font-size: 0.95rem; }
        .player-code { font-size: 0.75rem; color: #6b7280; background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-family: monospace;}
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #d1d5db; box-shadow: inset 0 1px 2px rgba(0,0,0,0.2); }
        .status-dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); }
        
        .player-row.eliminated { background: #fef2f2; opacity: 0.8; }
        .player-row.eliminated .player-name { text-decoration: line-through; color: var(--danger); }
        
        .lives-control { display: flex; align-items: center; gap: 5px; background: white; border: 1px solid var(--border); border-radius: 20px; padding: 2px 8px; }
        .lives-control button { background: none; border: none; cursor: pointer; color: #6b7280; font-weight: bold; padding: 0 5px; font-size: 1.1rem; }
        .lives-control button:hover { color: var(--text); }

        .pending-header { background: var(--warning); color: white; font-size: 0.75rem; font-weight: bold; padding: 8px 20px; text-transform: uppercase; letter-spacing: 1px; }
        .pending-row { background: #fffbeb; padding: 15px 20px; border-bottom: 1px solid #fcd34d; display: flex; justify-content: space-between; align-items: center; }

        /* --- MAIN CONTENT --- */
        .content { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; background: #f9fafb; }
        .top-bar { display: flex; justify-content: space-between; margin-bottom: 30px; align-items: center; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .top-bar h1 { margin: 0; font-size: 1.5rem; color: var(--header-bg); }
        .control-group { display: flex; gap: 10px; }

        /* BUTTONS */
        button { cursor: pointer; transition: filter 0.2s, transform 0.1s; font-family: inherit; }
        button:active { transform: scale(0.98); }
        .btn-new-q { background: var(--primary); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4); }
        
        /* Status Buttons */
        .btn-close-vote { background: var(--warning); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 8px;}
        .btn-reopen-vote { background: var(--success); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 8px;}
        
        .btn-block-toggle { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 8px; background: #6b7280; color:white; }
        .btn-block-toggle.blocked { background: var(--danger); }
        .btn-block-toggle.open { background: var(--success); }

        .btn-reveal { background: var(--purple); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; }
        .btn-finish-round { background: var(--header-bg); color: white; padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        
        .btn-danger-all { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .btn-mini { background: white; border: 1px solid #d1d5db; padding: 8px; border-radius: 6px; width: 100%; font-weight: 600; color: #374151; }
        .btn-mini:hover { background: #f3f4f6; }

        /* ACTIVE QUESTION CARD */
        .current-question { background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; border-left: 6px solid var(--primary); display: flex; justify-content: space-between; align-items: flex-start; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .q-meta { color: #6b7280; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; margin-bottom: 10px; }
        #q-text { font-size: 1.8rem; font-weight: 700; color: #111; line-height: 1.3; margin:0;}
        .q-text-hidden { opacity: 0.3; filter: blur(4px); }
        
        .stats-col { display: flex; flex-direction: column; gap: 10px; min-width: 140px; }
        .counter-box { text-align: center; background: #eff6ff; padding: 15px; border-radius: 12px; color: var(--primary); }
        .counter-num { font-size: 2rem; font-weight: 800; display: block; line-height: 1; }
        .counter-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        .timer-box { text-align: center; background: #111827; padding: 10px; border-radius: 12px; color: #22c55e; font-family: monospace; font-size: 1.5rem; letter-spacing: 2px; border: 2px solid #374151; }

        /* ANSWERS GRID */
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .answer-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; position: relative; overflow: hidden; display: flex; flex-direction: column; transition: all 0.3s ease; }
        .answer-card strong { display: block; color: #6b7280; font-size: 0.85rem; margin-bottom: 8px; text-transform: uppercase; }
        .answer-val { font-size: 1.2rem; font-weight: 600; color: #111; white-space: pre-wrap; line-height: 1.4; flex: 1;}
        .diff-badge { background: #fee2e2; color: #b91c1c; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 8px; border: 1px solid #fecaca; }
        
        /* REVEALED STYLE */
        .answer-revealed { 
            border: 2px solid #22c55e; 
            background: #f0fdf4; 
            order: -1; 
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.2);
        } 

        /* Reveal Button Styling */
        .btn-reveal-single { 
            position: absolute; top: 10px; right: 10px; 
            background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        .btn-reveal-single:hover { background: #d1d5db; transform: scale(1.1); }
        
        /* Checked / Done State */
        .btn-reveal-single.checked {
            background: #22c55e;
            color: white;
            cursor: default;
        }

        /* TOASTS */
        #notification-area { position: fixed; bottom: 20px; right: 20px; width: 320px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: var(--header-bg); color: white; padding: 15px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); animation: slideIn 0.3s; pointer-events: all; border-left: 4px solid var(--success); display: flex; justify-content: space-between; align-items: center;}
        .toast-code { font-family: monospace; font-size: 1.2rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; color: var(--success); font-weight: bold; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* MODAL */
        dialog { border: none; border-radius: 16px; padding: 0; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); width: 700px; max-width: 95%; background: white; }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-header { background: #f9fafb; padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header strong { font-size: 1.2rem; }
        .modal-body { padding: 30px; display: flex; flex-direction: column; gap: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f9fafb; }
        
        /* Form Elements inside Modal */
        label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: #374151; }
        input[type="text"], input[type="number"], select { padding: 12px; width: 100%; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; transition: border 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); ring: 2px solid var(--primary); }
        
        .media-box { background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #bae6fd; }
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .btn-add-opt { background: #e5e7eb; border: none; padding: 8px 15px; cursor: pointer; width: 100%; border-radius: 6px; font-weight: 600; color: #4b5563; }
        .btn-add-opt:hover { background: #d1d5db; }
        
        .correct-answer-section { border-top: 2px dashed #e5e7eb; padding-top: 20px; margin-top: 10px; }
        .correct-label { color: var(--success); }
        
        .btn-cancel { padding: 10px 20px; cursor: pointer; border: 1px solid #d1d5db; background: white; border-radius: 6px; font-weight: 600; color: #374151;}
        .btn-start { background: var(--success); color: white; border: none; padding: 10px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.4);}
        .btn-reset-round { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* Stechen Grid */
        .player-check-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; margin-top: 10px; }
        .p-check-label { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; cursor: pointer; background: white; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; user-select: none; }
        .p-check-label:hover { background: #f9fafb; }
        
        /* Offline Inputs */
        .offline-input-row { display: flex; align-items: center; margin-bottom: 10px; background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; }
        .offline-input-row label { width: 150px; font-weight: bold; }

        .gm-img-controls { margin-top: 10px; display: flex; gap: 10px; }
        .btn-toggle { background: #4b5563; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        .btn-toggle.visible { background: #16a34a; }
        .btn-toggle.hidden { background: #dc2626; }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>üîí GM Access</h2>
            <input type="password" id="gm-password" placeholder="Passwort eingeben" onkeyup="if(event.key === 'Enter') login()">
            <button class="btn-new-q" onclick="login()" style="width:100%;">Login</button>
            <p id="login-msg" class="login-error">Passwort falsch!</p>
        </div>
    </div>
    
    <div id="notification-area"></div>
    
    <div id="main-ui">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span>SPIELER</span>
                <button class="btn-danger-all" onclick="resetAll()">Reset All</button>
            </div>
            <div id="sidebar-list" class="sidebar-content"></div>
            <div class="sidebar-footer">
                <button class="btn-mini" onclick="manualAddPlayer()">+ Manueller Spieler (Code)</button>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="content">
            <div class="top-bar">
                <div style="display:flex; flex-direction:column;">
                    <h1 style="margin:0;">Control Center</h1>
                    <span id="game-id-display" style="font-size:0.85rem; color:#9ca3af;"></span>
                    <span id="round-counter-display" style="color:var(--primary); font-weight:bold; font-size:0.9rem; margin-top:2px;">Runde 1</span>
                </div>
                <div class="control-group">
                    <button id="btn-block-toggle" class="btn-block-toggle" onclick="toggleInputBlock()" style="display:none;">
                        ‚å®Ô∏è Eingabe: ???
                    </button>
                    <button id="btn-reveal" class="btn-reveal" onclick="reveal()">üëÅÔ∏è Aufl√∂sen</button>
                    <button id="btn-toggle-vote" class="btn-close-vote" onclick="toggleVote()">üîí Voting Schlie√üen</button>
                    <div style="width: 1px; background: #e5e7eb; margin: 0 10px;"></div>
                    <button class="btn-finish-round" onclick="finishRoundPhase()">
                        üèÅ Runde beenden
                    </button>
                    <!-- NEUER NAME -->
                    <button class="btn-new-q" onclick="openModal()">+ Erstellen</button>
                </div>
            </div>

            <div class="current-question">
                <div style="flex:1;">
                    <div id="q-type" class="q-meta">WAITING</div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <h2 id="q-text">Warte auf Start...</h2>
                        <button id="btn-text-toggle" class="btn-toggle visible" onclick="toggleText()" style="padding:4px 8px; font-size:0.8rem; height:fit-content; display:none;">
                            <span>T</span>
                        </button>
                    </div>
                    
                    <div id="gm-image-wrapper" style="margin-top:20px; display:none;">
                        <img id="gm-image-display" src="" style="max-height:250px; border-radius:8px; border:1px solid #e5e7eb;">
                        <div class="gm-img-controls">
                            <button id="btn-img-toggle" class="btn-toggle" onclick="toggleImage()">
                                <span>üëÅÔ∏è</span> <span id="img-toggle-text">Bild zeigen</span>
                            </button>
                        </div>
                    </div>
                    <div id="gm-audio-wrapper" style="margin-top:15px; display:none; background:#f3f4f6; padding:10px; border-radius:8px;"><audio id="gm-audio-player" controls style="width:100%;"></audio></div>
                    <div id="gm-video-wrapper" style="margin-top:20px; display:none; background:#000; color:#fff; padding:10px; border-radius:8px; text-align:center;">‚ñ∂Ô∏è YouTube Stream Aktiv (ID: <span id="gm-video-id"></span>)</div>
                </div>
                <div class="stats-col">
                    <div class="timer-box" id="timer-display">00:00</div>
                    <div class="counter-box">
                        <span class="counter-num" id="answer-count">0</span>
                        <span class="counter-label">Antworten</span>
                    </div>
                </div>
            </div>

            <div class="answers-grid" id="answers-area"></div>
            
            <div id="offline-input-area" style="display:none; background: #fff7ed; padding:25px; border-radius:12px; margin-top:30px; border:1px solid #ffedd5;">
                <h3 style="color:#9a3412; margin-top:0;">üìù Ergebnisse eintragen</h3>
                <div id="offline-player-inputs"></div>
                <button class="btn-new-q" onclick="saveOfflineResults()" style="background:#ea580c; margin-top:15px;">Ergebnisse Speichern</button>
            </div>
        </div>
    </div>

    <!-- DIALOG MODAL -->
    <dialog id="q-modal">
        <div class="modal-header">
            <strong>Neue Frage konfigurieren</strong>
            <button onclick="closeModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#6b7280;">&times;</button>
        </div>
        <div class="modal-body">
            <div>
                <label>Modus</label>
                <select id="m-type" onchange="updateModalFields()">
                    <!-- NEUE GRUPPIERUNG & SORTIERUNG -->
                    <optgroup label="Interaktiv / Fragen">
                        <option value="TEXT">Textantwort</option>
                        <option value="SEQUENCE">Reihenfolge (Sortieren)</option>
                        <option value="LIST">Aufz√§hlen (Liste)</option>
                        <option value="ESTIMATE">Sch√§tzen (Zahl)</option>
                        <option value="MC">Multiple Choice</option>
                        <option value="MATCHING">Zuordnen (Paare)</option>
                    </optgroup>
                    <optgroup label="Content / Passive">
                        <option value="INFO">Info / Text anzeigen</option> <!-- NEU -->
                        <option value="VIDEO_STREAM">üî¥Video Stream (YouTube)</option>
                        <option value="OFFLINE_RESULTS">Offline Ergebnisse</option>
                    </optgroup>
                    <optgroup label="Voting / Elimination">
                        <option value="PLAYER_VOTE">‚ù§Ô∏èVoting (Leben abziehen)</option>
                    </optgroup>
                </select>
            </div>
            
            <div>
                <label>Fragetext / Titel</label>
                <input type="text" id="m-question" placeholder="Was ist die Hauptstadt von...">
            </div>

            <!-- YouTube Box -->
            <div id="yt-config-box" style="display:none; background:#ff000010; padding:15px; border-radius:8px; border:1px solid #ff000030;">
                <label style="color:red;">üî¥ YouTube Link</label>
                <input type="text" id="m-yt-link" placeholder="https://www.youtube.com/watch?v=...">
                <small style="color:#666;">Unterst√ºtzt normale Links und Share-Links. Wird bei den Spielern automatisch eingebettet.</small>
            </div>

            <div class="media-box">
                <label>üéß Audio</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="m-audio-url" placeholder="URL (z.B. .mp3)" style="flex:1;">
                    <input type="file" id="m-audio-file" accept="audio/*" style="font-size:0.8rem; width:200px;">
                </div>
                <hr style="border:0; border-top:1px solid #bae6fd; margin:15px 0;">
                <label>üñºÔ∏è Bild</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="m-image-url" placeholder="URL (z.B. .jpg)" style="flex:1;">
                    <input type="file" id="m-image-file" accept="image/*" style="font-size:0.8rem; width:200px;">
                </div>
                <div style="margin-top:5px; font-size:0.8rem; color:#6b7280;">Bild max 2MB. Standardm√§√üig verborgen.</div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn-mini" style="width:auto;" onclick="toggleStechen()">‚öîÔ∏è Stechen</button>
                <button class="btn-mini" style="width:auto;" onclick="togglePowerVoter()">‚ö° Doppelte Stimme</button>
            </div>

            <div id="stechen-area" style="display:none; background:#f9fafb; padding:15px; border-radius:8px; border:1px solid #e5e7eb;">
                <small style="font-weight:bold; color:#6b7280;">Wer soll die Frage bekommen? (Leer = Alle)</small>
                <div class="player-check-grid" id="stechen-list"></div>
            </div>

            <div id="powervoter-wrapper" style="display:none;">
                <div id="powervoter-area" style="background:#f9fafb; padding:15px; border-radius:8px; border:1px solid #e5e7eb; margin-top:10px;">
                    <small style="font-weight:bold; color:#6b7280;">Wer hat doppelte Stimmkraft?</small>
                    <div class="player-check-grid" id="powervoter-list"></div>
                </div>
            </div>

            <div id="dynamic-area"></div>
            
            <div id="solution-area" class="correct-answer-section" style="display:none;">
                <label class="correct-label">üí° Musterl√∂sung (F√ºr Anzeige):</label>
                <input type="text" id="m-correct-text" placeholder="Richtige Antwort eingeben...">
            </div>
        </div>
        <div class="modal-footer">
            <div style="display:flex; gap:10px;">
                <button class="btn-cancel" onclick="closeModal()">Abbrechen</button>
                <button class="btn-start" onclick="startQuestion()">Frage Starten</button>
            </div>
        </div>
    </dialog>

    <!-- LOGIC SCRIPT -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentPlayers = {}; 
        let isAnsweringOpen = false;
        let isInputBlocked = false; // Neuer Status
        let isImageRevealed = false; 
        let isTextRevealed = true; 
        
        // Timer Globals
        let timerInterval = null;
        let roundStartTime = null;
        let roundEndTime = null;

        function login() { const pw = document.getElementById('gm-password').value; socket.emit('gm_login', pw); }
        socket.on('gm_login_success', () => { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('main-ui').style.display = 'flex'; });
        socket.on('gm_login_fail', () => { document.getElementById('login-msg').style.display = 'block'; });
        socket.on('gm_player_joined', (data) => { const container = document.getElementById('notification-area'); const toast = document.createElement('div'); toast.className = 'toast'; toast.innerHTML = `<div><strong>${data.name}</strong><small style="display:block; opacity:0.8;">${data.isManual?'Manuell':'Beitritt'}</small></div><div class="toast-code">${data.code}</div>`; container.appendChild(toast); setTimeout(() => toast.remove(), 10000); });
        function manualAddPlayer() { const name = prompt("Name:"); if(name) socket.emit('gm_create_player', name); }
        function finishRoundPhase() { if(confirm("üèÅ Runde wirklich beenden?\n\n- Archiviert alle Fragen der aktuellen Phase\n- Leert die History\n- Startet 'Runde X+1'")) socket.emit('gm_next_round_phase'); }
        const gmAudio = document.getElementById('gm-audio-player');
        const gmAudioWrapper = document.getElementById('gm-audio-wrapper');
        const gmImageWrapper = document.getElementById('gm-image-wrapper');
        const gmImage = document.getElementById('gm-image-display');
        const gmVideoWrapper = document.getElementById('gm-video-wrapper');
        
        gmAudio.onplay = () => socket.emit('gm_audio_sync', { action: 'play', currentTime: gmAudio.currentTime });
        gmAudio.onpause = () => socket.emit('gm_audio_sync', { action: 'pause', currentTime: gmAudio.currentTime });
        gmAudio.onseeked = () => { if(gmAudio.paused) socket.emit('gm_audio_sync', { action: 'seek', currentTime: gmAudio.currentTime }); };
        const modal = document.getElementById('q-modal');
        function openModal() { updateModalFields(); generateStechenList(); generatePowerVoterList(); document.getElementById('stechen-area').style.display = 'none'; document.getElementById('powervoter-area').style.display = 'none'; modal.showModal(); }
        function closeModal() { modal.close(); }
        function toggleStechen() { const a=document.getElementById('stechen-area'); a.style.display = a.style.display==='none'?'block':'none'; }
        function togglePowerVoter() { const a=document.getElementById('powervoter-area'); a.style.display = a.style.display==='none'?'block':'none'; }
        function generateStechenList() { const c = document.getElementById('stechen-list'); c.innerHTML = ''; for (const [name, p] of Object.entries(currentPlayers)) { if(!p.isVerified) continue; c.innerHTML += `<label class="p-check-label"><input type="checkbox" value="${name}" class="stechen-check" checked> ${name}</label>`; } }
        function generatePowerVoterList() { const c = document.getElementById('powervoter-list'); c.innerHTML = ''; for (const [name, p] of Object.entries(currentPlayers)) { if(!p.isVerified) continue; c.innerHTML += `<label class="p-check-label"><input type="checkbox" value="${name}" class="powervoter-check"> ${name}</label>`; } }
        
        function toggleImage() { socket.emit('gm_toggle_image', !isImageRevealed); }
        function toggleText() { socket.emit('gm_toggle_text', !isTextRevealed); } 
        // NEU: Input Toggle
        function toggleInputBlock() { socket.emit('gm_toggle_input_block', !isInputBlocked); }

        function revealSingle(name) { socket.emit('gm_reveal_single', name); } 

        function updateModalFields() {
            const type = document.getElementById('m-type').value;
            const container = document.getElementById('dynamic-area');
            const solArea = document.getElementById('solution-area');
            const pvWrapper = document.getElementById('powervoter-wrapper');
            const ytBox = document.getElementById('yt-config-box');
            
            container.innerHTML = ''; solArea.style.display = 'none'; pvWrapper.style.display = 'none'; ytBox.style.display = 'none';
            
            if (type === 'MC') {
                container.innerHTML = `<span class="section-label">Antworten:</span><div id="mc-inputs"></div><button class="btn-add-opt" onclick="addMCRow()">+ Option</button>`; addMCRow(); addMCRow(); addMCRow(); addMCRow();
            } else if (type === 'LIST') {
                container.innerHTML = `<span class="section-label">Konfiguration:</span><div class="dynamic-row"><label style="width:auto; margin-right:10px;">Anzahl Antworten:</label><input type="number" id="list-count" value="5" min="1" max="20" style="width:80px;"></div>`;
                solArea.style.display = 'block'; document.getElementById('m-correct-text').placeholder = "Musterl√∂sungen (Optional)";
            } else if (type === 'SEQUENCE') {
                container.innerHTML = `<span class="section-label">Reihenfolge:</span><div id="seq-inputs"></div><button class="btn-add-opt" onclick="addInputRow('seq-inputs', 'Element...')">+ Element</button>`; addInputRow('seq-inputs', 'Element...'); addInputRow('seq-inputs', 'Element...');
            } else if (type === 'ESTIMATE' || type === 'TEXT') {
                if(type === 'ESTIMATE') container.innerHTML = `<span class="section-label">Bereich:</span><div class="dynamic-row"><input type="number" id="est-min" placeholder="Min"><input type="number" id="est-max" placeholder="Max"></div>`;
                solArea.style.display = 'block'; document.getElementById('m-correct-text').placeholder = type==='ESTIMATE' ? "Exakte Zahl (L√∂sung)" : "Musterl√∂sung (Text)";
            } else if (type === 'MATCHING') {
                container.innerHTML = `<span class="section-label">Paare:</span><div id="match-inputs"></div><button class="btn-add-opt" onclick="addMatchPair()">+ Paar</button>`; addMatchPair(); addMatchPair();
            } else if (type === 'PLAYER_VOTE') {
                pvWrapper.style.display = 'block';
            } else if (type === 'VIDEO_STREAM') {
                ytBox.style.display = 'block';
                container.innerHTML = `<div style="padding:15px; background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; border-radius:6px; margin-top:10px;">‚ÑπÔ∏è Spieler sehen den Stream. Antwortm√∂glichkeiten sind deaktiviert.</div>`;
            } else if (type === 'OFFLINE_RESULTS') {
                container.innerHTML = `<div style="padding:15px; background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; border-radius:6px; margin-top:10px;">‚ÑπÔ∏è Spieler sehen "Warte auf Ergebnisse". Du kannst die Punkte gleich direkt in der Hauptansicht eintragen.</div>`;
            } else if (type === 'INFO') {
                container.innerHTML = `<div style="padding:15px; background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; border-radius:6px; margin-top:10px;">‚ÑπÔ∏è Spieler sehen nur den Text (z.B. Regeln, Story). Keine Interaktion.</div>`;
                document.getElementById('m-question').placeholder = "Nachricht an Spieler...";
            }
        }
        function addMCRow() { const div = document.createElement('div'); div.className = 'dynamic-row'; div.innerHTML = `<input type="text" class="dyn-inp mc-text" placeholder="Antwort..."><input type="radio" name="mc_correct" class="radio-correct" title="Ist richtige Antwort" style="width:25px; height:25px; accent-color:#16a34a;">`; document.getElementById('mc-inputs').appendChild(div); }
        function addInputRow(parentId, placeholder) { const div = document.createElement('div'); div.className = 'dynamic-row'; div.innerHTML = `<input type="text" class="dyn-inp" placeholder="${placeholder}">`; document.getElementById(parentId).appendChild(div); }
        function addMatchPair() { const div = document.createElement('div'); div.className = 'dynamic-row'; div.innerHTML = `<input type="text" class="match-l" placeholder="L"><input type="text" class="match-r" placeholder="R">`; document.getElementById('match-inputs').appendChild(div); }
        
        async function startQuestion() {
            const type = document.getElementById('m-type').value;
            const text = document.getElementById('m-question').value;
            let qText = text;
            let options = []; let pairs = []; let min = 0; let max = 100; let answerCount = 1; let targetPlayers = []; let correctAnswer = null; let audioData = null; let imageData = null; let videoData = null; let powerVoter = [];
            
            const audioUrl = document.getElementById('m-audio-url').value.trim(); const audioFile = document.getElementById('m-audio-file').files[0];
            const imageUrl = document.getElementById('m-image-url').value.trim(); const imageFile = document.getElementById('m-image-file').files[0];
            
            // --- UPDATE: Limit erh√∂ht auf 1MB (1.000.000 Bytes) ---
            if (audioUrl) audioData = audioUrl; else if (audioFile) { if (audioFile.size > 1000000) { alert("Audio max 1MB"); return; } audioData = await toBase64(audioFile); }
            if (imageUrl) imageData = imageUrl; else if (imageFile) { if (imageFile.size > 2000000) { alert("Bild max 2MB"); return; } imageData = await toBase64(imageFile); }
            
            if (document.getElementById('stechen-area').style.display === 'block') { document.querySelectorAll('.stechen-check').forEach(cb => { if (cb.checked) targetPlayers.push(cb.value); }); if (targetPlayers.length === Object.keys(currentPlayers).filter(k=>currentPlayers[k].isVerified).length) targetPlayers = []; }
            
            if (type === 'MC') {
                document.querySelectorAll('#mc-inputs .dynamic-row').forEach(row => { const val = row.querySelector('.mc-text').value.trim(); if(val) { options.push(val); if(row.querySelector('.radio-correct').checked) correctAnswer = val; } });
                if(options.length < 2) { alert("Min 2 Optionen"); return; } if(!qText) qText = "W√§hle aus:";
            } else if (type === 'LIST') {
                answerCount = document.getElementById('list-count').value;
                if(!qText) qText = `Nenne ${answerCount} Dinge:`;
                const enteredSol = document.getElementById('m-correct-text').value; if(enteredSol) correctAnswer = enteredSol;
            } else if (type === 'SEQUENCE') {
                document.querySelectorAll('#seq-inputs .dyn-inp').forEach(inp => { if(inp.value.trim()) options.push(inp.value.trim()); }); if(options.length < 2) { alert("Min 2 Elemente"); return; } if(!qText) qText = "Sortiere:"; correctAnswer = [...options];
            } else if (type === 'MATCHING') {
                const lefts = document.querySelectorAll('.match-l'); const rights = document.querySelectorAll('.match-r'); let pairObj = {};
                for(let i=0; i<lefts.length; i++) { if(lefts[i].value.trim()) { pairs.push({ left: lefts[i].value.trim(), right: rights[i].value.trim() }); pairObj[lefts[i].value.trim()] = rights[i].value.trim(); } }
                if(pairs.length < 2) { alert("Min 2 Paare"); return; } if(!qText) qText = "Ordne zu:"; correctAnswer = pairObj;
            } else if (type === 'ESTIMATE' || type === 'TEXT') {
                if(type === 'ESTIMATE') { min = document.getElementById('est-min').value; max = document.getElementById('est-max').value; if(min==='' || max==='') { alert("Min/Max!"); return; } if(!qText) qText = `Sch√§tze ${min}-${max}:`; }
                const enteredSol = document.getElementById('m-correct-text').value; if(enteredSol) correctAnswer = enteredSol;
            } else if (type === 'PLAYER_VOTE') {
                if(!qText) qText = 'Wer verliert ein Leben?';
                if (document.getElementById('powervoter-area').style.display === 'block') {
                    document.querySelectorAll('.powervoter-check').forEach(cb => { if (cb.checked) powerVoter.push(cb.value); });
                }
            } else if (type === 'VIDEO_STREAM') {
                const ytLink = document.getElementById('m-yt-link').value.trim();
                const ytId = extractYoutubeId(ytLink);
                if (!ytId) { alert("Ung√ºltiger YouTube Link!"); return; }
                videoData = ytId;
                if(!qText) qText = "Live Stream";
            } else if (type === 'OFFLINE_RESULTS') {
                if(!qText) qText = "Offline Ergebnisse";
            } else if (type === 'INFO') {
                if(!qText) qText = "Info";
            }
            
            socket.emit('gm_start_round', { type, question: qText, options, pairs, min, max, answerCount, targetPlayers, correctAnswer, audioData, imageData, videoData, powerVoter });
            closeModal(); 
            // Reset Fields
            document.getElementById('m-question').value = ''; document.getElementById('m-correct-text').value = ''; 
            document.getElementById('m-audio-url').value = ''; document.getElementById('m-audio-file').value = ''; 
            document.getElementById('m-image-url').value = ''; document.getElementById('m-image-file').value = '';
            document.getElementById('m-yt-link').value = '';
        }

        function extractYoutubeId(url) {
            if(!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }
        
        // --- BUTTON ACTIONS ---
        function toggleVote() {
            if (isAnsweringOpen) {
                socket.emit('gm_close_answering');
            } else {
                socket.emit('gm_open_answering');
            }
        }
        function reveal() { socket.emit('gm_reveal'); }
        function resetAll() { if(confirm("üö® ALLES L√ñSCHEN?")) socket.emit('gm_reset_all'); }
        function saveOfflineResults() {
            const inputs = document.querySelectorAll('.offline-val');
            const answers = {};
            inputs.forEach(inp => { const user = inp.getAttribute('data-user'); if(inp.value.trim()) answers[user] = inp.value.trim(); });
            socket.emit('gm_set_bulk_answers', answers);
        }

        socket.on('gm_update_full', (data) => {
            currentPlayers = data.players; document.getElementById('game-id-display').innerText = `(${data.gameId})`;
            // ROUND COUNTER
            document.getElementById('round-counter-display').innerText = `Runde ${data.roundNumber}`;
            
            roundStartTime = data.round.startTime;
            roundEndTime = data.round.endTime;
            renderSidebar(data.players); renderMainArea(data.round, data.players);
        });

        // --- TIMER LOGIC ---
        setInterval(() => {
            const display = document.getElementById('timer-display');
            if (!display) return;
            
            if (roundStartTime) {
                let diff = 0;
                if (roundEndTime) {
                    diff = roundEndTime - roundStartTime;
                    display.style.color = '#ef4444'; 
                } else {
                    diff = Date.now() - roundStartTime;
                    display.style.color = '#22c55e';
                }
                
                if (diff < 0) diff = 0;
                const seconds = Math.floor((diff / 1000) % 60);
                const minutes = Math.floor((diff / (1000 * 60)) % 60);
                display.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                display.innerText = "00:00";
                display.style.color = '#6b7280';
            }
        }, 100);

        function renderSidebar(players) {
            const list = document.getElementById('sidebar-list'); list.innerHTML = '';
            const active = []; const pending = []; for (const [name, p] of Object.entries(players)) { if(p.isVerified) active.push({name, ...p}); else pending.push({name, ...p}); }
            active.forEach(p => {
                const row = document.createElement('div'); row.className = 'player-row'; let nameHtml = `<div class="player-name">${p.name}</div>`;
                if(p.lives <= 0) { row.classList.add('eliminated'); nameHtml = `<div class="player-name">üíÄ ${p.name}</div>`; }
                const dotClass = p.hasAnswered ? 'status-dot active' : 'status-dot';
                const connectedStyle = p.connected ? '' : 'opacity:0.4;';
                row.innerHTML = `<div class="player-info" style="${connectedStyle}"><span class="${dotClass}"></span><div>${nameHtml}<span class="player-code">${p.code}</span></div></div><div class="lives-control"><button onclick="modLife('${p.name}', -1)">‚àí</button><span style="min-width:20px; text-align:center; font-size:0.9rem;">${p.lives}</span><button onclick="modLife('${p.name}', 1)">+</button></div>`;
                list.appendChild(row);
            });
            if (pending.length > 0) { list.innerHTML += `<div class="pending-header">Beitrittsanfragen</div>`; pending.forEach(p => list.innerHTML += `<div class="pending-row"><div><strong>${p.name}</strong></div><div style="font-family:monospace; font-weight:bold;">${p.code}</div></div>`); }
        }
        
        function renderMainArea(round, players) {
            const btnVote = document.getElementById('btn-toggle-vote'); 
            const btnReveal = document.getElementById('btn-reveal');
            
            isAnsweringOpen = round.answeringOpen;
            isImageRevealed = round.imageRevealed; 
            isTextRevealed = round.textRevealed;
            isInputBlocked = round.isInputBlocked;

            // Update Image Button Style
            const imgBtn = document.getElementById('btn-img-toggle');
            const imgText = document.getElementById('img-toggle-text');
            if(isImageRevealed) {
                imgBtn.classList.add('visible');
                imgText.innerText = "Bild ist sichtbar";
            } else {
                imgBtn.classList.remove('visible');
                imgText.innerText = "Bild zeigen";
            }

            // Update Input Block Button
            const blockBtn = document.getElementById('btn-block-toggle');
            if (round.answeringOpen) {
                blockBtn.style.display = 'inline-flex';
                if(isInputBlocked) {
                    blockBtn.innerHTML = "‚å®Ô∏è Eingabe: üîí";
                    blockBtn.className = "btn-block-toggle blocked";
                } else {
                    blockBtn.innerHTML = "‚å®Ô∏è Eingabe: üîì";
                    blockBtn.className = "btn-block-toggle open";
                }
            } else {
                blockBtn.style.display = 'none';
            }


            // Update Text Button Style & Visibility
            const txtBtn = document.getElementById('btn-text-toggle');
            const qText = document.getElementById('q-text');
            if (round.imageData) {
                txtBtn.style.display = 'flex'; 
                if (isTextRevealed) {
                    txtBtn.classList.add('visible');
                    txtBtn.classList.remove('hidden');
                    qText.classList.remove('q-text-hidden');
                } else {
                    txtBtn.classList.add('hidden');
                    txtBtn.classList.remove('visible');
                    qText.classList.add('q-text-hidden');
                }
            } else {
                txtBtn.style.display = 'none';
                qText.classList.remove('q-text-hidden');
            }

            // --- BUTTON LOGIK ---
            if (round.type === 'WAITING' || round.type === 'OFFLINE_RESULTS' || round.type === 'VIDEO_STREAM' || round.type === 'INFO') { 
                btnVote.style.display = 'none'; 
                btnReveal.style.display = 'none'; 
            }
            else if (round.answeringOpen) { 
                // Phase 1: Voting ist OFFEN
                btnVote.style.display = 'inline-flex'; 
                btnVote.innerHTML = 'üîí Voting Schlie√üen';
                btnVote.className = 'btn-close-vote'; // Gelb
                btnReveal.style.display = 'none'; 
            }
            else { 
                // Phase 2: Voting GESCHLOSSEN
                if (round.revealed) {
                    // Alles schon offen
                    btnVote.style.display = 'none'; 
                    btnReveal.style.display = 'none';
                } else {
                    // Geschlossen, aber noch nicht global aufgel√∂st
                    btnReveal.style.display = 'inline-block'; // AUFL√ñSEN
                    
                    btnVote.style.display = 'inline-flex';
                    btnVote.innerHTML = 'üîì Wiederer√∂ffnen';
                    btnVote.className = 'btn-reopen-vote'; // Gr√ºn
                }
            }

            let qInfo = round.question || "Warte auf Start...";
            if (round.targetPlayers && round.targetPlayers.length > 0) qInfo += ` <span style="color:#dc2626; font-size:1rem; font-weight:normal;">(Nur: ${round.targetPlayers.join(', ')})</span>`;
            if (round.audioData) { gmAudioWrapper.style.display = 'block'; if (gmAudio.dataset.src !== round.audioData) { gmAudio.src = round.audioData; gmAudio.dataset.src = round.audioData; } } else { gmAudioWrapper.style.display = 'none'; gmAudio.pause(); gmAudio.src = ""; gmAudio.dataset.src = ""; }
            if (round.imageData) { gmImageWrapper.style.display = 'block'; gmImage.src = round.imageData; } else { gmImageWrapper.style.display = 'none'; gmImage.src = ""; }
            
            if (round.videoData) {
                gmVideoWrapper.style.display = 'block';
                document.getElementById('gm-video-id').innerText = round.videoData;
            } else {
                gmVideoWrapper.style.display = 'none';
            }

            document.getElementById('q-text').innerHTML = qInfo; document.getElementById('q-type').innerText = round.type;
            const grid = document.getElementById('answers-area'); grid.innerHTML = '';
            
            const offlineArea = document.getElementById('offline-input-area');
            if (round.type === 'OFFLINE_RESULTS' && !round.revealed) {
                offlineArea.style.display = 'block';
                const inputList = document.getElementById('offline-player-inputs');
                inputList.innerHTML = '';
                for(const [name, p] of Object.entries(players)) {
                    if(!p.isVerified) continue;
                    const val = p.answer || '';
                    inputList.innerHTML += `<div class="offline-input-row"><label>${name}</label><input type="text" class="offline-val" data-user="${name}" value="${val}" placeholder="Ergebnis/Punkte"></div>`;
                }
            } else { offlineArea.style.display = 'none'; }

            if (round.revealed && round.correctAnswer) {
                let solText = JSON.stringify(round.correctAnswer);
                if (typeof round.correctAnswer === 'string' || typeof round.correctAnswer === 'number') solText = round.correctAnswer;
                else if (Array.isArray(round.correctAnswer)) solText = round.correctAnswer.join(" ‚Üí ");
                else if (typeof round.correctAnswer === 'object') { solText = ""; for(const[k,v] of Object.entries(round.correctAnswer)) solText += `${k}=${v}, `; }
                grid.innerHTML += `<div style="grid-column: 1/-1; background:#dcfce7; color:#14532d; padding:20px; border-radius:12px; border:1px solid #bbf7d0; margin-bottom:15px; display:flex; align-items:center; gap:10px;"><strong>üèÜ RICHTIGE ANTWORT:</strong> <span style="font-size:1.3rem; font-weight:bold;">${solText}</span></div>`;
            }
            
            // --- ANSWER GRID ---
            let count = 0;
            // Create array from players to sort them
            let playerList = Object.entries(players).map(([name, p]) => ({name, ...p}));
            
            // NEW SORTING LOGIC: REVEALED FIRST (LIFO)
            playerList.sort((a, b) => {
                const revealed = round.revealedAnswers || [];
                const idxA = revealed.indexOf(a.name);
                const idxB = revealed.indexOf(b.name);
                
                // Beide sind aufgedeckt -> Der mit dem h√∂heren Index (sp√§ter aufgedeckt) kommt nach oben
                if (idxA !== -1 && idxB !== -1) return idxB - idxA;
                
                // Nur A ist aufgedeckt -> A nach oben
                if (idxA !== -1) return -1;
                
                // Nur B ist aufgedeckt -> B nach oben
                if (idxB !== -1) return 1;
                
                // Fallback: Wer hat geantwortet?
                if (a.hasAnswered && !b.hasAnswered) return -1;
                if (!a.hasAnswered && b.hasAnswered) return 1;
                
                return 0; 
            });

            for (const p of playerList) {
                const name = p.name;
                if (p.hasAnswered) count++;
                if (p.hasAnswered && p.answer) {
                    const card = document.createElement('div'); card.className = 'answer-card';
                    
                    const isRevealed = round.revealedAnswers && round.revealedAnswers.includes(name);
                    const isGlobal = round.revealed;
                    
                    if (isRevealed) {
                        card.classList.add('answer-revealed');
                    }

                    // --- CONTENT GENERATION FIRST ---
                    let contentHtml = '';
                    let displayAnswer = p.answer;
                    
                    // SCH√ÑTZEN DIFFERENZ LOGIK
                    let diffBadge = "";
                    if (round.type === 'ESTIMATE' && round.correctAnswer !== null && (isGlobal || isRevealed)) {
                         const correct = Number(round.correctAnswer);
                         const given = Number(p.answer);
                         if (!isNaN(correct) && !isNaN(given)) {
                             const diff = Math.abs(correct - given);
                             diffBadge = `<span class="diff-badge">Diff: ${diff}</span>`;
                         }
                    }

                    if (round.type === 'MATCHING' && typeof p.answer === 'object') {
                        displayAnswer = '<ul style="margin:0; padding-left:20px;">'; for(const [k, v] of Object.entries(p.answer)) displayAnswer += `<li>${k} ‚ûù <b>${v}</b></li>`; displayAnswer += '</ul>';
                    } else if (Array.isArray(p.answer)) {
                        if(round.type === 'LIST') displayAnswer = '<ol style="margin:0; padding-left:20px;">' + p.answer.map(a => `<li>${a}</li>`).join('') + '</ol>';
                        else displayAnswer = p.answer.join(" ‚Üí ");
                    }
                    
                    if (round.type === 'PLAYER_VOTE') { 
                        card.style.borderLeft = "6px solid #ef4444"; 
                        contentHtml = `<strong>${name} w√§hlt:</strong><div style="font-size:1.5rem; font-weight:bold;">${p.answer}</div>`; 
                    } else {
                        contentHtml = `<strong>${name}</strong><div class="answer-val" style="color:#2563eb;">${displayAnswer}${diffBadge}</div>`;
                    }

                    // Set innerHTML first!
                    card.innerHTML = contentHtml;

                    // --- BUTTON GENERATION LAST ---
                    // Button only visible if voting is closed AND not globally revealed
                    if (!round.answeringOpen && !isGlobal) {
                        const btn = document.createElement('button');
                        btn.className = 'btn-reveal-single';
                        
                        if (isRevealed) {
                            // If already revealed -> Green Checkmark (Toggle state)
                            btn.innerHTML = '‚úîÔ∏è';
                            btn.classList.add('checked');
                        } else {
                            // Not revealed -> Eye
                            btn.innerHTML = 'üëÅÔ∏è';
                            btn.onclick = () => revealSingle(name);
                        }
                        card.appendChild(btn); // Now appendChild works safely!
                    }

                    grid.appendChild(card);
                }
            }
            document.getElementById('answer-count').innerText = count;
        }
        function modLife(user, amount) { socket.emit('gm_modify_lives', { user, amount }); }
        setInterval(() => { fetch('/').catch(e => {}) }, 240000);
    </script>
</body>
</html>
