<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Control</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f0f2f5; height: 100vh; display: flex; overflow: hidden; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        
        #main-ui { display: none; width: 100%; height: 100%; }
        
        .sidebar { width: 300px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar-header { padding: 20px; background: #2c3e50; color: white; font-weight: bold; }
        .player-row { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .player-name { font-weight: bold; }
        .player-code { font-size: 0.8rem; color: #7f8c8d; background: #eee; padding: 2px 5px; border-radius: 4px; }
        .lives-control { display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 10px; }
        .status-dot.active { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        .content { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        .top-bar { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        
        .btn-new-q { background: #3498db; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        .btn-reveal { background: #f39c12; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-right: 10px;}
        .btn-reveal:hover { background: #e67e22; }

        .current-question { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #3498db; display: flex; justify-content: space-between; align-items: center;}
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .answer-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; overflow-wrap: break-word;}
        
        dialog { border: none; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 700px; max-width: 95%; }
        dialog::backdrop { background: rgba(0,0,0,0.5); }
        .modal-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;}
        
        input, select { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        /* DYNAMIC INPUTS */
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .dynamic-row input { flex: 1; }
        .btn-add-opt { background: #eee; border: 1px solid #ccc; padding: 5px 10px; cursor: pointer; width: 100%; border-radius: 4px; margin-top: 5px;}
        .section-label { font-weight: bold; font-size: 0.9rem; margin-top: 10px; display: block; }

        .btn-reset-round { background: #c0392b; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;}
        .btn-cancel { padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; }
        .btn-start { background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem;}
        .btn-mini { padding: 2px 8px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; }

        /* STECHEN / TARGET PLAYERS */
        #stechen-area { border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-top: 10px; display: none; background: #fafafa; }
        .player-check-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 5px; margin-top: 5px; }
        .p-check-label { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer; background: white; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
        .p-check-label:hover { background: #f0f0f0; }
        .p-check-label input { width: auto; margin: 0; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>üîí GM Login</h2>
            <input type="password" id="gm-password" placeholder="Passwort" onkeyup="if(event.key === 'Enter') login()">
            <br><br>
            <button class="btn-new-q" onclick="login()">Einloggen</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="sidebar">
            <div class="sidebar-header">Teilnehmer</div>
            <div id="sidebar-list"></div>
        </div>

        <div class="content">
            <div class="top-bar">
                <h1>Gamemaster</h1>
                <div>
                    <button id="btn-reveal" class="btn-reveal" onclick="reveal()">üëÅÔ∏è Aufl√∂sen</button>
                    <button class="btn-new-q" onclick="openModal()">+ N√§chste Frage</button>
                </div>
            </div>

            <div class="current-question">
                <div>
                    <h2 id="q-text" style="margin:0;">...</h2>
                    <p id="q-type" style="margin:5px 0 0 0; color:#777;">...</p>
                </div>
                <div style="text-align:right;">
                    <strong style="font-size:2rem; color:#3498db;" id="answer-count">0</strong>
                    <div style="font-size:0.8rem;">Antworten</div>
                </div>
            </div>

            <div class="answers-grid" id="answers-area"></div>
        </div>
    </div>

    <!-- MODAL -->
    <dialog id="q-modal">
        <div class="modal-header">
            <strong>Frage konfigurieren</strong>
            <button onclick="closeModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">&times;</button>
        </div>
        <div class="modal-body">
            <label><strong>Modus:</strong></label>
            <select id="m-type" onchange="updateModalFields()">
                <option value="MC">Multiple Choice</option>
                <option value="SEQUENCE">Reihenfolge (Sortieren)</option>
                <option value="ESTIMATE">Sch√§tzen (Zahl)</option>
                <option value="MATCHING">Zuordnen (Paare)</option>
                <option value="TEXT">Textantwort</option>
                <option value="PLAYER_VOTE">Voting: Wer verliert Leben?</option>
            </select>

            <label><strong>Frage / Titel:</strong></label>
            <input type="text" id="m-question" placeholder="Fragetext eingeben...">

            <!-- STECHEN OPTION -->
            <div style="margin-top:10px;">
                <button class="btn-mini" onclick="toggleStechen()">‚öîÔ∏è Stechen / Zielgruppe einschr√§nken</button>
                <div id="stechen-area">
                    <small>Wer soll die Frage bekommen? (Leer = Alle)</small>
                    <div class="player-check-grid" id="stechen-list"></div>
                </div>
            </div>

            <!-- DYNAMISCHER BEREICH -->
            <div id="dynamic-area"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-reset-round" onclick="startRound(true)">‚ö†Ô∏è Neue Spielrunde</button>
            <div style="display:flex; gap:10px;">
                <button class="btn-cancel" onclick="closeModal()">Abbrechen</button>
                <button class="btn-start" onclick="startRound(false)">Starten</button>
            </div>
        </div>
    </dialog>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentPlayers = {}; // Cache f√ºr Stechen-Liste

        function login() { socket.emit('gm_login', document.getElementById('gm-password').value); }
        socket.on('gm_login_success', () => {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
        });

        const modal = document.getElementById('q-modal');
        function openModal() { 
            updateModalFields(); 
            generateStechenList(); 
            // Reset Stechen area
            document.getElementById('stechen-area').style.display = 'none';
            modal.showModal(); 
        }
        function closeModal() { modal.close(); }

        // --- STECHEN LOGIK ---
        function toggleStechen() {
            const area = document.getElementById('stechen-area');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        }

        function generateStechenList() {
            const container = document.getElementById('stechen-list');
            container.innerHTML = '';
            // Alle Spieler als Checkboxen
            for (const name of Object.keys(currentPlayers)) {
                const label = document.createElement('label');
                label.className = 'p-check-label';
                label.innerHTML = `<input type="checkbox" value="${name}" class="stechen-check" checked> ${name}`;
                container.appendChild(label);
            }
        }

        function updateModalFields() {
            const type = document.getElementById('m-type').value;
            const container = document.getElementById('dynamic-area');
            container.innerHTML = '';

            if (type === 'MC') {
                container.innerHTML = `<span class="section-label">Antworten:</span><div id="mc-inputs"></div><button class="btn-add-opt" onclick="addInputRow('mc-inputs', 'Antwort...')">+ Option</button>`;
                addInputRow('mc-inputs', 'Antwort...'); addInputRow('mc-inputs', 'Antwort...'); addInputRow('mc-inputs', 'Antwort...');
            } 
            else if (type === 'SEQUENCE') {
                container.innerHTML = `<span class="section-label">Korrekte Reihenfolge (Oben = 1.):</span><div id="seq-inputs"></div><button class="btn-add-opt" onclick="addInputRow('seq-inputs', 'Element...')">+ Element</button>`;
                addInputRow('seq-inputs', 'Element...'); addInputRow('seq-inputs', 'Element...'); addInputRow('seq-inputs', 'Element...');
            }
            else if (type === 'ESTIMATE') {
                container.innerHTML = `
                    <span class="section-label">Bereich festlegen:</span>
                    <div class="dynamic-row">
                        <input type="number" id="est-min" placeholder="Min (z.B. 0)">
                        <input type="number" id="est-max" placeholder="Max (z.B. 2024)">
                    </div>
                `;
            }
            else if (type === 'MATCHING') {
                container.innerHTML = `<span class="section-label">Paare (Links -> Rechts):</span><div id="match-inputs"></div><button class="btn-add-opt" onclick="addMatchPair()">+ Paar</button>`;
                addMatchPair(); addMatchPair();
            }
        }

        function addInputRow(parentId, placeholder) {
            const div = document.createElement('div');
            div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="dyn-inp" placeholder="${placeholder}">`;
            document.getElementById(parentId).appendChild(div);
        }

        function addMatchPair() {
            const div = document.createElement('div');
            div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="match-l" placeholder="L"><input type="text" class="match-r" placeholder="R">`;
            document.getElementById('match-inputs').appendChild(div);
        }

        function startRound(isNewGameRound) {
            const type = document.getElementById('m-type').value;
            const text = document.getElementById('m-question').value;
            let qText = text;
            
            let options = [];
            let pairs = [];
            let min = 0, max = 100;
            let targetPlayers = [];

            // Stechen-Daten sammeln
            if (document.getElementById('stechen-area').style.display === 'block') {
                document.querySelectorAll('.stechen-check').forEach(cb => {
                    if (cb.checked) targetPlayers.push(cb.value);
                });
                // Wenn alle ausgew√§hlt sind, senden wir leeres Array (=Alle)
                if (targetPlayers.length === Object.keys(currentPlayers).length) targetPlayers = [];
            }

            if (type === 'MC' || type === 'SEQUENCE') {
                document.querySelectorAll('.dyn-inp').forEach(inp => {
                    if(inp.value.trim()) options.push(inp.value.trim());
                });
                if(options.length < 2) { alert("Mindestens 2 Elemente n√∂tig."); return; }
                if(!qText) qText = type === 'MC' ? "W√§hle aus:" : "Sortiere:";
            } 
            else if (type === 'ESTIMATE') {
                min = document.getElementById('est-min').value;
                max = document.getElementById('est-max').value;
                if(min === '' || max === '') { alert("Min/Max angeben!"); return; }
                if(!qText) qText = `Sch√§tze zwischen ${min} und ${max}:`;
            }
            else if (type === 'MATCHING') {
                const lefts = document.querySelectorAll('.match-l');
                const rights = document.querySelectorAll('.match-r');
                for(let i=0; i<lefts.length; i++) {
                    if(lefts[i].value.trim()) pairs.push({ left: lefts[i].value.trim(), right: rights[i].value.trim() });
                }
                if(pairs.length < 2) { alert("Mindestens 2 Paare."); return; }
                if(!qText) qText = "Ordne zu:";
            }
            else if (type === 'PLAYER_VOTE' && !qText) {
                qText = 'Wer verliert ein Leben?';
            }

            if(isNewGameRound && !confirm("Archiv l√∂schen und neue Runde?")) return;

            socket.emit('gm_start_round', { 
                type, question: qText, options, pairs, min, max, targetPlayers, isNewGameRound 
            });
            closeModal();
            document.getElementById('m-question').value = '';
        }

        function reveal() { socket.emit('gm_reveal'); }

        socket.on('gm_update_full', (data) => {
            currentPlayers = data.players; // Cache update
            renderSidebar(data.players);
            renderMainArea(data.round, data.players);
        });

        function renderSidebar(players) {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';
            for (const [name, p] of Object.entries(players)) {
                const row = document.createElement('div');
                row.className = 'player-row';
                const dotClass = p.hasAnswered ? 'status-dot active' : 'status-dot';
                row.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span class="${dotClass}"></span>
                        <div><div class="player-name">${name}</div><span class="player-code">${p.code}</span></div>
                    </div>
                    <div class="lives-control">
                        <button class="btn-mini" onclick="modLife('${name}', -1)">-</button>
                        <span style="min-width:30px; text-align:center;">${p.lives}‚ù§Ô∏è</span>
                        <button class="btn-mini" onclick="modLife('${name}', 1)">+</button>
                    </div>`;
                list.appendChild(row);
            }
        }

        function renderMainArea(round, players) {
            let qInfo = round.question || "Pause";
            if (round.targetPlayers && round.targetPlayers.length > 0) {
                qInfo += ` <span style="color:#e74c3c; font-size:0.8rem;">(Nur: ${round.targetPlayers.join(', ')})</span>`;
            }
            document.getElementById('q-text').innerHTML = qInfo;
            document.getElementById('q-type').innerText = round.type;
            
            const btnReveal = document.getElementById('btn-reveal');
            btnReveal.style.display = (round.revealed || round.type === 'WAITING') ? 'none' : 'inline-block';

            const grid = document.getElementById('answers-area');
            grid.innerHTML = '';

            let count = 0;
            for (const [name, p] of Object.entries(players)) {
                if (p.hasAnswered) count++;
                if (p.hasAnswered && p.answer) {
                    const card = document.createElement('div');
                    card.className = 'answer-card';
                    
                    let displayAnswer = p.answer;
                    
                    // Formatierung f√ºr Komplexe Typen
                    if (round.type === 'MATCHING' && typeof p.answer === 'object') {
                        displayAnswer = '<ul style="margin:0; padding-left:20px; font-size:0.9rem;">';
                        for(const [k, v] of Object.entries(p.answer)) displayAnswer += `<li>${k} ‚ûù <b>${v}</b></li>`;
                        displayAnswer += '</ul>';
                    }
                    else if (round.type === 'SEQUENCE' && Array.isArray(p.answer)) {
                        displayAnswer = '<ol style="margin:0; padding-left:20px; font-size:0.9rem;">';
                        p.answer.forEach(itm => displayAnswer += `<li>${itm}</li>`);
                        displayAnswer += '</ol>';
                    }

                    if (round.type === 'PLAYER_VOTE') {
                        card.style.borderLeft = "5px solid #e74c3c";
                        card.innerHTML = `<strong>${name} w√§hlt:</strong><div style="font-size:1.5rem">${p.answer}</div>`;
                    } else {
                        card.innerHTML = `<strong>${name}</strong><div style="font-size:1.1rem; color:#3498db; margin-top:5px;">${displayAnswer}</div>`;
                    }
                    grid.appendChild(card);
                }
            }
            document.getElementById('answer-count').innerText = count;
        }

        function modLife(user, amount) { socket.emit('gm_modify_lives', { user, amount }); }
        setInterval(() => { fetch('/').catch(e => {}) }, 240000);
    </script>
</body>
</html>
