<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Control</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f0f2f5; height: 100vh; display: flex; overflow: hidden; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        
        #main-ui { display: none; width: 100%; height: 100%; }
        
        .sidebar { width: 300px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar-header { padding: 20px; background: #2c3e50; color: white; font-weight: bold; }
        .player-row { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .player-name { font-weight: bold; }
        .player-code { font-size: 0.8rem; color: #7f8c8d; background: #eee; padding: 2px 5px; border-radius: 4px; }
        .lives-control { display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 10px; }
        .status-dot.active { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        .content { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        .top-bar { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        
        /* Buttons */
        .btn-new-q { background: #3498db; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        .btn-reveal { background: #f39c12; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-right: 10px;}
        .btn-reveal:hover { background: #e67e22; }
        .btn-reveal:disabled { background: #bdc3c7; cursor: not-allowed; }

        .current-question { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #3498db; display: flex; justify-content: space-between; align-items: center;}
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .answer-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
        
        dialog { border: none; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 600px; max-width: 90%; }
        dialog::backdrop { background: rgba(0,0,0,0.5); }
        .modal-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;}
        
        input, select { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        .btn-reset-round { background: #c0392b; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;}
        .btn-cancel { padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; }
        .btn-start { background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem;}
        .btn-mini { padding: 2px 8px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>üîí GM Login</h2>
            <input type="password" id="gm-password" placeholder="Passwort" onkeyup="if(event.key === 'Enter') login()">
            <br><br>
            <button class="btn-new-q" onclick="login()">Einloggen</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="sidebar">
            <div class="sidebar-header">Teilnehmer</div>
            <div id="sidebar-list"></div>
        </div>

        <div class="content">
            <div class="top-bar">
                <h1>Gamemaster</h1>
                <div>
                    <!-- Der Reveal Button -->
                    <button id="btn-reveal" class="btn-reveal" onclick="reveal()">üëÅÔ∏è Aufl√∂sen</button>
                    <button class="btn-new-q" onclick="openModal()">+ N√§chste Frage</button>
                </div>
            </div>

            <div class="current-question">
                <div>
                    <h2 id="q-text" style="margin:0;">...</h2>
                    <p id="q-type" style="margin:5px 0 0 0; color:#777;">...</p>
                </div>
                <div style="text-align:right;">
                    <strong style="font-size:2rem; color:#3498db;" id="answer-count">0</strong>
                    <div style="font-size:0.8rem;">Antworten</div>
                </div>
            </div>

            <div class="answers-grid" id="answers-area"></div>
        </div>
    </div>

    <dialog id="q-modal">
        <div class="modal-header">
            <strong>Steuerung</strong>
            <button onclick="closeModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">&times;</button>
        </div>
        <div class="modal-body">
            <label><strong>Modus w√§hlen:</strong></label>
            <select id="m-type">
                <option value="MC">Frage: Multiple Choice (A/B/C/D)</option>
                <option value="TEXT">Frage: Textantwort</option>
                <option value="PLAYER_VOTE">Voting: Wer verliert Leben?</option>
            </select>

            <label><strong>Frage / Anweisung:</strong></label>
            <input type="text" id="m-question" placeholder="Fragetext eingeben...">
        </div>
        <div class="modal-footer">
            <button class="btn-reset-round" onclick="startRound(true)">‚ö†Ô∏è Neue Spielrunde (Archiv leeren)</button>
            <div style="display:flex; gap:10px;">
                <button class="btn-cancel" onclick="closeModal()">Abbrechen</button>
                <button class="btn-start" onclick="startRound(false)">Starten</button>
            </div>
        </div>
    </dialog>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        function login() { socket.emit('gm_login', document.getElementById('gm-password').value); }
        socket.on('gm_login_success', () => {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
        });

        const modal = document.getElementById('q-modal');
        function openModal() { modal.showModal(); }
        function closeModal() { modal.close(); }
        
        function startRound(isNewGameRound) {
            const type = document.getElementById('m-type').value;
            const text = document.getElementById('m-question').value;
            const qText = text || (type === 'PLAYER_VOTE' ? 'Wer verliert ein Leben?' : 'Frage');

            if(isNewGameRound) {
                if(!confirm("‚ö†Ô∏è Neue Runde starten?\nAlle aktuellen Antworten werden archiviert/gel√∂scht.")) return;
            }

            socket.emit('gm_start_round', { type: type, question: qText, isNewGameRound: isNewGameRound });
            closeModal();
            document.getElementById('m-question').value = '';
        }

        // AUFDECKEN
        function reveal() {
            socket.emit('gm_reveal');
        }

        socket.on('gm_update_full', (data) => {
            renderSidebar(data.players);
            renderMainArea(data.round, data.players);
        });

        function renderSidebar(players) {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';
            for (const [name, p] of Object.entries(players)) {
                const row = document.createElement('div');
                row.className = 'player-row';
                const dotClass = p.hasAnswered ? 'status-dot active' : 'status-dot';
                row.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span class="${dotClass}"></span>
                        <div><div class="player-name">${name}</div><span class="player-code">${p.code}</span></div>
                    </div>
                    <div class="lives-control">
                        <button class="btn-mini" onclick="modLife('${name}', -1)">-</button>
                        <span style="min-width:30px; text-align:center;">${p.lives}‚ù§Ô∏è</span>
                        <button class="btn-mini" onclick="modLife('${name}', 1)">+</button>
                    </div>`;
                list.appendChild(row);
            }
        }

        function renderMainArea(round, players) {
            document.getElementById('q-text').innerText = round.question || "Pause";
            document.getElementById('q-type').innerText = round.type;
            
            // Reveal Button Logic
            const btnReveal = document.getElementById('btn-reveal');
            if (round.revealed || round.type === 'WAITING') {
                btnReveal.style.display = 'none';
            } else {
                btnReveal.style.display = 'inline-block';
            }

            const grid = document.getElementById('answers-area');
            grid.innerHTML = '';

            let count = 0;
            for (const [name, p] of Object.entries(players)) {
                if (p.hasAnswered) count++;
                
                if (p.hasAnswered && p.answer) {
                    const card = document.createElement('div');
                    card.className = 'answer-card';
                    if (round.type === 'PLAYER_VOTE') {
                        card.style.borderLeft = "5px solid #e74c3c";
                        card.innerHTML = `<strong>${name} w√§hlt:</strong><div style="font-size:1.5rem">${p.answer}</div>`;
                    } else {
                        card.innerHTML = `<strong>${name}</strong><div style="font-size:1.2rem; color:#3498db;">${p.answer}</div>`;
                    }
                    grid.appendChild(card);
                }
            }
            document.getElementById('answer-count').innerText = count;
        }

        function modLife(user, amount) { socket.emit('gm_modify_lives', { user, amount }); }
        setInterval(() => { fetch('/').catch(e => {}) }, 240000);
    </script>
</body>
</html>
