<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Control</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }
        
        /* LAYOUT */
        #main-ui { display: flex; width: 100%; height: 100%; }
        
        /* SIDEBAR */
        .sidebar { width: 320px; background: var(--card-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.03); }
        .sidebar-header { padding: 20px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--text-main); letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center;}
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px 0; }
        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border); background: #f8fafc; }

        .player-row { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .player-row:hover { background: #f8fafc; }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-name { font-weight: 600; font-size: 0.95rem; }
        .player-code { font-size: 0.75rem; color: var(--text-muted); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; letter-spacing: 1px; }
        
        /* Eliminated State */
        .player-row.eliminated { background: #fef2f2; opacity: 0.8; }
        .player-row.eliminated .player-name { text-decoration: line-through; color: var(--danger); }

        /* Status Dot */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; transition: all 0.3s; }
        .status-dot.active { background: var(--success); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }

        /* Lives */
        .lives-control { display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 4px; border-radius: 6px; border: 1px solid var(--border); }
        .lives-count { font-weight: 700; min-width: 35px; text-align: center; color: var(--danger); font-variant-numeric: tabular-nums; }

        /* CONTENT */
        .content { flex: 1; padding: 40px; display: flex; flex-direction: column; overflow-y: auto; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: var(--card-bg); padding: 15px 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .top-bar h1 { margin: 0; font-size: 1.25rem; font-weight: 800; color: var(--text-main); }
        .gm-actions { display: flex; gap: 10px; }

        /* BUTTONS */
        button { font-family: inherit; transition: all 0.2s; cursor: pointer; border: none; outline: none; }
        button:active { transform: translateY(1px); }

        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); }
        .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 4px 8px rgba(79, 70, 229, 0.4); }

        .btn-danger { background: var(--danger); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; }
        .btn-danger:hover { background: #dc2626; }
        
        .btn-warning { background: var(--warning); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; }
        .btn-warning:hover { background: #d97706; }
        
        .btn-secondary { background: #fff; border: 1px solid var(--border); color: var(--text-main); padding: 10px 20px; border-radius: 8px; font-weight: 600; }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }

        .btn-icon { width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1rem; background: white; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-icon:hover { background: #f1f5f9; color: var(--text-main); }

        .btn-small { font-size: 0.8rem; padding: 8px 12px; width: 100%; border-radius: 6px; background: white; border: 1px dashed var(--border); color: var(--text-muted); }
        .btn-small:hover { border-color: var(--primary); color: var(--primary); }

        /* CURRENT QUESTION CARD */
        .current-question { background: var(--card-bg); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: flex-start; }
        #q-text { font-size: 1.5rem; font-weight: 700; color: var(--text-main); line-height: 1.4; }
        #q-type { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); background: #eef2ff; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 10px; }
        
        .answer-counter { text-align: center; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid var(--border); min-width: 80px; }
        .answer-counter strong { font-size: 2rem; display: block; color: var(--primary); line-height: 1; }
        .answer-counter span { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }

        /* ANSWERS GRID */
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .answer-card { background: var(--card-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .answer-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .answer-card strong { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; }
        .answer-card div { font-size: 1.1rem; font-weight: 600; color: var(--text-main); word-wrap: break-word; }

        /* MODAL */
        dialog { border: none; border-radius: 12px; padding: 0; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); width: 600px; max-width: 95%; background: var(--card-bg); }
        dialog::backdrop { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-header strong { font-size: 1.1rem; }
        .modal-body { padding: 25px; display: flex; flex-direction: column; gap: 15px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 20px 25px; border-top: 1px solid var(--border); background: #f8fafc; display: flex; justify-content: space-between; align-items: center; }

        /* INPUTS */
        input[type="text"], input[type="number"], select, input[type="file"] {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 0.95rem; background: white; color: var(--text-main); outline: none; transition: border-color 0.2s; box-sizing: border-box;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: var(--text-main); }

        /* Pending / Notification */
        .pending-header { padding: 10px 20px; font-size: 0.75rem; font-weight: 700; color: var(--warning); text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; background: #fffbeb; }
        .pending-row { padding: 12px 20px; background: #fffbeb; border-bottom: 1px solid #fef3c7; display: flex; justify-content: space-between; align-items: center; }
        .pending-code { font-family: monospace; font-size: 1.2rem; font-weight: 700; color: var(--warning); letter-spacing: 2px; }

        #notification-area { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 15px; z-index: 5000; pointer-events: none; }
        .toast { background: var(--text-main); color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; min-width: 300px; animation: slideIn 0.3s; pointer-events: auto; border-left: 4px solid var(--success); }
        .toast-code { font-family: monospace; font-size: 1.2rem; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; margin-left: 15px; }

        /* Login Overlay */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f1f5f9; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); text-align: center; width: 100%; max-width: 400px; }
        
        .dynamic-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .radio-correct { width: 20px; height: 20px; accent-color: var(--success); cursor: pointer; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0; color:var(--text-main);">üîí GM Login</h2>
            <input type="password" id="gm-password" placeholder="Passwort eingeben" style="text-align:center; font-size:1.2rem; letter-spacing:2px;" onkeyup="if(event.key === 'Enter') login()">
            <br><br>
            <button class="btn-primary" style="width:100%; padding:12px;" onclick="login()">Dashboard √∂ffnen</button>
            <p id="login-msg" class="login-error" style="color:var(--danger); display:none; margin-top:15px;">Falsches Passwort!</p>
        </div>
    </div>

    <div id="notification-area"></div>

    <div id="main-ui">
        <div class="sidebar">
            <div class="sidebar-header">
                TEILNEHMER
                <button class="btn-icon" onclick="resetAll()" title="Alles zur√ºcksetzen" style="color:var(--danger); border-color:var(--danger);">‚úï</button>
            </div>
            <div id="sidebar-list" class="sidebar-content"></div>
            <div class="sidebar-footer">
                <button class="btn-small" onclick="manualAddPlayer()">+ Spieler manuell hinzuf√ºgen</button>
            </div>
        </div>

        <div class="content">
            <div class="top-bar">
                <h1>Gamemaster <span id="game-id-display" style="font-size:0.8rem; font-weight:400; color:var(--text-muted); margin-left:10px;"></span></h1>
                <div class="gm-actions">
                    <button id="btn-close-vote" class="btn-warning" onclick="closeVote()" style="display:none;">üîí Voting schlie√üen</button>
                    <button id="btn-reveal" class="btn-success" onclick="reveal()" style="display:none; background:var(--success);">üëÅÔ∏è Aufl√∂sen</button>
                    <button class="btn-secondary" onclick="finishRoundPhase()">üèÅ Runde beenden</button>
                    <button class="btn-primary" onclick="openModal()">+ Neue Frage</button>
                </div>
            </div>

            <div class="current-question">
                <div style="flex:1;">
                    <span id="q-type">Warte auf Start...</span>
                    <h2 id="q-text" style="margin:10px 0 0 0;">Keine aktive Frage</h2>
                    
                    <div id="gm-image-wrapper" style="margin-top:15px; display:none;">
                        <img id="gm-image-display" src="" style="max-height:200px; max-width:100%; border-radius:8px; border:1px solid var(--border);">
                    </div>
                    <div id="gm-audio-wrapper" style="margin-top:15px; display:none;">
                        <audio id="gm-audio-player" controls style="width:100%;"></audio>
                    </div>
                </div>
                <div class="answer-counter">
                    <strong id="answer-count">0</strong>
                    <span>Antworten</span>
                </div>
            </div>

            <div class="answers-grid" id="answers-area"></div>
            
            <div id="offline-input-area" style="display:none; background:var(--card-bg); padding:25px; border-radius:12px; margin-top:20px; border:1px solid var(--border);">
                <h3 style="margin-top:0;">üìù Offline Ergebnisse eintragen</h3>
                <div id="offline-player-inputs" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;"></div>
                <button class="btn-primary" onclick="saveOfflineResults()">Ergebnisse Speichern</button>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <dialog id="q-modal">
        <div class="modal-header">
            <strong>Frage konfigurieren</strong>
            <button class="btn-icon" onclick="closeModal()" style="border:none;">‚úï</button>
        </div>
        <div class="modal-body">
            <label>Modus w√§hlen</label>
            <select id="m-type" onchange="updateModalFields()">
                <option value="MC">Multiple Choice</option>
                <option value="SEQUENCE">Reihenfolge (Sortieren)</option>
                <option value="ESTIMATE">Sch√§tzen (Zahl)</option>
                <option value="MATCHING">Zuordnen (Paare)</option>
                <option value="TEXT">Textantwort</option>
                <option value="PLAYER_VOTE">Voting: Wer verliert Leben?</option>
                <option value="OFFLINE_RESULTS">üìù Offline Ergebnisse erfassen</option>
            </select>

            <label>Fragetext / Titel</label>
            <input type="text" id="m-question" placeholder="z.B. Wie hoch ist der Eiffelturm?">

            <!-- MEDIA -->
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid var(--border);">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1;">
                        <label style="font-size:0.8rem; color:var(--text-muted);">Audio (URL oder Datei)</label>
                        <input type="text" id="m-audio-url" placeholder="https://..." style="margin-bottom:5px;">
                        <input type="file" id="m-audio-file" accept="audio/*" style="font-size:0.8rem;">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.8rem; color:var(--text-muted);">Bild (URL oder Datei)</label>
                        <input type="text" id="m-image-url" placeholder="https://..." style="margin-bottom:5px;">
                        <input type="file" id="m-image-file" accept="image/*" style="font-size:0.8rem;">
                    </div>
                </div>
            </div>

            <!-- SPECIAL OPTIONS -->
            <div style="display:flex; gap:10px;">
                <button class="btn-secondary btn-small" onclick="toggleStechen()">‚öîÔ∏è Zielgruppe einschr√§nken</button>
                <button class="btn-secondary btn-small" onclick="togglePowerVoter()">‚ö° Power Voter setzen</button>
            </div>
            
            <div id="stechen-area" style="display:none; background:#f8fafc; padding:10px; border-radius:6px;">
                <small style="display:block; margin-bottom:5px; font-weight:600;">Wer nimmt teil? (Leer = Alle)</small>
                <div class="player-check-grid" id="stechen-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:5px;"></div>
            </div>
            
            <div id="powervoter-area" style="display:none; background:#f8fafc; padding:10px; border-radius:6px;">
                <small style="display:block; margin-bottom:5px; font-weight:600;">Wer hat doppelte Stimme?</small>
                <div class="player-check-grid" id="powervoter-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:5px;"></div>
            </div>

            <!-- DYNAMIC INPUTS -->
            <div id="dynamic-area" style="border-top:1px solid var(--border); padding-top:15px;"></div>
            
            <div id="solution-area" class="correct-answer-section" style="display:none; border-top:1px solid var(--border); padding-top:15px;">
                <label class="correct-label" style="color:var(--success);">üí° Musterl√∂sung (f√ºr Aufl√∂sung)</label>
                <input type="text" id="m-correct-text" placeholder="Richtige Antwort eingeben...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-danger" onclick="startRound(true)" style="margin-right:auto;">‚ö†Ô∏è Neuer Runden-Block</button>
            <div style="display:flex; gap:10px;">
                <button class="btn-secondary" onclick="closeModal()">Abbrechen</button>
                <button class="btn-primary" onclick="startQuestion()">Frage Senden</button>
            </div>
        </div>
    </dialog>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentPlayers = {}; 
        function login() { const pw = document.getElementById('gm-password').value; socket.emit('gm_login', pw); }
        socket.on('gm_login_success', () => { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('main-ui').style.display = 'flex'; });
        socket.on('gm_login_fail', () => { document.getElementById('login-msg').style.display = 'block'; });
        socket.on('gm_player_joined', (data) => { const container = document.getElementById('notification-area'); const toast = document.createElement('div'); toast.className = 'toast'; toast.innerHTML = `<div><strong>${data.name}</strong><small>${data.isManual?'Manuell':'Beitritt'}</small></div><div class="toast-code">${data.code}</div>`; container.appendChild(toast); setTimeout(() => toast.remove(), 10000); });
        function manualAddPlayer() { const name = prompt("Name:"); if(name) socket.emit('gm_create_player', name); }
        function finishRoundPhase() { if(confirm("üèÅ Runde wirklich beenden?\n\n- Archiviert alle Fragen der aktuellen Phase\n- Leert die History\n- Startet 'Runde X+1'")) socket.emit('gm_next_round_phase'); }
        const gmAudio = document.getElementById('gm-audio-player');
        const gmAudioWrapper = document.getElementById('gm-audio-wrapper');
        const gmImageWrapper = document.getElementById('gm-image-wrapper');
        const gmImage = document.getElementById('gm-image-display');
        gmAudio.onplay = () => socket.emit('gm_audio_sync', { action: 'play', currentTime: gmAudio.currentTime });
        gmAudio.onpause = () => socket.emit('gm_audio_sync', { action: 'pause', currentTime: gmAudio.currentTime });
        gmAudio.onseeked = () => { if(gmAudio.paused) socket.emit('gm_audio_sync', { action: 'seek', currentTime: gmAudio.currentTime }); };
        const modal = document.getElementById('q-modal');
        function openModal() { updateModalFields(); generateStechenList(); generatePowerVoterList(); document.getElementById('stechen-area').style.display = 'none'; document.getElementById('powervoter-area').style.display = 'none'; modal.showModal(); }
        function closeModal() { modal.close(); }
        function toggleStechen() { const a=document.getElementById('stechen-area'); a.style.display = a.style.display==='none'?'block':'none'; }
        function togglePowerVoter() { const a=document.getElementById('powervoter-area'); a.style.display = a.style.display==='none'?'block':'none'; }
        function generateStechenList() { const c = document.getElementById('stechen-list'); c.innerHTML = ''; for (const [name, p] of Object.entries(currentPlayers)) { if(!p.isVerified) continue; c.innerHTML += `<label class="p-check-label" style="display:flex; align-items:center; gap:5px; font-size:0.9rem;"><input type="checkbox" value="${name}" class="stechen-check" checked> ${name}</label>`; } }
        function generatePowerVoterList() { const c = document.getElementById('powervoter-list'); c.innerHTML = ''; for (const [name, p] of Object.entries(currentPlayers)) { if(!p.isVerified) continue; c.innerHTML += `<label class="p-check-label" style="display:flex; align-items:center; gap:5px; font-size:0.9rem;"><input type="checkbox" value="${name}" class="powervoter-check"> ${name}</label>`; } }
        function updateModalFields() {
            const type = document.getElementById('m-type').value;
            const container = document.getElementById('dynamic-area');
            const solArea = document.getElementById('solution-area');
            const pvWrapper = document.getElementById('powervoter-wrapper');
            container.innerHTML = ''; solArea.style.display = 'none'; pvWrapper.style.display = 'none';
            if (type === 'MC') {
                container.innerHTML = `<span class="section-label">Antworten:</span><div id="mc-inputs"></div><button class="btn-small" onclick="addMCRow()">+ Option</button>`; addMCRow(); addMCRow(); addMCRow(); addMCRow();
            } else if (type === 'SEQUENCE') {
                container.innerHTML = `<span class="section-label">Reihenfolge:</span><div id="seq-inputs"></div><button class="btn-small" onclick="addInputRow('seq-inputs', 'Element...')">+ Element</button>`; addInputRow('seq-inputs', 'Element...'); addInputRow('seq-inputs', 'Element...');
            } else if (type === 'ESTIMATE' || type === 'TEXT') {
                if(type === 'ESTIMATE') container.innerHTML = `<span class="section-label">Bereich:</span><div class="dynamic-row"><input type="number" id="est-min" placeholder="Min"><input type="number" id="est-max" placeholder="Max"></div>`;
                solArea.style.display = 'block'; document.getElementById('m-correct-text').placeholder = type==='ESTIMATE' ? "Exakte Zahl (L√∂sung)" : "Musterl√∂sung (Text)";
            } else if (type === 'MATCHING') {
                container.innerHTML = `<span class="section-label">Paare:</span><div id="match-inputs"></div><button class="btn-small" onclick="addMatchPair()">+ Paar</button>`; addMatchPair(); addMatchPair();
            } else if (type === 'PLAYER_VOTE') {
                pvWrapper.style.display = 'block';
            } else if (type === 'OFFLINE_RESULTS') {
                container.innerHTML = `<div style="padding:15px; background:#f0fdf4; color:#166534; border:1px solid #bbf7d0; border-radius:8px;">‚ÑπÔ∏è Spieler sehen einen Warte-Screen. Du kannst die Punkte gleich direkt in der Hauptansicht eintragen.</div>`;
            }
        }
        function addMCRow() { const div = document.createElement('div'); div.className = 'dynamic-row'; div.innerHTML = `<input type="text" class="mc-text" placeholder="Antwort..."><input type="radio" name="mc_correct" class="radio-correct" title="Ist richtige Antwort">`; document.getElementById('mc-inputs').appendChild(div); }
        function addInputRow(parentId, placeholder) { const div = document.createElement('div'); div.className = 'dynamic-row'; div.innerHTML = `<input type="text" class="dyn-inp" placeholder="${placeholder}">`; document.getElementById(parentId).appendChild(div); }
        function addMatchPair() { const div = document.createElement('div'); div.className = 'dynamic-row'; div.innerHTML = `<input type="text" class="match-l" placeholder="Links (z.B. Land)"><input type="text" class="match-r" placeholder="Rechts (z.B. Stadt)">`; document.getElementById('match-inputs').appendChild(div); }
        async function startQuestion() {
            const type = document.getElementById('m-type').value;
            const text = document.getElementById('m-question').value;
            let qText = text;
            let options = []; let pairs = []; let min = 0; let max = 100; let targetPlayers = []; let correctAnswer = null; let audioData = null; let imageData = null; let powerVoter = [];
            const audioUrl = document.getElementById('m-audio-url').value.trim(); const audioFile = document.getElementById('m-audio-file').files[0];
            const imageUrl = document.getElementById('m-image-url').value.trim(); const imageFile = document.getElementById('m-image-file').files[0];
            if (audioUrl) audioData = audioUrl; else if (audioFile) { if (audioFile.size > 500000) { alert("Audio max 500KB"); return; } audioData = await toBase64(audioFile); }
            if (imageUrl) imageData = imageUrl; else if (imageFile) { if (imageFile.size > 1500000) { alert("Bild max 1.5MB"); return; } imageData = await toBase64(imageFile); }
            if (document.getElementById('stechen-area').style.display === 'block') { document.querySelectorAll('.stechen-check').forEach(cb => { if (cb.checked) targetPlayers.push(cb.value); }); if (targetPlayers.length === Object.keys(currentPlayers).filter(k=>currentPlayers[k].isVerified).length) targetPlayers = []; }
            if (type === 'MC') {
                document.querySelectorAll('#mc-inputs .dynamic-row').forEach(row => { const val = row.querySelector('.mc-text').value.trim(); if(val) { options.push(val); if(row.querySelector('.radio-correct').checked) correctAnswer = val; } });
                if(options.length < 2) { alert("Min 2 Optionen"); return; } if(!qText) qText = "W√§hle aus:";
            } else if (type === 'SEQUENCE') {
                document.querySelectorAll('#seq-inputs .dyn-inp').forEach(inp => { if(inp.value.trim()) options.push(inp.value.trim()); }); if(options.length < 2) { alert("Min 2 Elemente"); return; } if(!qText) qText = "Sortiere:"; correctAnswer = [...options];
            } else if (type === 'MATCHING') {
                const lefts = document.querySelectorAll('.match-l'); const rights = document.querySelectorAll('.match-r'); let pairObj = {};
                for(let i=0; i<lefts.length; i++) { if(lefts[i].value.trim()) { pairs.push({ left: lefts[i].value.trim(), right: rights[i].value.trim() }); pairObj[lefts[i].value.trim()] = rights[i].value.trim(); } }
                if(pairs.length < 2) { alert("Min 2 Paare"); return; } if(!qText) qText = "Ordne zu:"; correctAnswer = pairObj;
            } else if (type === 'ESTIMATE' || type === 'TEXT') {
                if(type === 'ESTIMATE') { min = document.getElementById('est-min').value; max = document.getElementById('est-max').value; if(min==='' || max==='') { alert("Min/Max!"); return; } if(!qText) qText = `Sch√§tze ${min}-${max}:`; }
                const enteredSol = document.getElementById('m-correct-text').value; if(enteredSol) correctAnswer = enteredSol;
            } else if (type === 'PLAYER_VOTE') {
                if(!qText) qText = 'Wer verliert ein Leben?';
                if (document.getElementById('powervoter-area').style.display === 'block') {
                    document.querySelectorAll('.powervoter-check').forEach(cb => { if (cb.checked) powerVoter.push(cb.value); });
                }
            } else if (type === 'OFFLINE_RESULTS') {
                if(!qText) qText = "Offline Ergebnisse";
            }
            socket.emit('gm_start_round', { type, question: qText, options, pairs, min, max, targetPlayers, correctAnswer, audioData, imageData, powerVoter });
            closeModal(); document.getElementById('m-question').value = ''; document.getElementById('m-correct-text').value = ''; document.getElementById('m-audio-url').value = ''; document.getElementById('m-audio-file').value = ''; document.getElementById('m-image-url').value = ''; document.getElementById('m-image-file').value = '';
        }
        function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }
        function closeVote() { socket.emit('gm_close_answering'); }
        function reveal() { socket.emit('gm_reveal'); }
        function resetAll() { if(confirm("üö® ALLES L√ñSCHEN?")) socket.emit('gm_reset_all'); }
        function saveOfflineResults() {
            const inputs = document.querySelectorAll('.offline-val');
            const answers = {};
            inputs.forEach(inp => { const user = inp.getAttribute('data-user'); if(inp.value.trim()) answers[user] = inp.value.trim(); });
            socket.emit('gm_set_bulk_answers', answers);
        }
        socket.on('gm_update_full', (data) => {
            currentPlayers = data.players; document.getElementById('game-id-display').innerText = `(${data.gameId})`;
            renderSidebar(data.players); renderMainArea(data.round, data.players);
        });
        function renderSidebar(players) {
            const list = document.getElementById('sidebar-list'); list.innerHTML = '';
            const active = []; const pending = []; for (const [name, p] of Object.entries(players)) { if(p.isVerified) active.push({name, ...p}); else pending.push({name, ...p}); }
            active.forEach(p => {
                const row = document.createElement('div'); row.className = 'player-row'; let nameHtml = `<div class="player-name">${p.name}</div>`;
                if(p.lives <= 0) { row.classList.add('eliminated'); nameHtml = `<div class="player-name">üíÄ ${p.name}</div>`; }
                const dotClass = p.hasAnswered ? 'status-dot active' : 'status-dot';
                row.innerHTML = `<div style="display:flex; align-items:center;"><span class="${dotClass}"></span><div>${nameHtml}<span class="player-code">${p.code}</span></div></div><div class="lives-control"><button class="btn-icon" onclick="modLife('${p.name}', -1)">-</button><span class="lives-count">${p.lives}</span><button class="btn-icon" onclick="modLife('${p.name}', 1)">+</button></div>`;
                list.appendChild(row);
            });
            if (pending.length > 0) { list.innerHTML += `<div class="pending-header">Beitrittsanfragen</div>`; pending.forEach(p => list.innerHTML += `<div class="pending-row"><div><strong>${p.name}</strong></div><div class="pending-code">${p.code}</div></div>`); }
        }
        function renderMainArea(round, players) {
            const btnClose = document.getElementById('btn-close-vote'); const btnReveal = document.getElementById('btn-reveal');
            if (round.type === 'WAITING' || round.revealed || round.type === 'OFFLINE_RESULTS') { btnClose.style.display = 'none'; btnReveal.style.display = 'none'; }
            else if (round.answeringOpen) { btnClose.style.display = 'inline-block'; btnReveal.style.display = 'none'; }
            else { btnClose.style.display = 'none'; btnReveal.style.display = 'inline-block'; }
            let qInfo = round.question || "Warte auf Start...";
            if (round.targetPlayers && round.targetPlayers.length > 0) qInfo += ` <span style="color:#e74c3c; font-size:0.8rem;">(Nur: ${round.targetPlayers.join(', ')})</span>`;
            if (round.audioData) { gmAudioWrapper.style.display = 'block'; if (gmAudio.dataset.src !== round.audioData) { gmAudio.src = round.audioData; gmAudio.dataset.src = round.audioData; } } else { gmAudioWrapper.style.display = 'none'; gmAudio.pause(); gmAudio.src = ""; gmAudio.dataset.src = ""; }
            if (round.imageData) { gmImageWrapper.style.display = 'block'; gmImage.src = round.imageData; } else { gmImageWrapper.style.display = 'none'; gmImage.src = ""; }
            document.getElementById('q-text').innerHTML = qInfo; document.getElementById('q-type').innerText = round.type;
            const grid = document.getElementById('answers-area'); grid.innerHTML = '';
            
            // OFFLINE RESULTS INPUT
            const offlineArea = document.getElementById('offline-input-area');
            if (round.type === 'OFFLINE_RESULTS' && !round.revealed) {
                offlineArea.style.display = 'block';
                const inputList = document.getElementById('offline-player-inputs');
                inputList.innerHTML = '';
                for(const [name, p] of Object.entries(players)) {
                    if(!p.isVerified) continue;
                    const val = p.answer || '';
                    inputList.innerHTML += `<div class="offline-input-row" style="display:flex; align-items:center; gap:10px;"><label style="width:100px;">${name}</label><input type="text" class="offline-val" data-user="${name}" value="${val}" placeholder="Punkte..."></div>`;
                }
            } else { offlineArea.style.display = 'none'; }

            if (round.revealed && round.correctAnswer) {
                let solText = JSON.stringify(round.correctAnswer);
                if (typeof round.correctAnswer === 'string' || typeof round.correctAnswer === 'number') solText = round.correctAnswer;
                else if (Array.isArray(round.correctAnswer)) solText = round.correctAnswer.join(" ‚Üí ");
                else if (typeof round.correctAnswer === 'object') { solText = ""; for(const[k,v] of Object.entries(round.correctAnswer)) solText += `${k}=${v}, `; }
                grid.innerHTML += `<div style="grid-column: 1/-1; background:#ecfdf5; color:#166534; padding:20px; border-radius:10px; border:1px solid #bbf7d0; margin-bottom:15px; display:flex; align-items:center; gap:10px;"><span style="font-size:1.5rem">üèÜ</span> <div><div style="font-size:0.8rem; text-transform:uppercase; font-weight:700;">Richtige Antwort</div><div style="font-size:1.2rem; font-weight:bold;">${solText}</div></div></div>`;
            }
            
            if (round.type === 'PLAYER_VOTE' && round.revealed) {
                // ... same logic as before for vote summary ...
                // Hier in den neuen Style integriert:
                const votes = {}; let maxVotes = 0;
                for (const [voterName, p] of Object.entries(players)) {
                    if (p.hasAnswered && p.answer) {
                        const target = p.answer; if (!votes[target]) votes[target] = 0;
                        let weight = 1; if (round.powerVoter && Array.isArray(round.powerVoter) && round.powerVoter.includes(voterName)) weight = 2;
                        votes[target] += weight; if (votes[target] > maxVotes) maxVotes = votes[target];
                    }
                }
                const sorted = Object.entries(votes).sort((a,b) => b[1] - a[1]);
                let summaryHtml = `<div style="grid-column: 1/-1; margin-bottom:15px; background:white; padding:15px; border-radius:10px; border:1px solid var(--border);"><h3>üìä Stimmverteilung</h3>`;
                sorted.forEach(([name, count]) => {
                    const isLeader = count === maxVotes;
                    const style = isLeader ? "background:#fef2f2; color:var(--danger); border:1px solid var(--danger);" : "background:#f8fafc; border:1px solid var(--border);";
                    const icon = isLeader ? "üíÄ " : "";
                    summaryHtml += `<div style="padding:10px; margin-bottom:5px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; ${style}"><strong>${icon}${name}</strong><span>${count} Stimmen</span></div>`;
                });
                summaryHtml += `</div>`;
                grid.innerHTML += summaryHtml;
            }

            let count = 0;
            for (const [name, p] of Object.entries(players)) {
                if (p.hasAnswered) count++;
                if (p.hasAnswered && p.answer) {
                    const card = document.createElement('div'); card.className = 'answer-card';
                    let displayAnswer = p.answer;
                    if (round.type === 'MATCHING' && typeof p.answer === 'object') {
                        displayAnswer = '<ul style="margin:0; padding-left:20px;">'; for(const [k, v] of Object.entries(p.answer)) displayAnswer += `<li>${k} ‚ûù <b>${v}</b></li>`; displayAnswer += '</ul>';
                    } else if (Array.isArray(p.answer)) displayAnswer = p.answer.join(" ‚Üí ");
                    if (round.type === 'PLAYER_VOTE') { card.style.borderLeft = "4px solid var(--danger)"; card.innerHTML = `<strong>${name} w√§hlt:</strong><div style="font-size:1.3rem">${p.answer}</div>`; }
                    else card.innerHTML = `<strong>${name}</strong><div style="font-size:1.1rem;">${displayAnswer}</div>`;
                    grid.appendChild(card);
                }
            }
            document.getElementById('answer-count').innerText = count;
        }
        function modLife(user, amount) { socket.emit('gm_modify_lives', { user, amount }); }
        setInterval(() => { fetch('/').catch(e => {}) }, 240000);
    </script>
</body>
</html>
