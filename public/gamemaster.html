<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Control</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f0f2f5; height: 100vh; display: flex; overflow: hidden; }
        
        /* LOGIN OVERLAY */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        
        /* LAYOUT */
        #main-ui { display: none; width: 100%; height: 100%; }
        
        /* SIDEBAR (SPIELER & LEBEN) */
        .sidebar { width: 300px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar-header { padding: 20px; background: #2c3e50; color: white; font-weight: bold; }
        .player-list { list-style: none; padding: 0; margin: 0; }
        .player-row { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .player-info { display: flex; flex-direction: column; }
        .player-name { font-weight: bold; font-size: 1.1rem; }
        .player-code { font-size: 0.8rem; color: #7f8c8d; font-family: monospace; background: #eee; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-top: 4px;}
        
        .lives-control { display: flex; align-items: center; gap: 5px; }
        .heart { color: #e74c3c; }
        .btn-mini { padding: 2px 8px; font-size: 0.8rem; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; }
        .btn-mini:hover { background: #eee; }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 10px; display: inline-block; }
        .status-dot.active { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; } /* Hat geantwortet */

        /* MAIN AREA */
        .content { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        
        .top-bar { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .btn-new-q { background: #3498db; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #2980b9; }
        .btn-new-q:active { transform: translateY(4px); box-shadow: none; }

        .current-question { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #3498db; }
        .current-question h2 { margin: 0 0 10px 0; color: #2c3e50; }
        .current-question p { margin: 0; color: #7f8c8d; font-style: italic; }

        .answers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .answer-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .answer-card strong { display: block; margin-bottom: 5px; color: #2c3e50; }
        .answer-val { font-size: 1.2rem; font-weight: bold; color: #3498db; }
        
        /* MODAL */
        dialog { border: none; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 400px; }
        dialog::backdrop { background: rgba(0,0,0,0.5); }
        .modal-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; }
        
        input, select { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .hidden { display: none; }

    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0;">üîí GM Login</h2>
            <input type="password" id="gm-password" placeholder="Passwort" onkeyup="if(event.key === 'Enter') login()">
            <br><br>
            <button class="btn-new-q" onclick="login()">Starten</button>
        </div>
    </div>

    <div id="main-ui">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                Teilnehmer & Leben
            </div>
            <ul class="player-list" id="sidebar-list">
                <!-- Dynamisch -->
            </ul>
        </div>

        <!-- MAIN -->
        <div class="content">
            <div class="top-bar">
                <h1>üéÆ Gamemaster</h1>
                <button class="btn-new-q" onclick="openModal()">+ Neue Frage / Runde</button>
            </div>

            <div class="current-question">
                <h2 id="q-text">Warte auf Rundenstart...</h2>
                <p id="q-type">Modus: Lobby</p>
            </div>

            <h3>Eingehende Antworten:</h3>
            <div class="answers-grid" id="answers-area">
                <!-- Antworten erscheinen hier -->
            </div>
        </div>
    </div>

    <!-- MODAL F√úR NEUE FRAGE -->
    <dialog id="q-modal">
        <div class="modal-header">
            <strong>Neue Runde starten</strong>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <label>Typ:</label>
            <select id="m-type" onchange="toggleModalFields()">
                <option value="MC">Multiple Choice (A/B/C/D)</option>
                <option value="TEXT">Textantwort</option>
                <option value="PLAYER_VOTE">Lebensfrage (Wer verliert?)</option>
            </select>

            <label>Frage / Anweisung:</label>
            <input type="text" id="m-question" placeholder="z.B. Wie hoch ist der Eiffelturm?">
        </div>
        <div class="modal-footer">
            <button class="btn-mini" onclick="closeModal()">Abbrechen</button>
            <button class="btn-new-q" style="font-size:0.9rem; padding: 8px 15px;" onclick="startRound()">Absenden</button>
        </div>
    </dialog>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let allPlayersData = {}; // Cache f√ºr Spielernamen bei Vote

        // --- LOGIN ---
        function login() { socket.emit('gm_login', document.getElementById('gm-password').value); }
        socket.on('gm_login_success', () => {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
        });

        // --- MODAL LOGIK ---
        const modal = document.getElementById('q-modal');
        function openModal() { modal.showModal(); }
        function closeModal() { modal.close(); }
        
        function startRound() {
            const type = document.getElementById('m-type').value;
            const text = document.getElementById('m-question').value;
            
            socket.emit('gm_start_round', { type: type, question: text });
            closeModal();
            document.getElementById('m-question').value = '';
        }

        // --- UPDATE LOGIK ---
        socket.on('gm_update_full', (data) => {
            allPlayersData = data.players;
            renderSidebar(data.players);
            renderMainArea(data.round, data.players);
        });

        function renderSidebar(players) {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';
            
            for (const [name, p] of Object.entries(players)) {
                const li = document.createElement('li');
                li.className = 'player-row';
                
                // Status Punkt (Gr√ºn wenn geantwortet)
                const dotClass = p.hasAnswered ? 'status-dot active' : 'status-dot';
                
                li.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span class="${dotClass}"></span>
                        <div class="player-info">
                            <span class="player-name">${name}</span>
                            <span class="player-code">${p.code}</span>
                        </div>
                    </div>
                    <div class="lives-control">
                        <button class="btn-mini" onclick="modLife('${name}', -1)">-</button>
                        <span style="font-weight:bold; width:20px; text-align:center;">${p.lives}</span>
                        <span class="heart">‚ù§Ô∏è</span>
                        <button class="btn-mini" onclick="modLife('${name}', 1)">+</button>
                    </div>
                `;
                list.appendChild(li);
            }
        }

        function renderMainArea(round, players) {
            // Header Update
            document.getElementById('q-text').innerText = round.question || "Keine aktive Frage";
            
            let typeText = "Lobby";
            if(round.type === 'MC') typeText = "Multiple Choice";
            if(round.type === 'TEXT') typeText = "Textantwort";
            if(round.type === 'PLAYER_VOTE') typeText = "Lebensfrage (Voting)";
            document.getElementById('q-type').innerText = typeText;

            // Antworten rendern
            const grid = document.getElementById('answers-area');
            grid.innerHTML = '';

            for (const [name, p] of Object.entries(players)) {
                if (p.hasAnswered && p.answer) {
                    const card = document.createElement('div');
                    card.className = 'answer-card';
                    card.innerHTML = `
                        <strong>${name}</strong>
                        <div class="answer-val">${p.answer}</div>
                    `;
                    grid.appendChild(card);
                }
            }
        }

        function modLife(user, amount) {
            socket.emit('gm_modify_lives', { user, amount });
        }

        // Keep Alive
        setInterval(() => { fetch('/').catch(e => {}) }, 240000);

    </script>
</body>
</html>
