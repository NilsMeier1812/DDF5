<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Control</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f0f2f5; height: 100vh; display: flex; overflow: hidden; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        
        #main-ui { display: none; width: 100%; height: 100%; }
        
        .sidebar { width: 320px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; position: relative; }
        .sidebar-header { padding: 20px; background: #2c3e50; color: white; font-weight: bold; flex-shrink: 0; }
        .sidebar-content { flex: 1; overflow-y: auto; }
        .sidebar-footer { padding: 10px; border-top: 1px solid #eee; text-align: center; background: #f9f9f9; }

        .player-row { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .player-name { font-weight: bold; font-size: 1rem; }
        /* Eliminated Style */
        .player-row.eliminated { background: #fbecec; opacity: 0.7; }
        .player-row.eliminated .player-name { text-decoration: line-through; color: #c0392b; }
        
        .player-code { font-size: 0.8rem; color: #7f8c8d; background: #eee; padding: 2px 5px; border-radius: 4px; font-family: monospace;}
        .lives-control { display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 10px; }
        .status-dot.active { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        .pending-header { background: #f39c12; color: white; font-size: 0.8rem; font-weight: bold; padding: 8px 15px; text-transform: uppercase; letter-spacing: 1px; margin-top: 20px;}
        .pending-row { background: #fffbf0; padding: 15px; border-bottom: 1px solid #fcefd0; display: flex; justify-content: space-between; align-items: center; }
        .pending-code { font-size: 1.4rem; font-family: monospace; font-weight: bold; color: #d35400; letter-spacing: 2px;}

        .content { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        .top-bar { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        
        .btn-new-q { background: #3498db; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        .btn-close-vote { background: #e67e22; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-right: 10px; }
        .btn-reveal { background: #f1c40f; color: #222; padding: 12px 25px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-right: 10px;}
        .btn-finish-round { background: #8e44ad; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-right: 10px; display: flex; align-items: center; gap: 5px; }

        .current-question { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #3498db; display: flex; justify-content: space-between; align-items: flex-start;}
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .answer-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; overflow-wrap: break-word;}
        
        #notification-area { position: fixed; bottom: 20px; right: 20px; width: 300px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #2c3e50; color: white; padding: 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s; pointer-events: all; border-left: 5px solid #f39c12; display: flex; justify-content: space-between; align-items: center;}
        .toast-code { font-family: monospace; font-size: 1.5rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; color: #2ecc71; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        dialog { border: none; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 700px; max-width: 95%; }
        dialog::backdrop { background: rgba(0,0,0,0.5); }
        .modal-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;}
        
        input, select { padding: 10px; width: 100%; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .dynamic-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        .dynamic-row input[type="text"] { flex: 1; }
        .radio-correct { width: 25px; height: 25px; cursor: pointer; accent-color: #2ecc71; }
        .correct-answer-section { border-top: 1px solid #eee; padding-top: 15px; margin-top: 10px; }
        .correct-label { display: block; font-weight: bold; color: #27ae60; margin-bottom: 5px; }
        .btn-add-opt { background: #eee; border: 1px solid #ccc; padding: 5px 10px; cursor: pointer; width: 100%; border-radius: 4px; margin-top: 5px;}
        .section-label { font-weight: bold; font-size: 0.9rem; margin-top: 10px; display: block; }
        .btn-reset-round { background: #c0392b; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: bold;}
        .btn-cancel { padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; }
        .btn-start { background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem;}
        .btn-mini { padding: 2px 8px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; }
        #stechen-area { border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-top: 10px; display: none; background: #fafafa; }
        .player-check-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 5px; margin-top: 5px; }
        .p-check-label { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; cursor: pointer; background: white; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
        .p-check-label input { width: auto; margin: 0; }
        .btn-danger-all { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>üîí GM Login</h2>
            <input type="password" id="gm-password" placeholder="Passwort" onkeyup="if(event.key === 'Enter') login()">
            <br><br>
            <button class="btn-new-q" onclick="login()">Einloggen</button>
        </div>
    </div>

    <!-- NOTIFICATION AREA -->
    <div id="notification-area"></div>

    <div id="main-ui">
        <div class="sidebar">
            <div class="sidebar-header" style="display:flex; justify-content:space-between; align-items:center;">
                Teilnehmer
                <button class="btn-danger-all" onclick="resetAll()">üî• RESET</button>
            </div>
            <div id="sidebar-list" class="sidebar-content"></div>
            <div class="sidebar-footer">
                <button class="btn-mini" onclick="manualAddPlayer()" style="width:100%; padding:8px;">+ Manueller Spieler (Code)</button>
            </div>
        </div>

        <div class="content">
            <div class="top-bar">
                <h1>Gamemaster <span id="game-id-display" style="font-size:0.8rem; color:#aaa; font-weight:normal;"></span></h1>
                <div style="display:flex; align-items:center;">
                    <button id="btn-close-vote" class="btn-close-vote" onclick="closeVote()">üîí Voting Schlie√üen</button>
                    <button id="btn-reveal" class="btn-reveal" onclick="reveal()">üëÅÔ∏è Aufl√∂sen</button>
                    <button class="btn-finish-round" onclick="finishRoundPhase()">üèÅ Runde beenden</button>
                    <button class="btn-new-q" onclick="openModal()">+ N√§chste Frage</button>
                </div>
            </div>

            <div class="current-question">
                <div style="flex:1;">
                    <h2 id="q-text" style="margin:0;">...</h2>
                    <p id="q-type" style="margin:5px 0 0 0; color:#777;">...</p>
                    
                    <!-- GM IMAGE DISPLAY -->
                    <div id="gm-image-wrapper" style="margin-top:15px; display:none;">
                        <img id="gm-image-display" src="" style="max-height:200px; max-width:100%; border-radius:5px; border:1px solid #ccc;">
                    </div>

                    <!-- GM AUDIO PLAYER -->
                    <div id="gm-audio-wrapper" style="margin-top:10px; display:none;">
                        <audio id="gm-audio-player" controls style="width:100%;"></audio>
                    </div>
                </div>
                <div style="text-align:right; margin-left:20px;">
                    <strong style="font-size:2rem; color:#3498db;" id="answer-count">0</strong>
                    <div style="font-size:0.8rem;">Antworten</div>
                </div>
            </div>

            <div class="answers-grid" id="answers-area"></div>
        </div>
    </div>

    <!-- MODAL -->
    <dialog id="q-modal">
        <div class="modal-header">
            <strong>Frage konfigurieren</strong>
            <button onclick="closeModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">&times;</button>
        </div>
        <div class="modal-body">
            <label><strong>Modus:</strong></label>
            <select id="m-type" onchange="updateModalFields()">
                <option value="MC">Multiple Choice</option>
                <option value="SEQUENCE">Reihenfolge (Sortieren)</option>
                <option value="ESTIMATE">Sch√§tzen (Zahl)</option>
                <option value="MATCHING">Zuordnen (Paare)</option>
                <option value="TEXT">Textantwort</option>
                <option value="PLAYER_VOTE">Voting: Wer verliert Leben?</option>
            </select>

            <label><strong>Frage / Titel:</strong></label>
            <input type="text" id="m-question" placeholder="Fragetext eingeben...">

            <!-- MEDIA SECTION -->
            <div style="background:#f0f8ff; padding:10px; border-radius:5px; border:1px solid #add8e6;">
                <label><strong>üéß Audio (Optional):</strong></label>
                <input type="text" id="m-audio-url" placeholder="URL (z.B. mp3 Link)">
                <div style="margin-top:5px; display:flex; align-items:center; gap:5px;">
                    <span style="font-size:0.8rem;">Oder Datei (Max 500KB):</span>
                    <input type="file" id="m-audio-file" accept="audio/*" style="font-size:0.8rem;">
                </div>
                
                <hr style="border:0; border-top:1px solid #d0e8f5; margin:10px 0;">

                <label><strong>üñºÔ∏è Bild (Optional):</strong></label>
                <input type="text" id="m-image-url" placeholder="URL (z.B. Bild Link)">
                <div style="margin-top:5px; display:flex; align-items:center; gap:5px;">
                    <span style="font-size:0.8rem;">Oder Datei (Max 1.5MB):</span>
                    <input type="file" id="m-image-file" accept="image/*" style="font-size:0.8rem;">
                </div>
            </div>

            <div style="margin-top:10px;">
                <button class="btn-mini" onclick="toggleStechen()">‚öîÔ∏è Stechen / Zielgruppe einschr√§nken</button>
                <div id="stechen-area">
                    <small>Wer soll die Frage bekommen? (Leer = Alle)</small>
                    <div class="player-check-grid" id="stechen-list"></div>
                </div>
            </div>

            <div id="dynamic-area"></div>
            
            <div id="solution-area" class="correct-answer-section" style="display:none;">
                <label class="correct-label">üí° Musterl√∂sung (wird beim Aufl√∂sen angezeigt):</label>
                <input type="text" id="m-correct-text" placeholder="Richtige Antwort eingeben...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-reset-round" onclick="startRound(true)">‚ö†Ô∏è Neue Spielrunde</button>
            <div style="display:flex; gap:10px;">
                <button class="btn-cancel" onclick="closeModal()">Abbrechen</button>
                <button class="btn-start" onclick="startQuestion()">Frage Starten</button>
            </div>
        </div>
    </dialog>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentPlayers = {}; 

        function login() { socket.emit('gm_login', document.getElementById('gm-password').value); }
        socket.on('gm_login_success', () => {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
        });

        socket.on('gm_player_joined', (data) => {
            const container = document.getElementById('notification-area');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<div><strong>${data.name}</strong><small>${data.isManual?'Manuell':'Beitritt'}</small></div><div class="toast-code">${data.code}</div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 10000);
        });

        function manualAddPlayer() {
            const name = prompt("Name:"); if(name) socket.emit('gm_create_player', name);
        }

        function finishRoundPhase() {
            if(confirm("üèÅ Runde wirklich beenden?\n\n- Archiviert alle Fragen der aktuellen Phase\n- Leert die History\n- Startet 'Runde X+1'")) {
                socket.emit('gm_next_round_phase');
            }
        }

        // AUDIO SYNC
        const gmAudio = document.getElementById('gm-audio-player');
        const gmAudioWrapper = document.getElementById('gm-audio-wrapper');
        const gmImageWrapper = document.getElementById('gm-image-wrapper');
        const gmImage = document.getElementById('gm-image-display');

        gmAudio.onplay = () => socket.emit('gm_audio_sync', { action: 'play', currentTime: gmAudio.currentTime });
        gmAudio.onpause = () => socket.emit('gm_audio_sync', { action: 'pause', currentTime: gmAudio.currentTime });
        gmAudio.onseeked = () => { if(gmAudio.paused) socket.emit('gm_audio_sync', { action: 'seek', currentTime: gmAudio.currentTime }); };

        const modal = document.getElementById('q-modal');
        function openModal() { updateModalFields(); generateStechenList(); document.getElementById('stechen-area').style.display = 'none'; modal.showModal(); }
        function closeModal() { modal.close(); }
        function toggleStechen() { const a=document.getElementById('stechen-area'); a.style.display = a.style.display==='none'?'block':'none'; }

        function generateStechenList() {
            const container = document.getElementById('stechen-list'); container.innerHTML = '';
            for (const [name, p] of Object.entries(currentPlayers)) {
                if(!p.isVerified) continue;
                container.innerHTML += `<label class="p-check-label"><input type="checkbox" value="${name}" class="stechen-check" checked> ${name}</label>`;
            }
        }

        function updateModalFields() {
            const type = document.getElementById('m-type').value;
            const container = document.getElementById('dynamic-area');
            const solArea = document.getElementById('solution-area');
            container.innerHTML = '';
            solArea.style.display = 'none';

            if (type === 'MC') {
                container.innerHTML = `<span class="section-label">Antworten (L√∂sung rechts markieren):</span><div id="mc-inputs"></div><button class="btn-add-opt" onclick="addMCRow()">+ Option</button>`;
                addMCRow(); addMCRow(); addMCRow(); addMCRow();
            } 
            else if (type === 'SEQUENCE') {
                container.innerHTML = `<span class="section-label">Korrekte Reihenfolge eingeben (wird gemischt):</span><div id="seq-inputs"></div><button class="btn-add-opt" onclick="addInputRow('seq-inputs', 'Element...')">+ Element</button>`;
                addInputRow('seq-inputs', 'Element...'); addInputRow('seq-inputs', 'Element...');
            }
            else if (type === 'ESTIMATE' || type === 'TEXT') {
                if(type === 'ESTIMATE') {
                    container.innerHTML = `<span class="section-label">Bereich:</span><div class="dynamic-row"><input type="number" id="est-min" placeholder="Min"><input type="number" id="est-max" placeholder="Max"></div>`;
                }
                solArea.style.display = 'block';
                document.getElementById('m-correct-text').placeholder = type==='ESTIMATE' ? "Exakte Zahl (L√∂sung)" : "Musterl√∂sung (Text)";
            }
            else if (type === 'MATCHING') {
                container.innerHTML = `<span class="section-label">Korrekte Paare (Links -> Rechts):</span><div id="match-inputs"></div><button class="btn-add-opt" onclick="addMatchPair()">+ Paar</button>`;
                addMatchPair(); addMatchPair();
            }
        }

        function addMCRow() {
            const div = document.createElement('div');
            div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="dyn-inp mc-text" placeholder="Antwort..."><input type="radio" name="mc_correct" class="radio-correct" title="Ist richtige Antwort">`;
            document.getElementById('mc-inputs').appendChild(div);
        }

        function addInputRow(parentId, placeholder) {
            const div = document.createElement('div');
            div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="dyn-inp" placeholder="${placeholder}">`;
            document.getElementById(parentId).appendChild(div);
        }

        function addMatchPair() {
            const div = document.createElement('div');
            div.className = 'dynamic-row';
            div.innerHTML = `<input type="text" class="match-l" placeholder="L"><input type="text" class="match-r" placeholder="R">`;
            document.getElementById('match-inputs').appendChild(div);
        }

        async function startQuestion() {
            const type = document.getElementById('m-type').value;
            const text = document.getElementById('m-question').value;
            let qText = text;
            
            let options = []; let pairs = []; let min = 0; let max = 100; let targetPlayers = [];
            let correctAnswer = null;
            let audioData = null;
            let imageData = null;

            // MEDIA PROCESSING
            const audioUrl = document.getElementById('m-audio-url').value.trim();
            const audioFile = document.getElementById('m-audio-file').files[0];
            const imageUrl = document.getElementById('m-image-url').value.trim();
            const imageFile = document.getElementById('m-image-file').files[0];

            if (audioUrl) audioData = audioUrl;
            else if (audioFile) {
                if (audioFile.size > 500000) { alert("Audio zu gro√ü! Max 500KB."); return; }
                audioData = await toBase64(audioFile);
            }

            if (imageUrl) imageData = imageUrl;
            else if (imageFile) {
                if (imageFile.size > 1500000) { alert("Bild zu gro√ü! Max 1.5MB."); return; }
                imageData = await toBase64(imageFile);
            }

            if (document.getElementById('stechen-area').style.display === 'block') {
                document.querySelectorAll('.stechen-check').forEach(cb => { if (cb.checked) targetPlayers.push(cb.value); });
                if (targetPlayers.length === Object.keys(currentPlayers).filter(k=>currentPlayers[k].isVerified).length) targetPlayers = [];
            }

            if (type === 'MC') {
                const rows = document.querySelectorAll('#mc-inputs .dynamic-row');
                rows.forEach(row => {
                    const val = row.querySelector('.mc-text').value.trim();
                    const isCorrect = row.querySelector('.radio-correct').checked;
                    if(val) { options.push(val); if(isCorrect) correctAnswer = val; }
                });
                if(options.length < 2) { alert("Min 2 Optionen"); return; }
                if(!qText) qText = "W√§hle aus:";
            }
            else if (type === 'SEQUENCE') {
                document.querySelectorAll('#seq-inputs .dyn-inp').forEach(inp => { if(inp.value.trim()) options.push(inp.value.trim()); });
                if(options.length < 2) { alert("Min 2 Elemente"); return; }
                if(!qText) qText = "Sortiere:";
                correctAnswer = [...options];
            }
            else if (type === 'MATCHING') {
                const lefts = document.querySelectorAll('.match-l'); const rights = document.querySelectorAll('.match-r');
                let pairObj = {};
                for(let i=0; i<lefts.length; i++) {
                    if(lefts[i].value.trim()) {
                        pairs.push({ left: lefts[i].value.trim(), right: rights[i].value.trim() });
                        pairObj[lefts[i].value.trim()] = rights[i].value.trim();
                    }
                }
                if(pairs.length < 2) { alert("Min 2 Paare"); return; }
                if(!qText) qText = "Ordne zu:";
                correctAnswer = pairObj;
            }
            else if (type === 'ESTIMATE' || type === 'TEXT') {
                if(type === 'ESTIMATE') {
                    min = document.getElementById('est-min').value; max = document.getElementById('est-max').value;
                    if(min==='' || max==='') { alert("Min/Max!"); return; }
                    if(!qText) qText = `Sch√§tze ${min}-${max}:`;
                }
                const enteredSol = document.getElementById('m-correct-text').value;
                if(enteredSol) correctAnswer = enteredSol;
            }
            else if (type === 'PLAYER_VOTE' && !qText) qText = 'Wer verliert ein Leben?';

            socket.emit('gm_start_round', { 
                type, question: qText, options, pairs, min, max, targetPlayers, correctAnswer, audioData, imageData
            });
            closeModal();
            document.getElementById('m-question').value = '';
            document.getElementById('m-correct-text').value = '';
            document.getElementById('m-audio-url').value = ''; document.getElementById('m-audio-file').value = '';
            document.getElementById('m-image-url').value = ''; document.getElementById('m-image-file').value = '';
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function closeVote() { socket.emit('gm_close_answering'); }
        function reveal() { socket.emit('gm_reveal'); }
        function resetAll() { if(confirm("üö® ALLES L√ñSCHEN?")) socket.emit('gm_reset_all'); }

        socket.on('gm_update_full', (data) => {
            currentPlayers = data.players;
            document.getElementById('game-id-display').innerText = `(${data.gameId})`;
            renderSidebar(data.players);
            renderMainArea(data.round, data.players);
        });

        function renderSidebar(players) {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';
            const active = []; const pending = [];
            for (const [name, p] of Object.entries(players)) { if(p.isVerified) active.push({name, ...p}); else pending.push({name, ...p}); }

            active.forEach(p => {
                const row = document.createElement('div'); 
                row.className = 'player-row';
                
                // Style f√ºr 0 Leben
                let nameHtml = `<div class="player-name">${p.name}</div>`;
                if(p.lives <= 0) {
                    row.classList.add('eliminated');
                    nameHtml = `<div class="player-name">üíÄ ${p.name}</div>`;
                }

                const dotClass = p.hasAnswered ? 'status-dot active' : 'status-dot';
                row.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span class="${dotClass}"></span>
                        <div>${nameHtml}<span class="player-code">${p.code}</span></div>
                    </div>
                    <div class="lives-control">
                        <button class="btn-mini" onclick="modLife('${p.name}', -1)">-</button>
                        <span style="min-width:30px; text-align:center;">${p.lives}‚ù§Ô∏è</span>
                        <button class="btn-mini" onclick="modLife('${p.name}', 1)">+</button>
                    </div>`;
                list.appendChild(row);
            });
            // ... pending code ...
        }
        }

        function renderMainArea(round, players) {
            const btnClose = document.getElementById('btn-close-vote');
            const btnReveal = document.getElementById('btn-reveal');
            
            if (round.type === 'WAITING' || round.revealed) {
                btnClose.style.display = 'none'; btnReveal.style.display = 'none';
            } else if (round.answeringOpen) {
                btnClose.style.display = 'inline-block'; btnReveal.style.display = 'none';
            } else {
                btnClose.style.display = 'none'; btnReveal.style.display = 'inline-block';
            }

            let qInfo = round.question || "Warte auf Start...";
            if (round.targetPlayers && round.targetPlayers.length > 0) qInfo += ` <span style="color:#e74c3c; font-size:0.8rem;">(Nur: ${round.targetPlayers.join(', ')})</span>`;
            
            // AUDIO PLAYER SETUP
            if (round.audioData) {
                gmAudioWrapper.style.display = 'block';
                if (gmAudio.dataset.src !== round.audioData) {
                    gmAudio.src = round.audioData;
                    gmAudio.dataset.src = round.audioData;
                }
            } else {
                gmAudioWrapper.style.display = 'none'; gmAudio.pause(); gmAudio.src = ""; gmAudio.dataset.src = "";
            }

            // IMAGE DISPLAY SETUP
            if (round.imageData) {
                gmImageWrapper.style.display = 'block';
                gmImage.src = round.imageData;
            } else {
                gmImageWrapper.style.display = 'none';
                gmImage.src = "";
            }

            document.getElementById('q-text').innerHTML = qInfo;
            document.getElementById('q-type').innerText = round.type;

            const grid = document.getElementById('answers-area');
            grid.innerHTML = '';

            if (round.revealed && round.correctAnswer) {
                let solText = JSON.stringify(round.correctAnswer);
                if (typeof round.correctAnswer === 'string' || typeof round.correctAnswer === 'number') solText = round.correctAnswer;
                else if (Array.isArray(round.correctAnswer)) solText = round.correctAnswer.join(" ‚Üí ");
                else if (typeof round.correctAnswer === 'object') {
                    solText = ""; for(const[k,v] of Object.entries(round.correctAnswer)) solText += `${k}=${v}, `;
                }
                grid.innerHTML += `<div style="grid-column: 1/-1; background:#d4edda; color:#155724; padding:15px; border-radius:8px; border:1px solid #c3e6cb; margin-bottom:10px;"><strong>üèÜ RICHTIGE ANTWORT:</strong> <span style="font-size:1.2rem; font-weight:bold;">${solText}</span></div>`;
            }

            let count = 0;
            for (const [name, p] of Object.entries(players)) {
                if (p.hasAnswered) count++;
                if (p.hasAnswered && p.answer) {
                    const card = document.createElement('div'); card.className = 'answer-card';
                    let displayAnswer = p.answer;
                    if (round.type === 'MATCHING' && typeof p.answer === 'object') {
                        displayAnswer = '<ul style="margin:0; padding-left:20px;">';
                        for(const [k, v] of Object.entries(p.answer)) displayAnswer += `<li>${k} ‚ûù <b>${v}</b></li>`;
                        displayAnswer += '</ul>';
                    } else if (Array.isArray(p.answer)) displayAnswer = p.answer.join(" ‚Üí ");
                    if (round.type === 'PLAYER_VOTE') { card.style.borderLeft = "5px solid #e74c3c"; card.innerHTML = `<strong>${name} w√§hlt:</strong><div style="font-size:1.5rem">${p.answer}</div>`; }
                    else card.innerHTML = `<strong>${name}</strong><div style="font-size:1.1rem; color:#3498db;">${displayAnswer}</div>`;
                    grid.appendChild(card);
                }
            }
            document.getElementById('answer-count').innerText = count;
        }

        function modLife(user, amount) { socket.emit('gm_modify_lives', { user, amount }); }
        setInterval(() => { fetch('/').catch(e => {}) }, 240000);
    </script>
</body>
</html>
