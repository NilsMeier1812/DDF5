<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiel-Auswertung</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-sidebar: #020617;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --primary: #6366f1;
            --border: #334155;
            --accent: #f43f5e;
            --success: #10b981;
        }

        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background: var(--bg-dark); color: var(--text-main); display: flex; height: 100vh; }
        
        /* SIDEBAR (GAME LIST) */
        .sidebar { width: 300px; background: var(--bg-sidebar); border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column;}
        .sidebar-header { padding: 25px; background: var(--bg-sidebar); color: var(--primary); text-align: center; font-weight: 800; border-bottom: 1px solid var(--border); letter-spacing: 1px; font-size: 1.1rem; }
        
        .game-item { padding: 18px 25px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s; position: relative; }
        .game-item:hover { background: #1e293b; }
        .game-item.active { background: #1e293b; border-left: 4px solid var(--primary); padding-left: 21px; }
        .game-date { font-size: 0.95rem; font-weight: 600; margin-bottom: 4px; color: var(--text-main); }
        .game-id { font-size: 0.75rem; color: var(--text-muted); font-family: monospace; display: flex; align-items: center; gap: 5px; }
        
        /* MAIN CONTENT */
        .content { flex: 1; padding: 50px; overflow-y: auto; max-width: 1200px; margin: 0 auto; box-sizing: border-box; }
        
        .header { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .header h1 { margin: 0 0 10px 0; font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; }
        .header-meta { color: var(--text-muted); font-size: 1rem; display: flex; gap: 20px; align-items: center; }
        
        /* ROUND BLOCK */
        .round-block { background: var(--card-bg); margin-bottom: 40px; border-radius: 16px; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .round-header { background: #334155; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .round-title { font-size: 1.3rem; font-weight: 700; color: var(--text-main); }
        .round-count { background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }
        
        /* LIVES DISPLAY */
        .lives-bar { display: flex; gap: 15px; padding: 20px 30px; background: #243042; overflow-x: auto; border-bottom: 1px solid var(--border); align-items: center; }
        .life-badge { background: #0f172a; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; border: 1px solid var(--border); font-weight: 600; white-space: nowrap; }
        .life-dead { opacity: 0.6; text-decoration: line-through; border-color: var(--accent); color: var(--accent); }
        
        /* QUESTIONS LIST */
        .questions-list { padding: 0; }
        .q-item { padding: 30px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .q-item:hover { background: #253146; }
        .q-item:last-child { border-bottom: none; }
        
        .q-meta { font-size: 0.75rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .q-text { font-size: 1.4rem; font-weight: 600; margin-bottom: 20px; color: var(--text-main); line-height: 1.4; }
        
        .q-correct { background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 10px 15px; border-radius: 8px; display: inline-block; margin-bottom: 20px; font-weight: 600; border: 1px solid rgba(16, 185, 129, 0.2); }
        
        /* ANSWERS GRID */
        .answers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .ans-card { background: #0f172a; padding: 15px; border-radius: 10px; border: 1px solid var(--border); }
        .ans-user { font-size: 0.8rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .ans-val { color: var(--text-main); font-weight: 500; font-size: 1.05rem; white-space: pre-wrap; line-height: 1.4; }
        
        .loading { text-align: center; color: var(--text-muted); margin-top: 100px; font-style: italic; font-size: 1.2rem; }
        .error-msg { text-align: center; color: var(--accent); margin-top: 50px; font-weight: bold; background: rgba(244, 63, 94, 0.1); padding: 20px; border-radius: 10px; display: inline-block; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">SPIEL-ARCHIV</div>
        <div id="game-list">
            <div class="loading" style="font-size:0.9rem; margin-top:20px;">Lade Spiele...</div>
        </div>
    </div>

    <div class="content" id="content-area">
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--text-muted); text-align:center;">
            <div style="font-size:4rem; margin-bottom:20px; opacity:0.2;">üìä</div>
            <h2 style="color:var(--text-main);">W√§hle ein Spiel aus der Liste</h2>
            <p>Klicke links auf ein Datum, um die Details zu laden.</p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // 1. Init: Liste anfordern
        socket.on('connect', () => {
            console.log("Verbunden. Lade Liste...");
            socket.emit('request_gamelist');
        });

        socket.on('receive_gamelist', (games) => {
            const list = document.getElementById('game-list');
            list.innerHTML = '';
            
            if(games.length === 0) {
                list.innerHTML = '<div style="padding:30px; color:#64748b; text-align:center; font-size:0.9rem;">Keine Spiele gefunden.</div>';
                return;
            }

            games.forEach((game, index) => {
                const el = document.createElement('div');
                el.className = 'game-item';
                
                let dateStr = "Unbekannt";
                try {
                    dateStr = new Date(game.date).toLocaleString('de-DE', { weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit' });
                } catch(e) {}

                el.innerHTML = `
                    <div class="game-date">${dateStr}</div>
                    <div class="game-id"><span>üÜî ${game.id}</span> <span>üë• ${game.playersCount}</span></div>
                `;
                el.onclick = () => loadGame(game.id, el);
                list.appendChild(el);
            });
        });

        function loadGame(gameId, element) {
            document.querySelectorAll('.game-item').forEach(e => e.classList.remove('active'));
            element.classList.add('active');
            
            document.getElementById('content-area').innerHTML = '<div class="loading">Lade Daten...</div>';
            
            socket.emit('request_game_details', gameId);
        }

        socket.on('receive_game_details', (data) => {
            renderGameDetails(data.meta, data.rounds);
        });

        socket.on('error_details', (msg) => {
            document.getElementById('content-area').innerHTML = `<div style="text-align:center;"><div class="error-msg">${msg}</div></div>`;
        });

        function renderGameDetails(meta, rounds) {
            const container = document.getElementById('content-area');
            const players = meta.players || {};
            const pCount = Object.keys(players).length;
            
            let dateStr = '-';
            try {
                if (meta.lastUpdated) dateStr = new Date(meta.lastUpdated).toLocaleString('de-DE', { dateStyle: 'full', timeStyle: 'short' });
            } catch (e) {}

            let html = `
                <div class="header">
                    <h1>Spiel vom ${dateStr}</h1>
                    <div class="header-meta">
                        <span>üÜî ${meta.gameId}</span>
                        <span>üë• ${pCount} Spieler</span>
                    </div>
                </div>
            `;

            if (!rounds || rounds.length === 0) {
                html += '<div style="text-align:center; color:#94a3b8; padding:40px; background:#1e293b; border-radius:12px; border:1px solid #334155;">Keine Runden-Daten verf√ºgbar (oder Spiel wurde resettet).</div>';
                container.innerHTML = html;
                return;
            }

            rounds.forEach(round => {
                let livesHtml = '';
                if (round.playerLives) {
                    for (const [name, lives] of Object.entries(round.playerLives)) {
                        const isDead = lives <= 0 ? 'life-dead' : '';
                        const heart = lives <= 0 ? 'üíÄ' : '‚ù§Ô∏è ' + lives;
                        livesHtml += `<div class="life-badge ${isDead}"><span>${name}</span> <span style="color:#e2e8f0;">${heart}</span></div>`;
                    }
                }

                let qHtml = '';
                if (round.questions) {
                    round.questions.forEach((q, qIndex) => {
                        let solHtml = '';
                        if (q.correctAnswer) {
                            let sol = formatVal(q.correctAnswer);
                            solHtml = `<div class="q-correct">L√∂sung: ${sol}</div>`;
                        }

                        let answersHtml = '';
                        if (q.answers) {
                            for (const [user, ans] of Object.entries(q.answers)) {
                                answersHtml += `
                                    <div class="ans-card">
                                        <div class="ans-user">${user}</div>
                                        <div class="ans-val">${formatVal(ans)}</div>
                                    </div>
                                `;
                            }
                        }

                        qHtml += `
                            <div class="q-item">
                                <div class="q-meta">Frage ${qIndex + 1} ‚Ä¢ ${q.type || 'TEXT'}</div>
                                <div class="q-text">${q.question || 'Frage ohne Text'}</div>
                                ${solHtml}
                                <div class="answers-grid">${answersHtml}</div>
                            </div>
                        `;
                    });
                } else {
                    qHtml = '<div style="padding:30px; text-align:center; color:#64748b; font-style:italic;">Keine Fragen in dieser Runde.</div>';
                }

                html += `
                    <div class="round-block">
                        <div class="round-header">
                            <span class="round-title">Runde ${round.roundId}</span>
                            <span class="round-count">${round.questions ? round.questions.length : 0} Fragen</span>
                        </div>
                        <div class="lives-bar">${livesHtml}</div>
                        <div class="questions-list">${qHtml}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function formatVal(val) {
            if (val === null || val === undefined) return '-';
            if (Array.isArray(val)) return val.join(' ‚ûù ');
            if (typeof val === 'object') {
                let s = ''; 
                for(const [k,v] of Object.entries(val)) s += `${k} ‚ûù ${v}\n`; 
                return s;
            }
            return val;
        }

    </script>
</body>
</html>
