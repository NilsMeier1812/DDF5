<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voting Pad</title>
    <style>
        /* ... (Same CSS as before) ... */
        :root { --bg-dark: #0f172a; --bg-card: #1e293b; --primary: #6366f1; --primary-active: #4f46e5; --accent: #f43f5e; --success: #10b981; --text-light: #f8fafc; --text-dim: #94a3b8; --border: #334155; }
        body { font-family: 'Inter', -apple-system, sans-serif; margin: 0; padding: 0; background: var(--bg-dark); color: var(--text-light); display: flex; height: 100vh; overflow: hidden; position: relative;}
        .sidebar { width: 280px; background: #020617; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; position: absolute; top: 0; left: 0; height: 100%; z-index: 500; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s ease; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header-row { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #0f172a; border-bottom: 1px solid var(--border); }
        .sidebar-header-row h3 { margin: 0; font-size: 0.9rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; }
        .btn-close-sidebar { background: none; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer; padding: 5px; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 400; display: none; backdrop-filter: blur(4px); }
        .sidebar-overlay.active { display: block; }
        @media (min-width: 768px) {
            .sidebar { position: relative; transform: none !important; box-shadow: none; width: 0; overflow: hidden; }
            .sidebar.open { width: 300px; border-right: 1px solid var(--border); }
            .sidebar-overlay.active { display: none !important; }
        }
        .p-item { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #0f172a; }
        .p-name { font-weight: 600; font-size: 1rem; color: var(--text-light); }
        .p-status { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--accent); }
        .answered-icon { width: 10px; height: 10px; background: var(--success); border-radius: 50%; display: none; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .answered-icon.visible { display: block; }
        .p-item.eliminated { opacity: 0.4; background: #000; }
        .p-item.eliminated .p-name { text-decoration: line-through; color: var(--text-dim); }
        .main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; position: relative; overflow-y: auto; width: 100%; box-sizing: border-box; }
        .q-header { margin-bottom: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 40px; }
        .sidebar-toggle { position: absolute; left: 20px; top: 20px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-light); cursor: pointer; padding: 10px; z-index: 50; border-radius: 10px; transition: all 0.2s; }
        .sidebar-toggle:hover { background: var(--border); }
        .round-indicator { color: var(--primary); font-size: 0.8rem; font-weight: 700; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; background: rgba(99, 102, 241, 0.1); padding: 5px 12px; border-radius: 20px; }
        .q-text { font-size: 1.4rem; font-weight: 700; line-height: 1.4; color: var(--text-light); text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin: 10px 0; }
        .mode-container { display: none; height: 100%; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; }
        .mode-container.active { display: flex; }
        .mc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex: 1; margin-bottom: 20px; align-content: center; }
        .btn-mc { border: none; border-radius: 16px; font-size: 1.3rem; font-weight: 700; color: white; cursor: pointer; padding: 30px 15px; min-height: 100px; word-wrap: break-word; transition: transform 0.1s, filter 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-mc:active { transform: scale(0.96); filter: brightness(0.9); }
        .text-input-wrapper { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        textarea { width: 100%; height: 150px; padding: 20px; font-size: 1.2rem; border-radius: 16px; border: 2px solid var(--border); background: var(--bg-card); color: white; resize: none; box-sizing: border-box; outline: none; font-family: inherit; }
        textarea:focus { border-color: var(--primary); }
        .btn-submit { background: var(--primary); color: white; padding: 20px; font-size: 1.2rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; width: 50%; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4); transition: background 0.2s; }
        .btn-submit:active { background: var(--primary-active); transform: translateY(2px); }
        .vote-list, .results-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; padding-bottom: 40px; }
        .vote-card, .result-card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        .vote-card-header { display: flex; justify-content: space-between; align-items: stretch; height: 60px; }
        .vote-name { flex: 1; display: flex; align-items: center; padding-left: 20px; font-weight: 600; font-size: 1.1rem; }
        .btn-inspect { background: transparent; border: none; border-left: 1px solid var(--border); color: var(--text-dim); padding: 0 20px; cursor: pointer; font-size: 1.2rem; transition: color 0.2s; }
        .btn-inspect:hover { color: white; background: rgba(255,255,255,0.05); }
        .btn-vote-action { background: var(--accent); border: none; color: white; padding: 0 25px; font-weight: 700; cursor: pointer; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .btn-vote-action:active { filter: brightness(0.8); }
        .result-card { padding: 15px; }
        .res-name { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 5px; }
        .res-val { font-size: 1.2rem; font-weight: 600; color: white; }
        .seq-item, .match-row { background: var(--bg-card); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .match-select { background: #0f172a; color: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); outline: none; width: 50%; }
        .btn-move { width: 40px; height: 40px; border-radius: 8px; border: none; background: #334155; color: white; cursor: pointer; margin-left: 5px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .btn-move:active { background: #475569; }
        .btn-move:disabled { opacity: 0.2; cursor: default; }
        .est-wrapper { display: flex; flex-direction: column; align-items: center; gap: 30px; margin-top: 40px; }
        .est-input { font-size: 3.5rem; width: 100%; text-align: center; background: transparent; color: var(--primary); border: none; border-bottom: 2px solid var(--border); padding: 10px; outline: none; font-weight: 700; }
        .est-range { width: 100%; -webkit-appearance: none; height: 6px; background: var(--border); border-radius: 3px; outline: none; }
        .est-range::-webkit-slider-thumb { -webkit-appearance: none; width: 25px; height: 25px; background: var(--primary); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #status-toast { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--success); color: #022c22; padding: 12px 25px; border-radius: 30px; font-weight: 700; display: none; z-index: 100; box-shadow: 0 10px 20px rgba(0,0,0,0.5); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        #locked-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); z-index: 90; display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center; backdrop-filter: blur(5px); }
        #locked-screen.visible { display: flex; }
        #spectator-screen, #eliminated-screen { text-align: center; padding: 40px; display: none; margin-top: 50px; }
        #spectator-screen.visible, #eliminated-screen.visible { display: block; animation: fadeIn 0.5s; }
        .correct-answer-card { background: #fefce8; color: #713f12; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; border: 2px solid #fde047; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .image-wrapper img { max-width: 100%; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .audio-wrapper { margin-bottom: 20px; background: var(--bg-card); padding: 15px; border-radius: 12px; display: none; border: 1px solid var(--border); }
        .audio-indicator { color: var(--success); font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .audio-indicator.inactive { color: var(--text-dim); }
        .offline-wait-msg { text-align: center; padding: 50px; color: var(--text-dim); font-style: italic; font-size: 1.1rem; }
    </style>
</head>
<body>
    <audio id="global-audio-player" playsinline></audio>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header-row"><h3>TEILNEHMER</h3><button class="btn-close-sidebar" onclick="toggleSidebar()">‚úï</button></div>
        <ul class="p-list" id="sidebar-list"></ul>
    </div>
    <div id="login-overlay">
        <h2 style="margin-bottom:30px; font-size:1.5rem; letter-spacing:1px; text-transform:uppercase; color:var(--primary);">Game Login</h2>
        <input type="tel" maxlength="4" class="code-input" id="player-code" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button class="btn-submit" onclick="submitLogin()">Beitreten</button>
        <p id="login-msg" style="color: var(--accent); margin-top: 20px; font-weight:bold; min-height:20px;"></p>
    </div>
    <div class="main-area">
        <div class="q-header">
            <button class="sidebar-toggle" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
            <div class="round-indicator" id="round-display">Runde 1</div>
            <div id="image-container" class="image-wrapper" style="display:none;"></div>
            <div id="audio-ui" class="audio-wrapper"><div class="audio-status-line"><div id="audio-state-text" class="audio-indicator inactive">üîá Warten...</div><div class="volume-control"><span>Vol</span><input type="range" min="0" max="1" step="0.1" value="1" oninput="setVolume(this.value)"></div></div><button id="btn-enable-audio" onclick="enableAudio()">üîä Audio aktivieren (Klicken!)</button></div>
            <div class="q-text" id="display-question">Warte auf Spielstart...</div>
        </div>
        <div id="status-toast">‚úÖ Antwort gesendet!</div>
        <div id="locked-screen"><div style="font-size:3rem;">üîí</div><h3>Voting beendet</h3></div>
        <div id="spectator-screen"><h2 style="color:var(--text-dim);">Nur Zuschauer</h2><p style="color:var(--text-dim);">Du nimmst an dieser Frage nicht teil.</p></div>
        <div id="eliminated-screen"><h2 style="color:var(--accent);">‚ùå Ausgeschieden</h2><p style="color:var(--text-dim);">Du hast keine Leben mehr.</p></div>
        <div id="mode-results" class="mode-container"><div id="correct-answer-display"></div><h3 style="text-align:center; margin-top:0; color:var(--text-dim); font-size:0.9rem; text-transform:uppercase; letter-spacing:1px;">Antworten der Spieler</h3><div class="results-list" id="results-container"></div></div>
        <div id="mode-offline" class="mode-container"><div class="offline-wait-msg"><h2>üëÄ Schau zum Gamemaster</h2><p>Ergebnisse werden eingetragen...</p></div></div>
        <div id="mode-mc" class="mode-container"><div class="mc-grid" id="mc-container"></div></div>
        <div id="mode-text" class="mode-container"><div class="text-input-wrapper"><textarea id="text-answer" placeholder="Deine Antwort eingeben..."></textarea><button class="btn-submit" onclick="sendText()">Absenden</button></div></div>
        <div id="mode-vote" class="mode-container"><p style="text-align:center; color:var(--text-dim); margin-top:0;">Wen m√∂chtest du w√§hlen?</p><div class="vote-list" id="vote-player-list"></div></div>
        <div id="mode-matching" class="mode-container"><div id="matching-container"></div><button class="btn-submit" style="margin-top:30px;" onclick="sendMatching()">Absenden</button></div>
        <div id="mode-sequence" class="mode-container"><div id="sequence-container"></div><button class="btn-submit" style="margin-top:30px;" onclick="sendSequence()">Best√§tigen</button></div>
        <div id="mode-estimate" class="mode-container"><div class="est-wrapper"><input type="number" id="est-val" class="est-input"><input type="range" id="est-slide" class="est-range" oninput="syncEst(this.value)"></div><button class="btn-submit" style="margin-top:40px;" onclick="sendEstimate()">Sch√§tzen</button></div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const rawName = window.location.pathname.split('/').pop();
        const username = decodeURIComponent(rawName);
        document.getElementById('welcome-name').innerText = username;
        let lastRoundSignature = ''; let currentHistory = []; let localGameId = null; const STORAGE_KEY = `voting_game_auth_${username}`;
        const audioPlayer = document.getElementById('global-audio-player');
        const audioUI = document.getElementById('audio-ui');
        const audioStatus = document.getElementById('audio-state-text');
        const btnEnableAudio = document.getElementById('btn-enable-audio');
        function setVolume(val) { audioPlayer.volume = val; }
        function enableAudio() { audioPlayer.play().then(() => { btnEnableAudio.style.display = 'none'; audioStatus.innerText = "üîä Audio bereit"; audioStatus.classList.remove('inactive'); }).catch(e => { console.log("Audio blockiert"); }); }
        function toggleSidebar() { const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay'); if(sb.classList.contains('open')) { sb.classList.remove('open'); ov.classList.remove('active'); } else { sb.classList.add('open'); ov.classList.add('active'); } }
        window.addEventListener('load', () => { if (window.innerWidth >= 768) { toggleSidebar(); } });
        socket.on('connect', () => { socket.emit('player_announce', username); const storedCode = localStorage.getItem(STORAGE_KEY); if (storedCode) setTimeout(() => socket.emit('player_login', { name: username, code: storedCode }), 100); });
        socket.on('audio_sync_command', (cmd) => {
            if (!audioPlayer.src) return;
            if (cmd.action === 'play') { audioPlayer.play().then(() => { audioStatus.innerText = "‚ñ∂Ô∏è Spielt ab..."; btnEnableAudio.style.display = 'none'; }).catch(error => { btnEnableAudio.style.display = 'block'; audioStatus.innerText = "üîá Blockiert (Klicken!)"; }); if (Math.abs(audioPlayer.currentTime - cmd.currentTime) > 0.5) audioPlayer.currentTime = cmd.currentTime; } 
            else if (cmd.action === 'pause') { audioPlayer.pause(); audioStatus.innerText = "‚è∏Ô∏è Pausiert (GM)"; } else if (cmd.action === 'seek') { audioPlayer.currentTime = cmd.currentTime; }
        });
        function submitLogin() { const code = document.getElementById('player-code').value; socket.emit('player_login', { name: username, code: code }); }
        socket.on('player_login_success', () => { document.getElementById('login-overlay').style.display = 'none'; const inputCode = document.getElementById('player-code').value; if (inputCode) localStorage.setItem(STORAGE_KEY, inputCode); });
        socket.on('player_login_fail', (msg) => { document.getElementById('login-msg').innerText = msg || "Falscher Code"; localStorage.removeItem(STORAGE_KEY); document.getElementById('login-overlay').style.display = 'flex'; });
        socket.on('update_game_state', (data) => {
            if (localGameId && localGameId !== data.gameId) { localStorage.removeItem(STORAGE_KEY); localGameId = data.gameId; document.getElementById('login-overlay').style.display = 'flex'; document.getElementById('player-code').value = ''; document.getElementById('login-msg').innerText = "Neues Spiel gestartet!"; socket.emit('player_announce', username); return; }
            localGameId = data.gameId;
            renderSidebar(data.players); currentHistory = data.history || []; document.getElementById('round-display').innerText = `Runde ${data.roundNumber}`;
            const round = data.round; const me = data.players[username];
            if (!me && document.getElementById('login-overlay').style.display === 'none') { socket.emit('player_announce', username); return; }
            if (document.getElementById('login-overlay').style.display !== 'none') return;
            if (me && me.lives <= 0) {
                hideAllModes(); document.getElementById('eliminated-screen').classList.add('visible'); document.getElementById('spectator-screen').classList.remove('visible'); document.getElementById('locked-screen').classList.remove('visible');
                if (round.revealed) { document.getElementById('eliminated-screen').classList.remove('visible'); switchMode('RESULTS', round, data.players); } return;
            } else { document.getElementById('eliminated-screen').classList.remove('visible'); }
            const isSpectator = round.targetPlayers && round.targetPlayers.length > 0 && !round.targetPlayers.includes(username);
            if (isSpectator && !round.revealed) { hideAllModes(); document.getElementById('spectator-screen').classList.add('visible'); document.getElementById('locked-screen').classList.remove('visible'); return; } else { document.getElementById('spectator-screen').classList.remove('visible'); }
            if (round.revealed) { document.getElementById('locked-screen').classList.remove('visible'); document.getElementById('status-toast').style.display = 'none'; switchMode('RESULTS', round, data.players); return; }
            if (!round.answeringOpen && round.type !== 'WAITING') { document.getElementById('locked-screen').classList.add('visible'); document.getElementById('status-toast').style.display = 'none'; return; } else { document.getElementById('locked-screen').classList.remove('visible'); }
            if (me && me.hasAnswered) document.getElementById('status-toast').style.display = 'block'; else document.getElementById('status-toast').style.display = 'none';
            const currentSignature = round.type + "::" + round.question + "::" + JSON.stringify(round.options || []) + "::" + (round.imageData ? "IMG" : "NOIMG") + "::" + (round.audioData ? "AUDIO" : "NOAUDIO");
            if (currentSignature !== lastRoundSignature) { lastRoundSignature = currentSignature; switchMode(round.type, round, data.players); } else { if (round.type === 'PLAYER_VOTE') renderPlayerCards(data.players); }
        });
        function renderSidebar(players) {
            const list = document.getElementById('sidebar-list'); list.innerHTML = '';
            for (const [name, p] of Object.entries(players)) { 
                const li = document.createElement('li'); if (p.lives <= 0) li.classList.add('eliminated'); li.className = p.lives <= 0 ? 'p-item eliminated' : 'p-item'; let hearts = p.lives <= 0 ? "‚ùå" : "‚ù§Ô∏è ".repeat(p.lives);
                li.innerHTML = `<div class="p-name">${name}</div><div class="p-status"><span class="answered-icon ${p.hasAnswered ? 'visible' : ''}"></span><span style="font-size:0.8rem;">${hearts}</span></div>`; list.appendChild(li); 
            }
        }
        function hideAllModes() { document.querySelectorAll('.mode-container').forEach(el => el.classList.remove('active')); }
        function switchMode(type, roundData, allPlayers) {
            hideAllModes(); document.getElementById('display-question').innerText = roundData.question || "Pause";
            const audioDiv = document.getElementById('audio-container');
            if (roundData.audioData) {
                audioUI.style.display = 'block'; const currentSrc = audioPlayer.getAttribute('data-src');
                if (currentSrc !== roundData.audioData) { audioPlayer.src = roundData.audioData; audioPlayer.setAttribute('data-src', roundData.audioData); audioPlayer.load(); audioStatus.innerText = "‚è≥ Audio geladen."; }
            } else { audioUI.style.display = 'none'; audioPlayer.pause(); audioPlayer.src = ""; audioPlayer.removeAttribute('data-src'); }
            const imageDiv = document.getElementById('image-container');
            if (roundData.imageData) { imageDiv.style.display = 'block'; imageDiv.innerHTML = `<img src="${roundData.imageData}" alt="Frage Bild">`; } else { imageDiv.style.display = 'none'; imageDiv.innerHTML = ''; }
            if (type === 'OFFLINE_RESULTS') {
                if (roundData.revealed) { document.getElementById('mode-results').classList.add('active'); renderResultsTable(allPlayers, roundData); } 
                else { document.getElementById('mode-offline').classList.add('active'); return; }
            } else if (type === 'RESULTS') { document.getElementById('mode-results').classList.add('active'); renderResultsTable(allPlayers, roundData);
            } else if (type === 'MC') { document.getElementById('mode-mc').classList.add('active'); const cont = document.getElementById('mc-container'); cont.innerHTML = ''; const colors = ['#e74c3c', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6']; roundData.options.forEach((opt, i) => { const btn = document.createElement('button'); btn.className = 'btn-mc'; btn.innerText = opt; btn.style.background = colors[i % colors.length]; if(i%colors.length === 1) btn.style.color = 'black'; btn.onclick = () => sendAnswer(opt); cont.appendChild(btn); });
            } else if (type === 'SEQUENCE') { document.getElementById('mode-sequence').classList.add('active'); renderSequence(roundData.options);
            } else if (type === 'ESTIMATE') { document.getElementById('mode-estimate').classList.add('active'); initEstimate(roundData.min, roundData.max);
            } else if (type === 'MATCHING') { document.getElementById('mode-matching').classList.add('active'); renderMatchingInterface(roundData.pairs, roundData.shuffledRight);
            } else if (type === 'TEXT') { document.getElementById('mode-text').classList.add('active'); document.getElementById('text-answer').value = ''; 
            } else if (type === 'PLAYER_VOTE') { document.getElementById('mode-vote').classList.add('active'); renderPlayerCards(allPlayers); }
        }
        function renderResultsTable(allPlayers, roundData) {
            const solDiv = document.getElementById('correct-answer-display');
            if (roundData.correctAnswer) {
                let txt = formatAnswer(roundData.correctAnswer);
                solDiv.innerHTML = `<div class="correct-answer-card"><strong>üèÜ L√ñSUNG:</strong><br>${txt}</div>`;
            } else solDiv.innerHTML = '';
            const cont = document.getElementById('results-container'); cont.innerHTML = '';
            for(const [name, p] of Object.entries(allPlayers)) {
                if(p.answer) {
                    let ans = formatAnswer(p.answer); let extras = "";
                    if(roundData.type === 'ESTIMATE' && roundData.correctAnswer) { const diff = Math.abs(Number(p.answer) - Number(roundData.correctAnswer)); extras = `<span style="color:#f43f5e; font-weight:bold;"> (Diff: ${diff})</span>`; }
                    cont.innerHTML += `<div class="result-card"><div class="res-name">${name}</div><div class="res-val">${ans} ${extras}</div></div>`;
                }
            }
        }
        function formatAnswer(val) { if (val === null || val === undefined) return '-'; if (Array.isArray(val)) return val.join(' ‚ûù '); if (typeof val === 'object') { let s = ''; for(const [k,v] of Object.entries(val)) s += `${k} ‚ûù ${v}\n`; return s; } return val; }
        function renderMatchingInterface(pairs, shuffledRight) { const container = document.getElementById('matching-container'); container.innerHTML = ''; const rightValues = shuffledRight || pairs.map(p => p.right).sort(() => Math.random() - 0.5); pairs.forEach(pair => { const row = document.createElement('div'); row.className = 'match-row'; let optionsHTML = '<option value="" disabled selected>-- W√§hlen --</option>'; rightValues.forEach(val => optionsHTML += `<option value="${val}">${val}</option>`); row.innerHTML = `<div class="match-label" data-left="${pair.left}">${pair.left}</div><select class="match-select">${optionsHTML}</select>`; container.appendChild(row); }); }
        function renderSequence(items) { const container = document.getElementById('sequence-container'); let currentItems = [...items]; const renderList = () => { container.innerHTML = ''; currentItems.forEach((item, index) => { const row = document.createElement('div'); row.className = 'seq-item'; const upDisabled = index === 0 ? 'disabled' : ''; const downDisabled = index === currentItems.length - 1 ? 'disabled' : ''; row.innerHTML = `<span>${item}</span><div class="seq-controls"><button class="btn-move" onclick="moveSeq(${index}, -1)" ${upDisabled}>‚ñ≤</button><button class="btn-move" onclick="moveSeq(${index}, 1)" ${downDisabled}>‚ñº</button></div>`; container.appendChild(row); }); }; window.moveSeq = (idx, dir) => { const temp = currentItems[idx]; currentItems[idx] = currentItems[idx + dir]; currentItems[idx + dir] = temp; renderList(); }; window.getSequenceData = () => currentItems; renderList(); }
        function initEstimate(min, max) { const inp = document.getElementById('est-val'); const sli = document.getElementById('est-slide'); inp.min = min; inp.max = max; inp.value = ''; sli.min = min; sli.max = max; sli.value = min; window.syncEst = (val) => { inp.value = val; }; inp.oninput = () => { sli.value = inp.value; }; }
        function renderPlayerCards(players) { const container = document.getElementById('vote-player-list'); container.innerHTML = ''; let count = 0; for (const name in players) { if(name === username) continue; if(players[name].lives <= 0) continue; count++; let historyHTML = ''; if (!currentHistory || currentHistory.length === 0) { historyHTML = '<div class="history-item" style="color:#666">Keine Fragen bisher in dieser Runde.</div>'; } else { currentHistory.forEach((roundData, index) => { let ans = formatAnswer(roundData.answers[name]); historyHTML += `<div class="history-item"><span class="h-q">${index+1}. ${roundData.question}</span><br><span class="h-a">${ans}</span></div>`; }); } const card = document.createElement('div'); card.className = 'vote-card'; card.innerHTML = `<div class="vote-card-header"><div class="vote-name">${name}</div><button class="btn-inspect" onclick="toggleHistory(this)">üëÅÔ∏è</button><button class="btn-vote-action" onclick="sendAnswer('${name}')">VOTE</button></div><div class="vote-history">${historyHTML}</div>`; container.appendChild(card); } if(count === 0) { container.innerHTML = `<div style="text-align:center; color:#666; padding:20px;">Keine Gegner mehr √ºbrig...<br>(Du hast wohl gewonnen?)</div>`; } }
        window.toggleHistory = function(btn) { const h = btn.parentElement.nextElementSibling; if (h.classList.contains('show')) { h.classList.remove('show'); btn.style.background="#444"; } else { h.classList.add('show'); btn.style.background="#555"; } };
        function sendAnswer(val) { socket.emit('submit_answer', { user: username, answer: val }); }
        function sendText() { const val = document.getElementById('text-answer').value; if(val.trim()) sendAnswer(val); }
        function sendEstimate() { const val = document.getElementById('est-val').value; if(val!=='') sendAnswer(Number(val)); }
        function sendSequence() { socket.emit('submit_answer', { user: username, answer: window.getSequenceData() }); }
        function sendMatching() { const result = {}; let complete = true; document.querySelectorAll('.match-row').forEach(row => { const l = row.querySelector('.match-label').getAttribute('data-left'); const r = row.querySelector('.match-select').value; if(!r) complete = false; result[l] = r; }); if(!complete) alert("Bitte alles zuordnen"); else sendAnswer(result); }
        socket.on('answer_confirmed', () => { const t = document.getElementById('status-toast'); t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000); });
    </script>
</body>
</html>
