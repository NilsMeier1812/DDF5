<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voting Pad</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --accent-color: #3b82f6; /* Modern Blue */
            --accent-hover: #2563eb;
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; position: relative; }
        * { box-sizing: border-box; }

        /* --- TOP LOGO --- */
        .top-logo {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 70px;
            height: auto;
            z-index: 600; /* Higher than sidebar toggle but below overlays */
            pointer-events: none;
        }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 280px; background: #18181b; border-right: 1px solid #27272a; 
            display: flex; flex-direction: column; position: fixed; top: 0; left: 0; height: 100%; z-index: 500;
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header-row { padding: 20px; background: #27272a; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header-row h3 { margin: 0; color: var(--text-main); font-size: 0.9rem; letter-spacing: 1.5px; }
        .btn-close-sidebar { background: none; border: none; color: var(--text-main); font-size: 1.5rem; cursor: pointer; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 400; display: none; backdrop-filter: blur(4px); }
        .sidebar-overlay.active { display: block; }
        
        /* Liste der Spieler in Sidebar */
        .p-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .p-item { padding: 15px 20px; border-bottom: 1px solid #27272a; display: flex; justify-content: space-between; align-items: center; }
        .p-name { font-weight: 600; font-size: 0.95rem; }
        .p-status { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-muted); }
        .answered-icon { width: 10px; height: 10px; background: var(--success-color); border-radius: 50%; display: none; box-shadow: 0 0 8px var(--success-color); }
        .answered-icon.visible { display: block; }
        .p-item.eliminated .p-name { text-decoration: line-through; color: var(--danger-color); }

        /* Desktop Sidebar fix */
        @media (min-width: 768px) {
            .sidebar { position: relative; transform: none; width: 0; box-shadow: none; border: none; }
            .sidebar.open { width: 280px; border-right: 1px solid #333; }
            .sidebar-overlay.active { display: none !important; }
        }

        /* --- MAIN AREA --- */
        .main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; position: relative; overflow-y: auto; width: 100%; transition: width 0.3s; max-width: 800px; margin: 0 auto; }
        
        /* Header & Question */
        .sidebar-toggle { 
            position: absolute; left: 20px; top: 20px; background: var(--card-color); border: 1px solid #333; 
            color: var(--text-main); border-radius: 8px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; transition: 0.2s; 
        }
        .sidebar-toggle:hover { background: #333; }
        .sidebar-toggle svg { width: 20px; height: 20px; }

        .q-header { margin-top: 40px; margin-bottom: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        
        .header-meta { display: flex; gap: 10px; align-items: center; }
        .round-indicator { color: var(--accent-color); font-size: 0.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; background: rgba(59, 130, 246, 0.1); padding: 5px 12px; border-radius: 20px; }
        .timer-display { color: #22c55e; font-family: monospace; font-size: 1rem; font-weight: bold; background: #111; padding: 4px 10px; border-radius: 6px; border: 1px solid #333; }

        .q-text { 
            font-size: 1.4rem; line-height: 1.4; font-weight: 700; background: var(--card-color); 
            padding: 25px; border-radius: var(--radius); border: 1px solid #333; 
            width: 100%; box-shadow: var(--shadow); text-align: center;
        }

        /* --- LOGIN OVERLAY --- */
        #login-overlay { 
            position: fixed; inset: 0; background: var(--bg-color); z-index: 2000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; 
        }
        #login-overlay h2 { margin-bottom: 5px; font-size: 2rem; }
        .code-input { 
            font-size: 2.5rem; padding: 15px; text-align: center; width: 200px; 
            background: #000; border: 2px solid #333; color: var(--accent-color); 
            border-radius: 12px; margin: 30px 0; letter-spacing: 8px; font-family: monospace; outline: none; transition: border 0.2s;
        }
        .code-input:focus { border-color: var(--accent-color); }
        
        /* GLOBAL BUTTONS */
        .btn-submit { 
            background: var(--accent-color); color: white; padding: 16px 40px; font-size: 1.1rem; border: none; 
            border-radius: 12px; cursor: pointer; font-weight: 600; width: 100%; max-width: 300px; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); transition: transform 0.1s, box-shadow 0.2s; 
        }
        .btn-submit:active { transform: scale(0.98); }

        /* --- MODES --- */
        .mode-container { display: none; flex-direction: column; gap: 20px; width: 100%; }
        .mode-container.active { display: flex; }

        /* MC Grid */
        .mc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .btn-mc { 
            border: none; border-radius: var(--radius); font-size: 1.1rem; font-weight: 700; color: white; 
            cursor: pointer; padding: 20px; min-height: 100px; display: flex; align-items: center; justify-content: center; text-align: center;
            box-shadow: var(--shadow); transition: filter 0.2s, transform 0.1s;
        }
        .btn-mc:active { transform: scale(0.96); filter: brightness(0.8); }

        /* Inputs */
        textarea { 
            width: 100%; height: 140px; padding: 20px; font-size: 1.1rem; background: var(--card-color); 
            color: white; border: 1px solid #333; border-radius: var(--radius); outline: none; resize: none; 
        }
        textarea:focus { border-color: var(--accent-color); }
        
        .list-input {
            width: 100%; padding: 15px; font-size: 1.1rem; background: var(--card-color);
            color: white; border: 1px solid #333; border-radius: 8px; outline: none; margin-bottom: 10px;
        }
        .list-input:focus { border-color: var(--accent-color); }

        /* Voting List */
        .vote-card { background: var(--card-color); border-radius: 12px; padding: 5px; display: flex; flex-direction: column; border: 1px solid #333; }
        .vote-card-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        .vote-name { font-weight: bold; font-size: 1.1rem; }
        .btn-inspect { background: #333; border: none; color: #ccc; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; margin-right: 10px;}
        .btn-vote-action { background: var(--danger-color); border: none; color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .vote-history { background: #111; padding: 15px; display: none; border-top: 1px solid #333; font-size: 0.9rem; }
        .vote-history.show { display: block; }

        /* Matching & Sequence */
        .match-row, .seq-item { background: var(--card-color); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .match-select { background: #000; color: white; padding: 10px; border: 1px solid #444; border-radius: 6px; width: 50%; }
        .btn-move { background: #333; color: white; border: none; width: 36px; height: 36px; border-radius: 6px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;}

        /* Estimates */
        .est-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 20px; background: var(--card-color); border-radius: var(--radius); }
        .est-input { font-size: 3rem; width: 100%; text-align: center; background: transparent; border: none; color: var(--accent-color); font-weight: bold; outline: none; }
        .est-range { width: 100%; accent-color: var(--accent-color); height: 6px; }

        /* Results & Status */
        .result-card { background: var(--card-color); padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent-color); display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; animation: fadeIn 0.5s; }
        .res-val { font-weight: bold; font-size: 1.1rem; }
        .correct-answer-card { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid #22c55e; padding: 20px; border-radius: var(--radius); text-align: center; margin-bottom: 20px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Overlays */
        #locked-screen, #spectator-screen, #eliminated-screen { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; 
            display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 30px; 
        }
        #locked-screen.visible, #spectator-screen.visible, #eliminated-screen.visible { display: flex; }
        
        /* STATUS PROGRESS */
        #status-progress {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #333; color: #ccc;
            padding: 12px 25px; border-radius: 30px;
            font-weight: bold; font-size: 1.1rem;
            display: none; z-index: 200; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            border: 1px solid #444;
            transition: background 0.3s, color 0.3s, transform 0.2s;
            white-space: nowrap;
        }
        #status-progress.done { background: var(--success-color); color: black; border-color: var(--success-color); }

        /* Audio/Image */
        .image-wrapper img { max-width: 100%; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid #333; max-height: 300px; object-fit: contain; background: black; }
        .image-hidden-placeholder { width: 100%; padding: 40px; background: #222; border: 1px dashed #444; border-radius: 12px; text-align: center; color: #666; font-weight: bold; }
        
        .audio-wrapper { width: 100%; background: #222; padding: 15px; border-radius: 12px; display: none; margin-bottom: 15px; border: 1px solid #333; }
        #btn-enable-audio { width: 100%; padding: 10px; background: #ea580c; border: none; color: white; border-radius: 6px; margin-top: 10px; cursor: pointer; }
        
        /* YouTube Embed */
        .video-responsive { overflow:hidden; padding-bottom:56.25%; position:relative; height:0; border-radius: 12px; border: 1px solid #333; box-shadow: var(--shadow); }
        .video-responsive iframe { left:0; top:0; height:100%; width:100%; position:absolute; }

        /* INPUT BLOCK OVERLAY */
        #input-blocked-msg {
            display: none;
            text-align: center;
            padding: 30px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #dc2626;
            color: #fca5a5;
            border-radius: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <audio id="global-audio-player" playsinline></audio>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- LOGO (New) -->
    <img src="/DDF_5_Logo_Staffel_5_transparent.png" alt="DDF Logo" class="top-logo">

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header-row">
            <h3>TEILNEHMER</h3>
            <button class="btn-close-sidebar" onclick="toggleSidebar()">‚úï</button>
        </div>
        <ul class="p-list" id="sidebar-list"></ul>
    </div>

    <!-- Login -->
    <div id="login-overlay">
        <h2 style="color: var(--text-muted); font-size: 1rem; text-transform: uppercase; letter-spacing: 2px;">Willkommen</h2>
        <h1 id="welcome-name" style="margin: 0 0 20px 0;">Spieler</h1>
        <p style="color:#666;">Bitte Code eingeben:</p>
        <input type="tel" maxlength="4" class="code-input" id="player-code" placeholder="0000">
        <button class="btn-submit" onclick="submitLogin()">STARTEN</button>
        <p id="login-msg" style="color: var(--danger-color); margin-top: 20px; font-weight:bold;"></p>
    </div>

    <div class="main-area">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <div class="q-header">
            <div class="header-meta">
                <div class="round-indicator" id="round-display">Runde 1</div>
                <div class="timer-display" id="timer-display">00:00</div>
            </div>
            
            <div id="image-container" class="image-wrapper" style="display:none;"></div>
            
            <div id="audio-ui" class="audio-wrapper">
                <div class="audio-status-line" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                    <div id="audio-state-text" style="color: var(--accent-color); font-weight: bold;">üîá Warten...</div>
                    <div class="volume-control" style="display: flex; gap: 5px; align-items: center;">
                        <span>Vol</span>
                        <input type="range" min="0" max="1" step="0.1" value="1" oninput="setVolume(this.value)" style="width: 80px;">
                    </div>
                </div>
                <button id="btn-enable-audio" onclick="enableAudio()">üîä Audio aktivieren</button>
            </div>

            <div class="q-text" id="display-question">Warte auf Start...</div>
        </div>
        
        <!-- YOUTUBE PLAYER CONTAINER -->
        <div id="video-container" style="display:none; width:100%; margin-bottom: 20px;">
             <div class="video-responsive">
                 <iframe id="yt-iframe" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
             </div>
        </div>

        <!-- STATUS BAR -->
        <div id="status-progress">0/0 abgegeben</div>
        
        <!-- Status Screens -->
        <div id="locked-screen">
            <div style="font-size:4rem; margin-bottom: 10px;">üîí</div>
            <h3>Abstimmung geschlossen</h3>
            <p style="color: #888;">Bitte auf Gamemaster warten</p>
        </div>
        
        <div id="spectator-screen">
            <div style="font-size:4rem; margin-bottom: 10px;">üëÄ</div>
            <h2>Zuschauer</h2>
            <p>Du nimmst an dieser speziellen Frage nicht teil.</p>
        </div>
        
        <div id="eliminated-screen">
            <div style="font-size:4rem; margin-bottom: 10px;">üíÄ</div>
            <h2 style="color: var(--danger-color);">Ausgeschieden</h2>
            <p>Leider keine Leben mehr.</p>
        </div>

        <!-- BLOCKED MSG -->
        <div id="input-blocked-msg">
            <h3 style="margin:0;">‚õî Eingabe gesperrt</h3>
            <p style="margin:5px 0 0 0;">Schau auf das Bild / die Infos oben.</p>
        </div>

        <!-- MODES -->
        <!-- Results -->
        <div id="mode-results" class="mode-container">
            <div id="correct-answer-display"></div>
            <h3 id="result-title" style="text-align:center; margin: 10px 0; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase;">Antworten der Spieler</h3>
            <div class="results-list" id="results-container" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>
        
        <!-- Offline Waiting -->
        <div id="mode-offline" class="mode-container">
            <div style="text-align: center; padding: 40px; background: var(--card-color); border-radius: 12px; border: 1px dashed #444;">
                <h2 style="margin-top:0;">Manuelle Auswertung</h2>
                <p style="color: #aaa;">Der Gamemaster tr√§gt die Ergebnisse gerade ein.</p>
            </div>
        </div>
        
        <!-- Stream Mode (Empty Container mostly, video is above) -->
        <div id="mode-stream" class="mode-container">
            <div style="text-align: center; padding: 20px; color:#888;">
                <p>Live Video</p>
            </div>
        </div>
        
        <!-- INFO MODE -->
        <div id="mode-info" class="mode-container">
            <div style="text-align: center; padding: 20px; color:#aaa; font-style:italic;">
                <p>Lies die Informationen auf dem Bildschirm.</p>
            </div>
        </div>

        <!-- Inputs -->
        <div id="mode-mc" class="mode-container">
            <div class="mc-grid" id="mc-container"></div>
        </div>

        <div id="mode-text" class="mode-container">
            <textarea id="text-answer" placeholder="Deine Antwort hier eingeben..."></textarea>
            <button class="btn-submit" onclick="sendText()" style="width:100%; max-width:100%;">Absenden</button>
        </div>
        
        <div id="mode-list" class="mode-container">
            <div id="list-inputs-container"></div>
            <button class="btn-submit" onclick="sendList()" style="width:100%; max-width:100%; margin-top:10px;">Liste Absenden</button>
        </div>
        
        <div id="mode-vote" class="mode-container">
            <p style="text-align:center; color:#aaa; margin-top:0;">W√§hle einen Spieler:</p>
            <div id="vote-player-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>
        
        <div id="mode-matching" class="mode-container">
            <div id="matching-container"></div>
            <button class="btn-submit" onclick="sendMatching()" style="width:100%; max-width:100%; margin-top: 10px;">Zuordnung Absenden</button>
        </div>

        <div id="mode-sequence" class="mode-container">
            <div id="sequence-container"></div>
            <button class="btn-submit" onclick="sendSequence()" style="width:100%; max-width:100%; margin-top: 10px;">Reihenfolge Best√§tigen</button>
        </div>
        
        <div id="mode-estimate" class="mode-container">
            <div class="est-wrapper">
                <input type="number" id="est-val" class="est-input" readonly>
                <input type="range" id="est-slide" class="est-range" oninput="syncEst(this.value)">
                <p style="margin:0; color:#666; font-size:0.8rem;">Schiebe den Regler</p>
            </div>
            <button class="btn-submit" onclick="sendEstimate()" style="align-self: center;">Wert sch√§tzen</button>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const rawName = window.location.pathname.split('/').pop();
        const username = decodeURIComponent(rawName);
        document.getElementById('welcome-name').innerText = username;
        
        let lastRoundSignature = ''; 
        let currentHistory = []; 
        let localGameId = null; 
        
        // Timer Globals
        let roundStartTime = null;
        let roundEndTime = null;

        const STORAGE_KEY = `voting_game_auth_${username}`;
        
        const audioPlayer = document.getElementById('global-audio-player');
        const audioUI = document.getElementById('audio-ui');
        const audioStatus = document.getElementById('audio-state-text');
        const btnEnableAudio = document.getElementById('btn-enable-audio');
        const videoContainer = document.getElementById('video-container'); 
        const videoIframe = document.getElementById('yt-iframe');

        function setVolume(val) { audioPlayer.volume = val; }
        function enableAudio() {
            audioPlayer.play().then(() => {
                btnEnableAudio.style.display = 'none';
                audioStatus.innerText = "üîä Audio bereit";
            }).catch(e => { console.log("Audio blockiert"); });
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            if(sb.classList.contains('open')) {
                sb.classList.remove('open'); ov.classList.remove('active');
            } else {
                sb.classList.add('open'); ov.classList.add('active');
            }
        }
        
        window.addEventListener('load', () => {
            if (window.innerWidth >= 768) { toggleSidebar(); }
        });

        socket.on('connect', () => { 
            socket.emit('player_announce', username); 
            const storedCode = localStorage.getItem(STORAGE_KEY); 
            if (storedCode) setTimeout(() => socket.emit('player_login', { name: username, code: storedCode }), 100); 
        });

        socket.on('audio_sync_command', (cmd) => {
            if (!audioPlayer.src) return;
            if (cmd.action === 'play') {
                audioPlayer.play().then(() => {
                    audioStatus.innerText = "‚ñ∂Ô∏è Spielt ab...";
                    btnEnableAudio.style.display = 'none'; 
                }).catch(error => {
                    btnEnableAudio.style.display = 'block';
                    audioStatus.innerText = "üîá Blockiert (Klicken!)";
                });
                if (Math.abs(audioPlayer.currentTime - cmd.currentTime) > 0.5) audioPlayer.currentTime = cmd.currentTime;
            } 
            else if (cmd.action === 'pause') { audioPlayer.pause(); audioStatus.innerText = "‚è∏Ô∏è Pausiert"; }
            else if (cmd.action === 'seek') { audioPlayer.currentTime = cmd.currentTime; }
        });

        function submitLogin() { const code = document.getElementById('player-code').value; socket.emit('player_login', { name: username, code: code }); }
        socket.on('player_login_success', () => { document.getElementById('login-overlay').style.display = 'none'; const inputCode = document.getElementById('player-code').value; if (inputCode) localStorage.setItem(STORAGE_KEY, inputCode); });
        socket.on('player_login_fail', (msg) => { document.getElementById('login-msg').innerText = msg || "Falscher Code"; localStorage.removeItem(STORAGE_KEY); document.getElementById('login-overlay').style.display = 'flex'; });
        
        // --- HAUPT GAME LOOP ---
        socket.on('update_game_state', (data) => {
            if (localGameId && localGameId !== data.gameId) { localStorage.removeItem(STORAGE_KEY); localGameId = data.gameId; document.getElementById('login-overlay').style.display = 'flex'; document.getElementById('player-code').value = ''; document.getElementById('login-msg').innerText = "Neues Spiel gestartet!"; socket.emit('player_announce', username); return; }
            localGameId = data.gameId;
            
            // Timer sync
            roundStartTime = data.round.startTime;
            roundEndTime = data.round.endTime;

            renderSidebar(data.players); 
            currentHistory = data.history || []; 
            document.getElementById('round-display').innerText = `Runde ${data.roundNumber}`;
            
            const round = data.round; 
            const me = data.players[username];

            if (!me && document.getElementById('login-overlay').style.display === 'none') { socket.emit('player_announce', username); return; }
            if (document.getElementById('login-overlay').style.display !== 'none') return;
            
            // ELIMINATED CHECK
            if (me && me.lives <= 0) {
                hideAllModes();
                document.getElementById('eliminated-screen').classList.add('visible');
                document.getElementById('spectator-screen').classList.remove('visible');
                document.getElementById('locked-screen').classList.remove('visible');
                document.getElementById('status-progress').style.display = 'none'; 
                
                if (round.revealed) { 
                    document.getElementById('eliminated-screen').classList.remove('visible'); 
                    switchMode('RESULTS', round, data.players); 
                }
                return;
            } else {
                document.getElementById('eliminated-screen').classList.remove('visible');
            }

            // SPECTATOR CHECK
            const isSpectator = round.targetPlayers && round.targetPlayers.length > 0 && !round.targetPlayers.includes(username);
            if (isSpectator && !round.revealed) { 
                hideAllModes(); 
                document.getElementById('spectator-screen').classList.add('visible'); 
                document.getElementById('locked-screen').classList.remove('visible'); 
                document.getElementById('status-progress').style.display = 'none'; 
                return; 
            } else { 
                document.getElementById('spectator-screen').classList.remove('visible'); 
            }

            updateStatusBar(round, data.players, me);

            // TEXT VISIBILITY CHECK
            if (round.textRevealed) {
                document.getElementById('display-question').innerText = round.question || "Pause";
            } else {
                document.getElementById('display-question').innerText = "???";
            }

            // REVEAL LOGIC UPDATE
            const hasIndividualReveals = round.revealedAnswers && round.revealedAnswers.length > 0;
            
            if (round.revealed || hasIndividualReveals) { 
                document.getElementById('locked-screen').classList.remove('visible'); 
                switchMode('RESULTS', round, data.players); 
                return; 
            }
            if (!round.answeringOpen && round.type !== 'WAITING' && round.type !== 'VIDEO_STREAM' && round.type !== 'INFO') { 
                document.getElementById('locked-screen').classList.add('visible'); 
                return; 
            } else { 
                document.getElementById('locked-screen').classList.remove('visible'); 
            }
            
            const currentSignature = round.type + "::" + round.question + "::" + JSON.stringify(round.options || []) + "::" + (round.imageData ? "IMG" : "NOIMG") + "::" + (round.audioData ? "AUDIO" : "NOAUDIO") + "::" + (round.videoData || "NOVIDEO") + "::" + round.answerCount + "::" + round.imageRevealed + "::" + round.textRevealed;
            if (currentSignature !== lastRoundSignature) { 
                lastRoundSignature = currentSignature; 
                switchMode(round.type, round, data.players); 
            } else { 
                if (round.type === 'PLAYER_VOTE') renderPlayerCards(data.players); 
            }

            if (round.isInputBlocked && !round.revealed) {
                document.querySelectorAll('.mode-container').forEach(el => el.classList.remove('active'));
                document.getElementById('input-blocked-msg').style.display = 'block';
            } else {
                document.getElementById('input-blocked-msg').style.display = 'none';
                 if (!round.isInputBlocked) {
                     const activeModeId = 'mode-' + round.type.toLowerCase();
                     const el = document.getElementById(activeModeId);
                     if(el) el.classList.add('active');
                 }
            }
        });

        // --- TIMER LOGIC ---
        setInterval(() => {
            const display = document.getElementById('timer-display');
            if (!display) return;
            
            if (roundStartTime) {
                let diff = 0;
                if (roundEndTime) {
                    diff = roundEndTime - roundStartTime;
                    display.style.color = '#ef4444'; 
                } else {
                    diff = Date.now() - roundStartTime;
                    display.style.color = '#22c55e';
                }
                
                if (diff < 0) diff = 0;
                const seconds = Math.floor((diff / 1000) % 60);
                const minutes = Math.floor((diff / (1000 * 60)) % 60);
                display.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                display.innerText = "00:00";
                display.style.color = '#6b7280';
            }
        }, 100);

        function updateStatusBar(round, allPlayers, me) {
            const statusBar = document.getElementById('status-progress');
            
            if (round.type === 'WAITING' || round.revealed || round.type === 'OFFLINE_RESULTS' || round.type === 'VIDEO_STREAM' || round.type === 'INFO') {
                statusBar.style.display = 'none';
                return;
            }

            let participatingPlayers = Object.entries(allPlayers).filter(([name, p]) => p.lives > 0);
            
            if (round.targetPlayers && round.targetPlayers.length > 0) {
                participatingPlayers = participatingPlayers.filter(([name, p]) => round.targetPlayers.includes(name));
            }
            
            const totalCount = participatingPlayers.length;
            const answeredCount = participatingPlayers.filter(([name, p]) => p.hasAnswered).length;

            statusBar.style.display = 'block';
            
            if (me && me.hasAnswered) {
                statusBar.classList.add('done');
                statusBar.innerHTML = `‚úÖ ${answeredCount} / ${totalCount} abgegeben`;
                if(statusBar.innerText !== `‚úÖ ${answeredCount} / ${totalCount} abgegeben`) {
                    statusBar.style.transform = "translateX(-50%) scale(1.05)";
                    setTimeout(() => statusBar.style.transform = "translateX(-50%) scale(1)", 100);
                }
            } else {
                statusBar.classList.remove('done');
                statusBar.innerHTML = `‚è≥ ${answeredCount} / ${totalCount} abgegeben`;
            }
        }

        function renderSidebar(players) {
            const list = document.getElementById('sidebar-list'); list.innerHTML = '';
            for (const [name, p] of Object.entries(players)) { 
                const li = document.createElement('li'); 
                if (p.lives <= 0) li.classList.add('eliminated');
                li.className = p.lives <= 0 ? 'p-item eliminated' : 'p-item';
                let hearts = "";
                if(p.lives <= 0) hearts = "‚ùå"; else { for(let i=0; i<p.lives; i++) hearts += "‚ù§Ô∏è "; }
                li.innerHTML = `
                    <div class="p-name">${name}</div>
                    <div class="p-status">
                        <span class="answered-icon ${p.hasAnswered ? 'visible' : ''}"></span>
                        <span style="font-size:0.8rem;">${hearts}</span>
                    </div>`; 
                list.appendChild(li); 
            }
        }

        function hideAllModes() { document.querySelectorAll('.mode-container').forEach(el => el.classList.remove('active')); }
        
        function switchMode(type, roundData, allPlayers) {
            hideAllModes(); 
            // Question text update moved to main loop to handle toggle state
            
            const audioDiv = document.getElementById('audio-container');
            if (roundData.audioData) {
                audioUI.style.display = 'block';
                const currentSrc = audioPlayer.getAttribute('data-src');
                if (currentSrc !== roundData.audioData) {
                    audioPlayer.src = roundData.audioData;
                    audioPlayer.setAttribute('data-src', roundData.audioData);
                    audioPlayer.load();
                    audioStatus.innerText = "‚è≥ Audio geladen.";
                }
            } else {
                audioUI.style.display = 'none'; audioPlayer.pause(); audioPlayer.src = ""; audioPlayer.removeAttribute('data-src');
            }

            const imageDiv = document.getElementById('image-container');
            if (roundData.imageData) {
                imageDiv.style.display = 'block';
                // CHECK IMAGE REVEALED
                if (roundData.imageRevealed) {
                    imageDiv.innerHTML = `<img src="${roundData.imageData}" alt="Frage Bild">`;
                } else {
                    imageDiv.innerHTML = `<div class="image-hidden-placeholder">üëÅÔ∏è Bild verborgen (Warte auf GM)</div>`;
                }
            } else { imageDiv.style.display = 'none'; imageDiv.innerHTML = ''; }
            
            // --- VIDEO STREAM ---
            if (roundData.videoData) {
                videoContainer.style.display = 'block';
                const ytUrl = `https://www.youtube.com/embed/${roundData.videoData}?autoplay=1&mute=0&controls=1`;
                if(videoIframe.src !== ytUrl) {
                    videoIframe.src = ytUrl;
                }
            } else {
                videoContainer.style.display = 'none';
                videoIframe.src = "";
            }
            
            if (type === 'OFFLINE_RESULTS') {
                if (roundData.revealed) { document.getElementById('mode-results').classList.add('active'); renderResultsTable(allPlayers, roundData); } 
                else { document.getElementById('mode-offline').classList.add('active'); return; }
            } else if (type === 'VIDEO_STREAM') {
                document.getElementById('mode-stream').classList.add('active');
            } else if (type === 'INFO') { // NEW
                document.getElementById('mode-info').classList.add('active');
            } else if (type === 'RESULTS') {
                document.getElementById('mode-results').classList.add('active');
                renderResultsTable(allPlayers, roundData);
            } else if (type === 'MC') {
                document.getElementById('mode-mc').classList.add('active'); const cont = document.getElementById('mc-container'); cont.innerHTML = '';
                const colors = ['#e11d48', '#d97706', '#16a34a', '#2563eb', '#7c3aed']; 
                roundData.options.forEach((opt, i) => { const btn = document.createElement('button'); btn.className = 'btn-mc'; btn.innerText = opt; btn.style.background = colors[i % colors.length]; btn.onclick = () => sendAnswer(opt); cont.appendChild(btn); });
            } else if (type === 'SEQUENCE') { document.getElementById('mode-sequence').classList.add('active'); renderSequence(roundData.options);
            } else if (type === 'ESTIMATE') { document.getElementById('mode-estimate').classList.add('active'); initEstimate(roundData.min, roundData.max);
            } else if (type === 'MATCHING') { document.getElementById('mode-matching').classList.add('active'); renderMatchingInterface(roundData.pairs, roundData.shuffledRight);
            } else if (type === 'TEXT') { document.getElementById('mode-text').classList.add('active'); document.getElementById('text-answer').value = ''; 
            } else if (type === 'LIST') { // NEW
                document.getElementById('mode-list').classList.add('active');
                renderListInputs(roundData.answerCount);
            } else if (type === 'PLAYER_VOTE') { document.getElementById('mode-vote').classList.add('active'); renderPlayerCards(allPlayers); }
        }

        function renderResultsTable(allPlayers, roundData) {
            const solDiv = document.getElementById('correct-answer-display');
            const cont = document.getElementById('results-container'); 
            const title = document.getElementById('result-title');
            cont.innerHTML = '';

            // --- SPECIAL HANDLING: PLAYER_VOTE ---
            if (roundData.type === 'PLAYER_VOTE') {
                solDiv.innerHTML = ''; 
                title.innerText = "VOTING ERGEBNIS";
                
                const votes = {};
                let maxVotes = 0;
                
                for (const [voterName, p] of Object.entries(allPlayers)) {
                    if (p.hasAnswered && p.answer) {
                        const target = p.answer;
                        if (!votes[target]) votes[target] = 0;
                        let weight = 1;
                        if (roundData.powerVoter && Array.isArray(roundData.powerVoter) && roundData.powerVoter.includes(voterName)) {
                            weight = 2;
                        }
                        votes[target] += weight;
                        if (votes[target] > maxVotes) maxVotes = votes[target];
                    }
                }

                const sortedVotes = Object.entries(votes).sort((a,b) => b[1] - a[1]);

                if (sortedVotes.length === 0) {
                    cont.innerHTML = '<div style="text-align:center; color:#888;">Niemand hat gew√§hlt.</div>';
                    return;
                }

                sortedVotes.forEach(([name, count]) => {
                    const isLeader = count === maxVotes;
                    const borderStyle = isLeader ? 'border: 2px solid #ef4444;' : 'border: 1px solid #333;';
                    const bgStyle = isLeader ? 'background: rgba(239, 68, 68, 0.15);' : 'background: var(--card-color);';
                    const textStyle = isLeader ? 'color: #fca5a5;' : 'color: white;';
                    const icon = isLeader ? 'üíÄ ' : '';
                    
                    const el = document.createElement('div');
                    el.className = 'result-card';
                    el.style.cssText = `${bgStyle} ${borderStyle} display:flex; justify-content:space-between; align-items:center; padding:15px; border-radius:10px; border-left:none;`; 
                    
                    el.innerHTML = `
                        <div style="font-size:1.1rem; font-weight:bold; ${textStyle}">${icon}${name}</div>
                        <div style="font-size:1.2rem; font-weight:bold; ${textStyle}">${count} Stimmen</div>
                    `;
                    cont.appendChild(el);
                });
                return;
            }

            // --- STANDARD RESULTS ---
            title.innerText = "ANTWORTEN DER SPIELER";
            if (roundData.correctAnswer) {
                let txt = formatAnswer(roundData.correctAnswer);
                solDiv.innerHTML = `<div class="correct-answer-card"><strong>üèÜ L√ñSUNG</strong><br><span style="font-size:1.2rem;">${txt}</span></div>`;
            } else solDiv.innerHTML = '';
            
            // SORTIERUNG EINBAUEN: LIFO (wie im GM)
            let playerList = Object.entries(allPlayers).map(([name, p]) => ({name, ...p}));
            
            playerList.sort((a, b) => {
                const revealed = roundData.revealedAnswers || [];
                const idxA = revealed.indexOf(a.name);
                const idxB = revealed.indexOf(b.name);
                
                // Beide sind aufgedeckt -> Der mit dem h√∂heren Index (sp√§ter aufgedeckt) kommt nach oben
                if (idxA !== -1 && idxB !== -1) return idxB - idxA;
                
                // Nur A ist aufgedeckt -> A nach oben
                if (idxA !== -1) return -1;
                // Nur B ist aufgedeckt -> B nach oben
                if (idxB !== -1) return 1;
                
                return 0; // Beide nicht aufgedeckt
            });

            for(const p of playerList) {
                if(p.answer) {
                    let ans = formatAnswer(p.answer); let extras = "";
                    if(roundData.type === 'ESTIMATE' && roundData.correctAnswer) { const diff = Math.abs(Number(p.answer) - Number(roundData.correctAnswer)); extras = `<span style="color:var(--danger-color); font-weight:bold;"> (Diff: ${diff})</span>`; }
                    cont.innerHTML += `<div class="result-card"><div class="res-name">${p.name}</div><div class="res-val">${ans} ${extras}</div></div>`;
                }
            }
        }

        function formatAnswer(val) {
            if (val === null || val === undefined) return '-';
            if (Array.isArray(val)) {
                // Check if it's a list answer (no arrows)
                const isList = val.some(item => typeof item === 'string' && item.includes(' ')); // Heuristic, or simply render as list
                return `<ul style="margin:0; padding-left:20px; text-align:left;">${val.map(v => `<li>${v}</li>`).join('')}</ul>`;
            }
            if (typeof val === 'object') { let s = ''; for(const [k,v] of Object.entries(val)) s += `${k} ‚ûù ${v}\n`; return s; }
            return val;
        }

        function renderMatchingInterface(pairs, shuffledRight) {
            const container = document.getElementById('matching-container'); container.innerHTML = '';
            const rightValues = shuffledRight || pairs.map(p => p.right).sort(() => Math.random() - 0.5);
            pairs.forEach(pair => {
                const row = document.createElement('div'); row.className = 'match-row';
                let optionsHTML = '<option value="" disabled selected>-- W√§hlen --</option>';
                rightValues.forEach(val => optionsHTML += `<option value="${val}">${val}</option>`);
                row.innerHTML = `<div class="match-label" data-left="${pair.left}" style="font-weight:bold;">${pair.left}</div><select class="match-select">${optionsHTML}</select>`;
                container.appendChild(row);
            });
        }

        function renderListInputs(count) {
            const container = document.getElementById('list-inputs-container');
            container.innerHTML = '';
            for(let i=0; i<count; i++) {
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.className = 'list-input';
                inp.placeholder = `Antwort ${i+1}...`;
                container.appendChild(inp);
            }
        }

        function renderSequence(items) {
            const container = document.getElementById('sequence-container');
            let currentItems = [...items]; 
            const renderList = () => {
                container.innerHTML = '';
                currentItems.forEach((item, index) => {
                    const row = document.createElement('div'); row.className = 'seq-item';
                    const upDisabled = index === 0 ? 'disabled' : '';
                    const downDisabled = index === currentItems.length - 1 ? 'disabled' : '';
                    const opacityUp = index === 0 ? 0.3 : 1;
                    const opacityDown = index === currentItems.length - 1 ? 0.3 : 1;
                    row.innerHTML = `<span>${item}</span><div class="seq-controls" style="display:flex; gap:5px;"><button class="btn-move" style="opacity:${opacityUp}" onclick="moveSeq(${index}, -1)" ${upDisabled}>‚ñ≤</button><button class="btn-move" style="opacity:${opacityDown}" onclick="moveSeq(${index}, 1)" ${downDisabled}>‚ñº</button></div>`;
                    container.appendChild(row);
                });
            };
            window.moveSeq = (idx, dir) => { const temp = currentItems[idx]; currentItems[idx] = currentItems[idx + dir]; currentItems[idx + dir] = temp; renderList(); };
            window.getSequenceData = () => currentItems;
            renderList();
        }

        function initEstimate(min, max) { const inp = document.getElementById('est-val'); const sli = document.getElementById('est-slide'); inp.min = min; inp.max = max; inp.value = ''; sli.min = min; sli.max = max; sli.value = min; window.syncEst = (val) => { inp.value = val; }; inp.oninput = () => { sli.value = inp.value; }; }

        function renderPlayerCards(players) {
            const container = document.getElementById('vote-player-list');
            
            // --- FIX START: STATE PERSISTENCE ---
            // Wir merken uns, welche Karten offen sind (Klasse 'show' auf .vote-history)
            const currentlyOpen = new Set();
            document.querySelectorAll('.vote-card').forEach(card => {
                const nameEl = card.querySelector('.vote-name');
                const historyEl = card.querySelector('.vote-history');
                if (nameEl && historyEl && historyEl.classList.contains('show')) {
                    currentlyOpen.add(nameEl.innerText.trim());
                }
            });
            // --- FIX END ---

            container.innerHTML = '';
            let count = 0;
            for (const name in players) {
                if(name === username) continue;
                if(players[name].lives <= 0) continue; 
                count++;
                let historyHTML = '';
                if (!currentHistory || currentHistory.length === 0) {
                    historyHTML = '<div class="history-item" style="color:#666">Keine Fragen bisher in dieser Runde.</div>';
                } else {
                    currentHistory.forEach((roundData, index) => {
                        let ans = formatAnswer(roundData.answers[name]);
                        historyHTML += `<div class="history-item" style="margin-bottom:5px; border-bottom:1px solid #333; padding-bottom:5px;"><span class="h-q" style="display:block; color:#888; font-size:0.8rem;">${index+1}. ${roundData.question}</span><span class="h-a" style="color:var(--accent-color);">${ans}</span></div>`;
                    });
                }
                
                // --- FIX START: RESTORE STATE ---
                const isOpen = currentlyOpen.has(name);
                const historyClass = isOpen ? 'vote-history show' : 'vote-history';
                const btnBg = isOpen ? 'background:#555' : 'background:#333';
                // --- FIX END ---

                const card = document.createElement('div'); card.className = 'vote-card';
                card.innerHTML = `<div class="vote-card-header"><div class="vote-name">${name}</div><div style="display:flex;"><button class="btn-inspect" onclick="toggleHistory(this)" style="${btnBg}">‚ÑπÔ∏è</button><button class="btn-vote-action" onclick="sendAnswer('${name}')">W√ÑHLEN</button></div></div><div class="${historyClass}">${historyHTML}</div>`;
                container.appendChild(card);
            }
            if(count === 0) {
                container.innerHTML = `<div style="text-align:center; color:#666; padding:20px;">Warte auf andere Spieler...<br>(Oder du bist der Einzige, der noch lebt)</div>`;
            }
        }
        
        window.toggleHistory = function(btn) { const h = btn.parentElement.parentElement.nextElementSibling; if (h.classList.contains('show')) { h.classList.remove('show'); btn.style.background="#333"; } else { h.classList.add('show'); btn.style.background="#555"; } };
        function sendAnswer(val) { socket.emit('submit_answer', { user: username, answer: val }); }
        function sendText() { const val = document.getElementById('text-answer').value; if(val.trim()) sendAnswer(val); }
        function sendEstimate() { const val = document.getElementById('est-val').value; if(val!=='') sendAnswer(Number(val)); }
        function sendSequence() { socket.emit('submit_answer', { user: username, answer: window.getSequenceData() }); }
        function sendList() { 
            const inputs = document.querySelectorAll('.list-input');
            const vals = [];
            let allFilled = true;
            inputs.forEach(i => { if(i.value.trim()) vals.push(i.value.trim()); else allFilled = false; });
            if(!allFilled) { if(!confirm("Nicht alle Felder ausgef√ºllt. Trotzdem senden?")) return; }
            sendAnswer(vals);
        }
        function sendMatching() {
            const result = {}; let complete = true;
            document.querySelectorAll('.match-row').forEach(row => { const l = row.querySelector('.match-label').getAttribute('data-left'); const r = row.querySelector('.match-select').value; if(!r) complete = false; result[l] = r; });
            if(!complete) alert("Bitte alles zuordnen"); else sendAnswer(result);
        }
        socket.on('answer_confirmed', () => { /* Optional: Sound abspielen */ });
    </script>
</body>
</html>
