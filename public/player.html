<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voting Pad</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #222; color: white; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 140px; background: #333; border-right: 1px solid #444; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0;}
        .sidebar h3 { font-size: 0.9rem; padding: 15px; margin: 0; background: #444; text-align: center; color: #aaa; text-transform: uppercase; letter-spacing: 1px;}
        .p-item { padding: 10px; border-bottom: 1px solid #444; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .p-name { font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px;}
        .answered-icon { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; display: none; }
        .answered-icon.visible { display: block; }
        
        .main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; position: relative; overflow-y: auto; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .code-input { font-size: 2rem; padding: 10px; text-align: center; width: 120px; border-radius: 10px; border: none; margin-bottom: 20px; letter-spacing: 5px;}
        .btn-submit { background: #3498db; color: white; padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }

        .q-header { margin-bottom: 20px; text-align: center; }
        .round-indicator { color: #888; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; }
        .q-text { font-size: 1.2rem; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; display: inline-block; min-width: 50%; }

        .mode-container { display: none; height: 100%; flex-direction: column; }
        .mode-container.active { display: flex; }

        /* SEQUENCE STYLE */
        .seq-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .seq-item { background: #333; padding: 10px; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #555; }
        .seq-controls { display: flex; gap: 5px; }
        .btn-move { background: #555; border: none; color: white; width: 30px; height: 30px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* ESTIMATE STYLE */
        .est-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 30px; }
        .est-input { font-size: 3rem; width: 200px; text-align: center; background: #333; color: white; border: 2px solid #555; border-radius: 10px; padding: 10px; }
        .est-range { width: 100%; max-width: 300px; }
        
        .mc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex: 1; margin-bottom: 20px; align-content: center; }
        .btn-mc { border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; color: white; cursor: pointer; padding: 20px; background: #444; min-height: 80px; word-wrap: break-word;}
        .btn-mc:active { transform: scale(0.95); background: #666; }
        
        .matching-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .match-row { background: #333; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; }
        .match-label { font-weight: bold; color: #ddd; }
        .match-select { padding: 10px; font-size: 1.1rem; border-radius: 5px; border: 1px solid #555; background: #222; color: white; }

        .text-input-wrapper { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        textarea { width: 100%; height: 100px; padding: 15px; font-size: 1.2rem; border-radius: 10px; border: none; font-family: sans-serif; resize: none; box-sizing: border-box;}
        
        .results-list { overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .result-card { background: #444; padding: 15px; border-radius: 8px; }
        .res-name { font-weight: bold; color: #aaa; font-size: 0.9rem; margin-bottom: 5px;}
        .res-val { font-size: 1.1rem; font-weight: bold; color: white; white-space: pre-wrap;}

        .vote-list { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding-bottom: 20px;}
        .vote-card { background: #333; border-radius: 8px; overflow: hidden; border: 1px solid #444; }
        .vote-card-header { display: flex; justify-content: space-between; align-items: stretch; height: 50px; }
        .vote-name { flex: 1; display: flex; align-items: center; padding-left: 15px; font-weight: bold; font-size: 1.1rem; }
        .btn-inspect { background: #444; border: none; border-left: 1px solid #555; color: #aaa; padding: 0 15px; cursor: pointer; font-size: 0.9rem;}
        .btn-vote-action { background: #e74c3c; border: none; color: white; padding: 0 20px; font-weight: bold; cursor: pointer; }
        .vote-history { background: #222; padding: 10px; display: none; border-top: 1px solid #444; }
        .vote-history.show { display: block; }
        .history-item { margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* STATUS BAR (STATT FULLSCREEN OVERLAY) */
        #status-toast { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: #2ecc71; color: white; padding: 10px 20px; border-radius: 20px; 
            font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; z-index: 100;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: translateX(-50%) scale(0.5); opacity:0; } to { transform: translateX(-50%) scale(1); opacity:1;} }

        /* LOCKED OVERLAY (Wenn Voting geschlossen) */
        #locked-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 90; display: none; 
            justify-content: center; align-items: center; flex-direction: column; text-align: center;
        }
        #locked-screen.visible { display: flex; }

        #spectator-screen { text-align: center; padding: 40px; display: none; }
        #spectator-screen.visible { display: block; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <h2>Hallo <span id="welcome-name"></span></h2>
        <input type="tel" maxlength="4" class="code-input" id="player-code" placeholder="----">
        <button class="btn-submit" onclick="submitLogin()">GO</button>
        <p id="login-msg" style="color: #e74c3c; margin-top: 10px;"></p>
    </div>

    <div class="sidebar">
        <h3>Leben</h3>
        <ul class="p-list" id="sidebar-list"></ul>
    </div>

    <div class="main-area">
        <div class="q-header">
            <div class="round-indicator" id="round-display">Runde 1</div>
            <div class="q-text" id="display-question">Warte...</div>
        </div>

        <!-- STATUS TOAST (Statt Fullscreen Wait) -->
        <div id="status-toast">‚úÖ Antwort gesendet</div>

        <!-- LOCKED SCREEN (Voting zu) -->
        <div id="locked-screen">
            <div style="font-size:3rem;">üîí</div>
            <h3>Voting beendet</h3>
            <p>Warte auf Aufl√∂sung...</p>
        </div>

        <div id="spectator-screen">
            <h2 style="color:#aaa;">Nur Zuschauer</h2>
            <p>Du nimmst an diesem Stechen nicht teil.</p>
        </div>

        <!-- MODES -->
        <div id="mode-results" class="mode-container">
            <h3 style="text-align:center; margin-top:0; color:#f39c12;">Aufl√∂sung:</h3>
            <div class="results-list" id="results-container"></div>
        </div>

        <div id="mode-mc" class="mode-container">
            <div class="mc-grid" id="mc-container"></div>
        </div>

        <div id="mode-matching" class="mode-container">
            <div class="matching-list" id="matching-container"></div>
            <button class="btn-submit" style="margin-top:20px;" onclick="sendMatching()">Absenden</button>
        </div>

        <div id="mode-sequence" class="mode-container">
            <div class="seq-list" id="sequence-container"></div>
            <button class="btn-submit" onclick="sendSequence()">Reihenfolge Best√§tigen</button>
        </div>

        <div id="mode-estimate" class="mode-container">
            <div class="est-wrapper">
                <input type="number" id="est-val" class="est-input">
                <input type="range" id="est-slide" class="est-range" oninput="syncEst(this.value)">
            </div>
            <button class="btn-submit" style="margin-top:30px; align-self: center;" onclick="sendEstimate()">Sch√§tzen</button>
        </div>

        <div id="mode-text" class="mode-container">
            <div class="text-input-wrapper">
                <textarea id="text-answer" placeholder="Deine Antwort..."></textarea>
                <button class="btn-submit" onclick="sendText()">Absenden</button>
            </div>
        </div>

        <div id="mode-vote" class="mode-container">
            <p style="text-align:center; color:#aaa; margin-top:0;">Verlauf pr√ºfen & jemanden w√§hlen:</p>
            <div class="vote-list" id="vote-player-list"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const rawName = window.location.pathname.split('/').pop();
        const username = decodeURIComponent(rawName);
        document.getElementById('welcome-name').innerText = username;
        
        let lastRoundSignature = '';
        let currentHistory = [];

        socket.on('connect', () => { socket.emit('player_announce', username); });
        function submitLogin() {
            socket.emit('player_login', { name: username, code: document.getElementById('player-code').value });
        }
        socket.on('player_login_success', () => document.getElementById('login-overlay').style.display = 'none');
        socket.on('player_login_fail', () => document.getElementById('login-msg').innerText = "Falscher Code!";);

        socket.on('update_game_state', (data) => {
            renderSidebar(data.players);
            currentHistory = data.history || [];
            document.getElementById('round-display').innerText = `Runde ${currentHistory.length + 1}`;

            const round = data.round;
            const me = data.players[username];

            // 1. ZUSCHAUER CHECK
            const isSpectator = round.targetPlayers && round.targetPlayers.length > 0 && !round.targetPlayers.includes(username);
            
            if (isSpectator && !round.revealed) {
                hideAllModes();
                document.getElementById('spectator-screen').classList.add('visible');
                document.getElementById('locked-screen').classList.remove('visible');
                return;
            } else {
                document.getElementById('spectator-screen').classList.remove('visible');
            }

            // 2. ERGEBNISSE
            if (round.revealed) {
                document.getElementById('locked-screen').classList.remove('visible');
                document.getElementById('status-toast').style.display = 'none';
                switchMode('RESULTS', round, data.players);
                return;
            }

            // 3. VOTING GESCHLOSSEN (Aber noch nicht revealed)
            if (!round.answeringOpen && round.type !== 'WAITING') {
                document.getElementById('locked-screen').classList.add('visible');
                document.getElementById('status-toast').style.display = 'none';
                return; // UI bleibt im Hintergrund, aber Overlay ist dr√ºber
            } else {
                document.getElementById('locked-screen').classList.remove('visible');
            }

            // 4. NORMALER SPIELZUSTAND (Voting offen)
            if (me && me.hasAnswered) {
                document.getElementById('status-toast').style.display = 'block';
                // WICHTIG: Wir lassen die Eingabemasken aktiv, damit man korrigieren kann!
            } else {
                document.getElementById('status-toast').style.display = 'none';
            }

            // Init der Frage (nur wenn neu)
            const currentSignature = round.type + "::" + round.question + "::" + JSON.stringify(round.options || []);
            if (currentSignature !== lastRoundSignature) {
                lastRoundSignature = currentSignature;
                switchMode(round.type, round, data.players);
            } else {
                if (round.type === 'PLAYER_VOTE') renderPlayerCards(data.players);
            }
        });

        function renderSidebar(players) {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';
            for (const [name, p] of Object.entries(players)) {
                if(!p.connected) continue;
                const li = document.createElement('li');
                li.className = 'p-item';
                li.innerHTML = `<div class="p-name">${name}</div><div class="p-status"><span class="answered-icon ${p.hasAnswered ? 'visible' : ''}"></span><span style="color:#e74c3c">‚ù§Ô∏è</span> ${p.lives}</div>`;
                list.appendChild(li);
            }
        }

        function hideAllModes() {
            document.querySelectorAll('.mode-container').forEach(el => el.classList.remove('active'));
        }

        function switchMode(type, roundData, allPlayers) {
            hideAllModes();
            document.getElementById('display-question').innerText = roundData.question || "Pause";

            if (type === 'RESULTS') {
                document.getElementById('mode-results').classList.add('active');
                renderResults(allPlayers);
            } 
            else if (type === 'MC') {
                document.getElementById('mode-mc').classList.add('active');
                renderMCButtons(roundData.options);
            } 
            else if (type === 'SEQUENCE') {
                document.getElementById('mode-sequence').classList.add('active');
                renderSequence(roundData.options);
            }
            else if (type === 'ESTIMATE') {
                document.getElementById('mode-estimate').classList.add('active');
                initEstimate(roundData.min, roundData.max);
            }
            else if (type === 'MATCHING') {
                document.getElementById('mode-matching').classList.add('active');
                renderMatchingInterface(roundData.pairs);
            }
            else if (type === 'TEXT') {
                document.getElementById('mode-text').classList.add('active');
                document.getElementById('text-answer').value = ''; 
            } 
            else if (type === 'PLAYER_VOTE') {
                document.getElementById('mode-vote').classList.add('active');
                renderPlayerCards(allPlayers);
            }
        }

        // --- RENDER LOGIK ---
        function renderMCButtons(options) {
            const container = document.getElementById('mc-container');
            container.innerHTML = '';
            const colors = ['#e74c3c', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#e67e22'];
            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn-mc';
                btn.innerText = opt;
                btn.style.background = colors[index % colors.length];
                if(index % colors.length === 1) btn.style.color = '#222';
                btn.onclick = () => sendAnswer(opt);
                container.appendChild(btn);
            });
        }

        function renderMatchingInterface(pairs) {
            const container = document.getElementById('matching-container');
            container.innerHTML = '';
            const rightValues = pairs.map(p => p.right).sort(() => Math.random() - 0.5);
            pairs.forEach(pair => {
                const row = document.createElement('div');
                row.className = 'match-row';
                let optionsHTML = '<option value="" disabled selected>-- W√§hlen --</option>';
                rightValues.forEach(val => optionsHTML += `<option value="${val}">${val}</option>`);
                row.innerHTML = `<div class="match-label" data-left="${pair.left}">${pair.left}</div><select class="match-select">${optionsHTML}</select>`;
                container.appendChild(row);
            });
        }

        function renderSequence(items) {
            const container = document.getElementById('sequence-container');
            let currentItems = [...items].sort(() => Math.random() - 0.5);
            const renderList = () => {
                container.innerHTML = '';
                currentItems.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'seq-item';
                    row.innerHTML = `<span>${item}</span><div class="seq-controls">${index > 0 ? `<button class="btn-move" onclick="moveSeq(${index}, -1)">‚ñ≤</button>` : ''}${index < currentItems.length-1 ? `<button class="btn-move" onclick="moveSeq(${index}, 1)">‚ñº</button>` : ''}</div>`;
                    container.appendChild(row);
                });
            };
            window.moveSeq = (idx, dir) => {
                const temp = currentItems[idx];
                currentItems[idx] = currentItems[idx + dir];
                currentItems[idx + dir] = temp;
                renderList();
            };
            window.getSequenceData = () => currentItems;
            renderList();
        }

        function sendSequence() { socket.emit('submit_answer', { user: username, answer: window.getSequenceData() }); }

        function initEstimate(min, max) {
            const inp = document.getElementById('est-val');
            const sli = document.getElementById('est-slide');
            inp.min = min; inp.max = max; inp.value = '';
            sli.min = min; sli.max = max; sli.value = min;
            window.syncEst = (val) => { inp.value = val; };
            inp.oninput = () => { sli.value = inp.value; };
        }
        function sendEstimate() {
            const val = document.getElementById('est-val').value;
            if(val === '') return;
            socket.emit('submit_answer', { user: username, answer: Number(val) });
        }

        function renderResults(players) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';
            for (const [name, p] of Object.entries(players)) {
                if (p.answer !== null) {
                    let displayAnswer = p.answer;
                    if (typeof p.answer === 'object' && !Array.isArray(p.answer)) {
                        displayAnswer = '';
                        for(const [k, v] of Object.entries(p.answer)) displayAnswer += `${k} ‚ûù ${v}\n`;
                    }
                    else if (Array.isArray(p.answer)) {
                         displayAnswer = p.answer.map((x,i) => `${i+1}. ${x}`).join('\n');
                    }
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `<div class="res-name">${name}</div><div class="res-val">${displayAnswer}</div>`;
                    container.appendChild(card);
                }
            }
        }

        function renderPlayerCards(players) {
            const container = document.getElementById('vote-player-list');
            container.innerHTML = ''; 
            for (const name in players) {
                if(name === username) continue;
                let historyHTML = '';
                if (currentHistory.length === 0) historyHTML = '<div class="history-item" style="color:#666">Leer.</div>';
                else {
                    currentHistory.forEach((roundData, index) => {
                        let ans = roundData.answers[name] || '-';
                        if(typeof ans === 'object') ans = "(Komplex)";
                        historyHTML += `<div class="history-item"><span style="color:#888;">${index+1}. ${roundData.question}</span><br><span style="color:#3498db;">${ans}</span></div>`;
                    });
                }
                const card = document.createElement('div');
                card.className = 'vote-card';
                card.innerHTML = `<div class="vote-card-header"><div class="vote-name">${name}</div><button class="btn-inspect" onclick="toggleHistory(this)">üëÅÔ∏è</button><button class="btn-vote-action" onclick="sendAnswer('${name}')">VOTE</button></div><div class="vote-history">${historyHTML}</div>`;
                container.appendChild(card);
            }
        }

        window.toggleHistory = function(btn) {
            const h = btn.parentElement.nextElementSibling;
            if (h.classList.contains('show')) { h.classList.remove('show'); btn.style.background="#444"; } 
            else { h.classList.add('show'); btn.style.background="#555"; }
        };

        function sendAnswer(val) { socket.emit('submit_answer', { user: username, answer: val }); }
        
        function sendText() {
            const txt = document.getElementById('text-answer').value;
            if(txt.trim()) sendAnswer(txt);
        }

        function sendMatching() {
            const result = {};
            let complete = true;
            document.querySelectorAll('.match-row').forEach(row => {
                const left = row.querySelector('.match-label').getAttribute('data-left');
                const right = row.querySelector('.match-select').value;
                if(!right) complete = false;
                result[left] = right;
            });
            if(!complete) { alert("Alles zuordnen!"); return; }
            socket.emit('submit_answer', { user: username, answer: result });
        }

        // Event Feedback
        socket.on('answer_confirmed', () => {
            // Zeige Toast kurz an
            const toast = document.getElementById('status-toast');
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        });
    </script>
</body>
</html>
